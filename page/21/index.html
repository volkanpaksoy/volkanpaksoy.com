<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/21/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3V7V2XX9Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y3V7V2XX9Q');
</script>

<!-- <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'G-Y3V7V2XX9Q']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script> -->



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="volkanpaksoy" data-color="#005050" data-emoji="" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>

<div id="ezoic-pub-ad-placeholder-102">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <!-- vp.com - default -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/11/13/playing-with-tfl-api-with-csharp-xamarin-and-swift/" itemprop="url">Playing with TFL API with C#, Xamarin and Swift</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-11-13T11:00:00+00:00" itemprop="datePublished">November 13, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">csharp, ios, swift, wpf, xamarin, tfl_api</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>Recently I discovered that Transport for London (TFL) has some great APIs that I can play around with some familiar data. It’s very to use as an API key is not even mandatory. My main goal here is to discover what I can do with this data and build a few user interfaces consuming it. All source code is available on <a href="https://github.com/volkanpaksoy/tube-status-fetcher" target="_blank" rel="noopener noreferrer">GitHub</a></p>

<h2 id="tube-status">Tube status</h2>
<p>The <a href="https://api.tfl.gov.uk/line/mode/tube/status?detail=true" target="_blank" rel="noopener noreferrer">API endpoint</a> I will use returns the current status of tube lines, an array of the following JSON objects:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tfl.Api.Presentation.Entities.Line, Tfl.Api.Presentation.Entities"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"central"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Central"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"modeName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tube"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-10-14T10:31:00.39"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"modified"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2015-10-14T10:31:00.39"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"lineStatuses"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tfl.Api.Presentation.Entities.LineStatus, Tfl.Api.Presentation.Entities"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
            </span><span class="nl">"statusSeverity"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
            </span><span class="nl">"statusSeverityDescription"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Good Service"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"created"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0001-01-01T00:00:00"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"validityPeriods"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"routeSections"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
    </span><span class="nl">"serviceTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tfl.Api.Presentation.Entities.LineServiceTypeInfo, Tfl.Api.Presentation.Entities"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Regular"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"uri"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/Line/Route?ids=Central&amp;serviceTypes=Regular"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<h2 id="visualizing-the-data---line-colours">Visualizing the data - line colours</h2>
<p>TFL have standard colours for tube lines which are documented <a href="http://content.tfl.gov.uk/tfl-colour-standard.pdf" target="_blank" rel="noopener noreferrer">here</a>. So I created a small lookup json using that reference:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"bakerloo"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">58</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nl">"K"</span><span class="p">:</span><span class="w"> </span><span class="mi">33</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">137</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">78</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">36</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"central"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">220</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">36</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"circle"</span><span class="p">,</span><span class="w">  </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">255</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">206</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"district"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"C"</span><span class="p">:</span><span class="w">  </span><span class="mi">95</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nl">"K"</span><span class="p">:</span><span class="w"> </span><span class="mi">27</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">114</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">41</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hammersmith-city"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">45</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">215</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">153</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">175</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"jubilee"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"K"</span><span class="p">:</span><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">134</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">143</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">152</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"metropolitan"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nl">"K"</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">86</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"northern"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"K"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"piccadilly"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">88</span><span class="p">,</span><span class="w"> </span><span class="nl">"K"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">168</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"victoria"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="nl">"M"</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">160</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">226</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"waterloo-city"</span><span class="p">,</span><span class="w"> </span><span class="nl">"CMYK"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nl">"C"</span><span class="p">:</span><span class="w"> </span><span class="mi">47</span><span class="p">,</span><span class="w"> </span><span class="nl">"Y"</span><span class="p">:</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nl">"RGB"</span><span class="p">:</span><span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="nl">"R"</span><span class="p">:</span><span class="w"> </span><span class="mi">118</span><span class="p">,</span><span class="w"> </span><span class="nl">"G"</span><span class="p">:</span><span class="w"> </span><span class="mi">208</span><span class="p">,</span><span class="w"> </span><span class="nl">"B"</span><span class="p">:</span><span class="w"> </span><span class="mi">189</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>I was hoping to map status values to colours as well (i.e. “Severe delays” to red) but there is no official guide to that. The status codes and values can be retrieved from this endpoint: <a href="https://api.tfl.gov.uk/line/meta/severity" target="_blank" rel="noopener noreferrer">https://api.tfl.gov.uk/line/meta/severity</a> which returns a collection of objects like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"$type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tfl.Api.Presentation.Entities.StatusSeverity, Tfl.Api.Presentation.Entities"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"modeName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tube"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Suspended"</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>I simplified it for my purposes (just the values for tube):</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Special Service"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Closed"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Suspended"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Part Suspended"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Planned Closure"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Part Closure"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Severe Delays"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Reduced Service"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Bus Service"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Minor Delays"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Good Service"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Part Closed"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Exist Only"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"No Step Free Access"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Change of frequency"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Diverted"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Not Running"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">17</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Issues Reported"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"No Issues"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">19</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Information"</span><span class="w"> </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w"> </span><span class="nl">"severityLevel"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Service Closed"</span><span class="w"> </span><span class="p">},</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>I will keep it around but in this initial version I won’t use it as description is returned with the status query anyway. But it was still a useful exercise to figure out there is no “official” colour for status values. After all what’s the colour of “No Step Free Access” or “Exist Only”? There is a also reason field that explains the effects of any delays etc. which should ne displayed along with the severity especially when there are some disruptions in the service.</p>

<p>‘Nuff said about the data! Let’s start building something with it!</p>

<h2 id="core-library">Core library</h2>
<p>As I will build several API call to retrieve tube status is encapsulated in the core library which basically has sends the HTTP request, parses the JSON and returns the <em>LineInfo</em> list:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Fetcher</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_apiEndPoint</span> <span class="p">=</span> <span class="s">"https://api.tfl.gov.uk/line/mode/tube/status?detail=true"</span><span class="p">;</span>

    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">LineInfo</span><span class="p">&gt;</span> <span class="nf">GetTubeInfo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RestClient</span><span class="p">(</span><span class="n">_apiEndPoint</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">RestRequest</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">Method</span><span class="p">.</span><span class="n">GET</span><span class="p">);</span>
        <span class="n">request</span><span class="p">.</span><span class="nf">AddHeader</span><span class="p">(</span><span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="p">(</span><span class="n">RestResponse</span><span class="p">)</span><span class="n">client</span><span class="p">.</span><span class="nf">Execute</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">content</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">tflResponse</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="n">TflLineInfo</span><span class="p">&gt;&gt;(</span><span class="n">content</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">lineInfoList</span> <span class="p">=</span> <span class="n">tflResponse</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
            <span class="k">new</span> <span class="nf">LineInfo</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">Id</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">Name</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">Reason</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">lineStatuses</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">reason</span><span class="p">,</span>
                <span class="n">StatusSeverityDescription</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">lineStatuses</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">statusSeverityDescription</span><span class="p">,</span>
                <span class="n">StatusSeverity</span> <span class="p">=</span> <span class="n">t</span><span class="p">.</span><span class="n">lineStatuses</span><span class="p">[</span><span class="m">0</span><span class="p">].</span><span class="n">statusSeverity</span>
            <span class="p">}).</span><span class="nf">ToList</span><span class="p">();</span>

        <span class="k">return</span> <span class="n">lineInfoList</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>LineInfo class contains the current status with the description. It also contains the colour defined by TFL for that tube line:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">LineInfo</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Id</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">StatusSeverity</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">StatusSeverityDescription</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">Reason</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="n">RGB</span> <span class="n">LineColour</span>
    <span class="p">{</span>
        <span class="k">get</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="n">TubeColourHelper</span><span class="p">.</span><span class="nf">GetRGBColour</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">Id</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As the line colours aren’t returned by the service I have to populate it by a helper class:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TubeColourHelper</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">RGB</span><span class="p">&gt;</span> <span class="n">_tubeColorRGBDictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">RGB</span><span class="p">&gt;();</span>

    <span class="k">static</span> <span class="nf">TubeColourHelper</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_tubeColorRGBDictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">RGB</span><span class="p">&gt;();</span>

        <span class="kt">string</span> <span class="n">json</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllText</span><span class="p">(</span><span class="s">"./data/colours.json"</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">tubeColors</span> <span class="p">=</span> <span class="n">JArray</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">tubeColor</span> <span class="k">in</span> <span class="n">tubeColors</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_tubeColorRGBDictionary</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">tubeColor</span><span class="p">[</span><span class="s">"id"</span><span class="p">].</span><span class="n">Value</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(),</span> <span class="k">new</span> <span class="nf">RGB</span><span class="p">(</span>
                <span class="n">tubeColor</span><span class="p">[</span><span class="s">"RGB"</span><span class="p">][</span><span class="s">"R"</span><span class="p">]?.</span><span class="n">Value</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;()</span> <span class="p">??</span> <span class="m">0</span><span class="p">,</span>
                <span class="n">tubeColor</span><span class="p">[</span><span class="s">"RGB"</span><span class="p">][</span><span class="s">"G"</span><span class="p">]?.</span><span class="n">Value</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;()</span> <span class="p">??</span> <span class="m">0</span><span class="p">,</span>
                <span class="n">tubeColor</span><span class="p">[</span><span class="s">"RGB"</span><span class="p">][</span><span class="s">"B"</span><span class="p">]?.</span><span class="n">Value</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;()</span> <span class="p">??</span> <span class="m">0</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">static</span> <span class="n">RGB</span> <span class="nf">GetRGBColour</span><span class="p">(</span><span class="kt">string</span> <span class="n">lineId</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(!</span><span class="n">_tubeColorRGBDictionary</span><span class="p">.</span><span class="nf">ContainsKey</span><span class="p">(</span><span class="n">lineId</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">$"Colour for line [</span><span class="p">{</span><span class="n">lineId</span><span class="p">}</span><span class="s">] could not be found in RGB colour map"</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">_tubeColorRGBDictionary</span><span class="p">[</span><span class="n">lineId</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The static constructor runs only the first time it is accessed, reads the <em>colours.json</em> and populates the dictionary. From then on it’s just a lookup in memory.</p>

<h2 id="first-client-c-console-application-on-windows">First client: C# Console Application on Windows</h2>
<p>Time to develop our first client and see some actual results. As it’s generally the case with console applications this one is pretty simple and hassle-free. I decided to start with that one just to see the core library is working as expected.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">fetcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Fetcher</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">viewer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ConsoleViewer</span><span class="p">();</span>

        <span class="kt">bool</span> <span class="n">exit</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>

        <span class="n">viewer</span><span class="p">.</span><span class="nf">DisplayTubeStatus</span><span class="p">(</span><span class="n">fetcher</span><span class="p">.</span><span class="nf">GetTubeInfo</span><span class="p">());</span>

        <span class="k">do</span>
        <span class="p">{</span>
            <span class="n">ConsoleKeyInfo</span> <span class="n">key</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">Key</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">case</span> <span class="n">ConsoleKey</span><span class="p">.</span><span class="n">F5</span><span class="p">:</span>
                    <span class="n">viewer</span><span class="p">.</span><span class="nf">DisplayTubeStatus</span><span class="p">(</span><span class="n">fetcher</span><span class="p">.</span><span class="nf">GetTubeInfo</span><span class="p">());</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="n">ConsoleKey</span><span class="p">.</span><span class="n">Q</span><span class="p">:</span>
                    <span class="n">exit</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="k">default</span><span class="p">:</span>
                    <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Unknown command"</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">while</span> <span class="p">(!</span><span class="n">exit</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Displays the results when it’s first run. You can refresh by pressing F5 or quit by pressing Q. The output looks like this:</p>

<p><img src="/images/vpblogimg/2015/11/playing-with-tfl-api-console-output.png" alt=""></p>

<p>The problem with console application is that I wasn’t able to use RGB values directly as the console only supports an enumeration called <em>ConsoleColor</em>.</p>

<h2 id="second-client-wpf-application-on-windows">Second client: WPF Application on Windows</h2>
<p>Now let’s look at a more <em>graphical</em> UI, a WPF client:</p>

<p><img src="/images/vpblogimg/2015/11/playing-with-tfl-api-wpf-output.png" alt=""></p>

<p>Same idea, display the results upon first run then call the service again on Refresh button’s click event.</p>

<h2 id="third-client-ios-app-with-xamarin">Third client: iOS App with Xamarin</h2>
<p>I’ve recently subscribed to Xamarin and one of the main reasons for starting this project was to see it in action. What I was mostly curious about was if I could use my C# libraries using NuGet packages on an iOS application developed with Xamarin. This would allow me build apps significantly faster.</p>

<p>It didn’t work out of the box because I used C# 6.0 and .NET Framework 4.5.2 on the Windows side but it wasn’t available on the Mac.</p>

<p><img src="/images/vpblogimg/2015/11/playing-with-tfl-api-xamarin-framework-selection.png" alt=""></p>

<p>But wasn’t too hard to change the framework and make some small modifications to make it work. Good news is that it supports NuGet and most common libraries have Mono support including RestSharp and Newtonsoft.Json which I used in this project</p>

<p><img src="/images/vpblogimg/2015/11/playing-with-tfl-api-xamarin-add-nuget-packages.png" alt=""></p>

<p>I had to remove and add them but finally they worked fine so I didn’t have to change anything in the code.</p>

<p><img src="/images/vpblogimg/2015/11/playing-with-tfl-api-xamarin-output.png" alt=""></p>

<p>I won’t go into implementation details as there’s not much change. The app has one table view controller and it calls the core library to get the results and assigns them to the table’s data source. It’s a relief that I could have the same functionality as Windows with just minor changes.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ViewDidLoad</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">base</span><span class="p">.</span><span class="nf">ViewDidLoad</span><span class="p">();</span>

    <span class="kt">var</span> <span class="n">fetcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Fetcher</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">lineInfoList</span> <span class="p">=</span> <span class="n">fetcher</span><span class="p">.</span><span class="nf">GetTubeInfo</span><span class="p">();</span>
    <span class="n">TableView</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TubeStatusTableViewControllerSource</span><span class="p">(</span><span class="n">lineInfoList</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">());</span>
    <span class="n">TableView</span><span class="p">.</span><span class="nf">ReloadData</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Anyway, more on Xamarin later after I cover the Swift version.</p>

<h2 id="fourth-client-ios-app-with-swift">Fourth client: iOS App with Swift</h2>
<p>Last but not least, here comes Swift client built with XCode. Naturally this one cannot use the core library that the first 3 clients shared (which is good because I was looking for a chance to practice handling HTTP requests and parsinng JSON with Swift anyway).</p>

<p>I didn’t use any external libraries so the implementation is a bit long but mainly it sends the request using NSURLSession and  NSSessionDataTask.</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">func</span> <span class="nf">getTubeStatus</span><span class="p">(</span><span class="nv">completionHandler</span><span class="p">:</span> <span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="p">[</span><span class="kt">LineInfo</span><span class="p">]?,</span> <span class="nv">error</span><span class="p">:</span> <span class="kt">NSError</span><span class="p">?)</span> <span class="o">-&gt;</span> <span class="kt">Void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s">"detail"</span> <span class="p">:</span> <span class="s">"true"</span><span class="p">]</span>
    <span class="k">let</span> <span class="nv">mutableMethod</span> <span class="p">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="kt">Methods</span><span class="o">.</span><span class="kt">TubeStatus</span>
    
    <span class="nf">taskForGETMethod</span><span class="p">(</span><span class="n">mutableMethod</span><span class="p">,</span> <span class="nv">parameters</span><span class="p">:</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span> <span class="kt">JSONResult</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        <span class="k">if</span> <span class="k">let</span> <span class="nv">error</span> <span class="o">=</span> <span class="n">error</span> <span class="p">{</span>
            <span class="nf">completionHandler</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="kc">nil</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="k">let</span> <span class="nv">results</span> <span class="o">=</span> <span class="kt">JSONResult</span> <span class="k">as?</span> <span class="p">[</span><span class="kt">AnyObject</span><span class="p">]</span> <span class="p">{</span>
                <span class="k">let</span> <span class="nv">lineStatus</span> <span class="o">=</span> <span class="kt">LineInfo</span><span class="o">.</span><span class="nf">lineStatusFromResults</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                <span class="nf">completionHandler</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="n">lineStatus</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
            <span class="p">}</span>
       <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then constructs the LineInfo objects by calling the static <em>lineStatusFromResults</em> method:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">static</span> <span class="kd">func</span> <span class="nf">lineStatusFromResults</span><span class="p">(</span><span class="nv">results</span><span class="p">:</span> <span class="p">[</span><span class="kt">AnyObject</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="kt">LineInfo</span><span class="p">]</span> <span class="p">{</span>
    <span class="k">var</span> <span class="nv">lineStatus</span> <span class="o">=</span> <span class="p">[</span><span class="kt">LineInfo</span><span class="p">]()</span>
    <span class="k">for</span> <span class="n">result</span> <span class="k">in</span> <span class="n">results</span> <span class="p">{</span>
        <span class="n">lineStatus</span><span class="o">.</span><span class="nf">append</span><span class="p">(</span><span class="kt">LineInfo</span><span class="p">(</span><span class="nv">status</span><span class="p">:</span> <span class="n">result</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="n">lineStatus</span>
<span class="p">}</span>
</code></pre></div></div>

<p>which creates a new LineInfo and adds to resultset:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">init</span><span class="p">(</span><span class="nv">status</span><span class="p">:</span> <span class="kt">AnyObject</span><span class="p">)</span> <span class="p">{</span>

    <span class="kt">Id</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s">"id"</span><span class="p">]</span> <span class="k">as!</span> <span class="kt">String</span>
    <span class="kt">Name</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span> <span class="k">as!</span> <span class="kt">String</span>
    <span class="kt">StatusSeverity</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s">"lineStatuses"</span><span class="p">]</span><span class="o">!!</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!</span><span class="p">[</span><span class="s">"statusSeverity"</span><span class="p">]</span> <span class="k">as!</span> <span class="kt">Int</span>
    <span class="kt">StatusSeverityDescription</span> <span class="o">=</span> <span class="n">status</span><span class="p">[</span><span class="s">"lineStatuses"</span><span class="p">]</span><span class="o">!!</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!</span><span class="p">[</span><span class="s">"statusSeverityDescription"</span><span class="p">]</span> <span class="k">as!</span> <span class="kt">String</span>
    <span class="kt">LineColour</span> <span class="o">=</span> <span class="kt">RGB</span><span class="p">(</span><span class="kt">R</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">G</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="kt">B</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>JSON parsing is a bit nasy because of unwrapping the optionals. I’ll look into SwiftyJSON later on which is a popular JSON library for Swift.</p>

<p>Finally the controller displays the results:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">viewWillAppear</span><span class="p">(</span><span class="nv">animated</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="o">.</span><span class="nf">viewWillAppear</span><span class="p">(</span><span class="n">animated</span><span class="p">)</span>
    
    <span class="kt">TFLClient</span><span class="o">.</span><span class="nf">sharedInstance</span><span class="p">()</span><span class="o">.</span><span class="n">getTubeStatus</span> <span class="p">{</span> <span class="n">lineStatus</span><span class="p">,</span> <span class="n">error</span> <span class="k">in</span>
        
        <span class="k">if</span> <span class="k">let</span> <span class="nv">lineStatus</span> <span class="o">=</span> <span class="n">lineStatus</span> <span class="p">{</span>
            <span class="k">self</span><span class="o">.</span><span class="n">lineInfoList</span> <span class="o">=</span> <span class="n">lineStatus</span>
            <span class="nf">dispatch_async</span><span class="p">(</span><span class="nf">dispatch_get_main_queue</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">self</span><span class="o">.</span><span class="n">tableView</span><span class="o">!.</span><span class="nf">reloadData</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">print</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And the custom cells are created when data is loaded and the text and colours are set:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">cellForRowAtIndexPath</span> <span class="nv">indexPath</span><span class="p">:</span> <span class="kt">NSIndexPath</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">UITableViewCell</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">cell</span> <span class="o">=</span> <span class="n">tableView</span><span class="o">.</span><span class="nf">dequeueReusableCellWithIdentifier</span><span class="p">(</span><span class="s">"TubeInfoCell"</span><span class="p">,</span> <span class="nv">forIndexPath</span><span class="p">:</span> <span class="n">indexPath</span><span class="p">)</span> <span class="k">as!</span> <span class="kt">TubeInfoTableViewCell</span>
    <span class="k">let</span> <span class="nv">lineStatus</span> <span class="o">=</span> <span class="n">lineInfoList</span><span class="p">[</span><span class="n">indexPath</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>
    
    <span class="n">cell</span><span class="o">.</span><span class="n">backgroundColor</span> <span class="o">=</span> <span class="n">colourHelper</span><span class="o">.</span><span class="nf">getTubeColor</span><span class="p">(</span><span class="n">lineStatus</span><span class="o">.</span><span class="kt">Id</span><span class="p">)</span>
    
    <span class="n">cell</span><span class="o">.</span><span class="n">lineName</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">lineStatus</span><span class="o">.</span><span class="kt">Name</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">lineName</span><span class="p">?</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="o">.</span><span class="nf">whiteColor</span><span class="p">()</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">severityDescription</span><span class="p">?</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">lineStatus</span><span class="o">.</span><span class="kt">StatusSeverityDescription</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">severityDescription</span><span class="p">?</span><span class="o">.</span><span class="n">textColor</span> <span class="o">=</span> <span class="kt">UIColor</span><span class="o">.</span><span class="nf">whiteColor</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">cell</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And here’s the output:</p>

<p><img src="/images/vpblogimg/2015/11/playing-with-tfl-api-swift-output.png" alt=""></p>

<h2 id="xamarin-vs-swift">Xamarin vs Swift</h2>

<p>Here’s a quick overview and comparison of both platforms based on my (limited) experiences with this toy project:</p>

<ul>
  <li>XCode is much faster when building and deploying</li>
  <li>XamarinStudio doesn’t seem to be very intuitive at times. For examples the code snippets use Java-notation</li>
  <li>
    <p>The more I use Swift the more I like it and it doesn’t slow me down terribly. Once you get used to it the difference is syntax more or less. For example the following two methods do the same thing:</p>

    <p>Xamarin:</p>

    <div class="language-csharp highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="k">public</span> <span class="k">override</span> <span class="n">nint</span> <span class="nf">RowsInSection</span> <span class="p">(</span><span class="n">UITableView</span> <span class="n">tableview</span><span class="p">,</span> <span class="n">nint</span> <span class="n">section</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">return</span> <span class="n">lineInfoList</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre></div>    </div>

    <p>Swift:</p>

    <div class="language-swift highlighter-rouge">
<div class="highlight"><pre class="highlight"><code>  <span class="k">override</span> <span class="kd">func</span> <span class="nf">tableView</span><span class="p">(</span><span class="nv">tableView</span><span class="p">:</span> <span class="kt">UITableView</span><span class="p">,</span> <span class="n">numberOfRowsInSection</span> <span class="nv">section</span><span class="p">:</span> <span class="kt">Int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Int</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">lineInfoList</span><span class="o">.</span><span class="n">count</span>
      <span class="p">}</span>
</code></pre></div>    </div>

    <p>I can even argue I’d be more comfortable with the Swift version here as I have no idea what a “nint” is as it’s an input parameter in the Xamarin version.</p>
  </li>
  <li>The idea behind Xamarin subscription was to develop iOS apps quickly as I’m a seasoned C# developer and feel comfortable with it. But turns it, I can’t move as fast as I expected. With the Indie subscription you can only use Xamarin Studio. Enabling Visual Studio is only allowed with the business version which costs $1000/year. And Xamarin Studio is a brand new IDE for me so it definitely has a learning curve. Also I’m getting used to XCode now (besides the fact that it crashes hundred times a day on average!)</li>
</ul>

<h2 id="conclusion">Conclusion</h2>
<p>This was just a reconnaisance mission to explore the TFL API, iOS development with Xamarin and Swift. It was a fun exercise for me, I hope anyone who reads this can benefit from it too.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/tube-status-fetcher" target="_blank" rel="noopener noreferrer">TubeStatusFetcher source code</a></li>
  <li><a href="https://api-portal.tfl.gov.uk/docs" target="_blank" rel="noopener noreferrer">TFL API Docs</a></li>
  <li><a href="http://content.tfl.gov.uk/tfl-colour-standard.pdf" target="_blank" rel="noopener noreferrer">TFL Colour Standards</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/11/11/building-a-simple-http-server-with-nancy/" itemprop="url">Building a simple HTTP server with Nancy</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-11-11T11:30:00+00:00" itemprop="datePublished">November 11, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">csharp, nancy</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>Recently I needed to simulate HTTP responses from a 3rd party. I decided to use Nancy to quickly build a local web server that would handle my test requests and return the responses I wanted.</p>

<p>Here’s the definition of Nancy from their official website:</p>

<blockquote>
  <p>Nancy is a lightweight, low-ceremony, framework for building HTTP based services on .Net and Mono.</p>
</blockquote>

<p>It can handle DELETE, GET, HEAD, OPTIONS, POST, PUT and PATCH requests. It’s very easy to customize and extend as it’s module-based. In order to build our tiny web server we are going to need self-hosting package:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Package Nancy.Hosting.Self
</code></pre></div></div>

<p>This would automatically install Nancy as it depends on that package.</p>

<h2 id="self-hosting-in-action">Self-hosting in action</h2>

<p>The container application can be anything as long it keeps running one way or another. A background service would be ideal for this task. Since all I need is testing I just created a console application and added Console.ReadKey() statement to keep it “alive”</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="kt">string</span> <span class="n">_url</span> <span class="p">=</span> <span class="s">"http://localhost"</span><span class="p">;</span>
    <span class="k">private</span> <span class="kt">int</span> <span class="n">_port</span> <span class="p">=</span> <span class="m">12345</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">NancyHost</span> <span class="n">_nancy</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Program</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">uri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span> <span class="s">$"</span><span class="p">{</span><span class="n">_url</span><span class="p">}</span><span class="s">:</span><span class="p">{</span><span class="n">_port</span><span class="p">}</span><span class="s">/"</span><span class="p">);</span>
        <span class="n">_nancy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NancyHost</span><span class="p">(</span><span class="n">uri</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">_nancy</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Started listennig port </span><span class="p">{</span><span class="n">_port</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
        <span class="n">_nancy</span><span class="p">.</span><span class="nf">Stop</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Program</span><span class="p">();</span>
        <span class="n">p</span><span class="p">.</span><span class="nf">Start</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you try this code, it’s likely that you’ll have an error (AutomaticUrlReservationCreationFailureException)</p>

<p><img src="/images/vpblogimg/2015/11/self-hosting-with-nancy-AutomaticUrlReservationCreationFailureException.png" alt=""></p>

<p>saying:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>The Nancy self host was unable to start, as no namespace reservation existed for the provided url(s).

Please either enable UrlReservations.CreateAutomatically on the HostConfiguration provided to 
the NancyHost, or create the reservations manually with the (elevated) command(s):

netsh http add urlacl url="http://+:12345/" user="Everyone"
</code></pre></div></div>

<p>There are 3 ways to resolve this issue and two of which are already suggested in the error message:</p>

<ol>
  <li>
    <p>In an elevated command prompt (fancy way of saying run as administrator!), run</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> netsh http add urlacl url="http://+:12345/" user="Everyone"
</code></pre></div>    </div>

    <p>What add urlacl does is</p>

    <blockquote>
      <p>Reserves the specified URL for non-administrator users and accounts</p>
    </blockquote>

    <p>If you want to delete it later on you can use the following command</p>

    <div class="language-plaintext highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> netsh http delete urlacl url=http://+:12345/
</code></pre></div>    </div>
  </li>
</ol>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<ol>
  <li>
    <p>Specify a host configuration to NancyHost like this:</p>

    <div class="language-csharp highlighter-rouge">
<div class="highlight"><pre class="highlight"><code> <span class="kt">var</span> <span class="n">configuration</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HostConfiguration</span><span class="p">()</span>
 <span class="p">{</span>
     <span class="n">UrlReservations</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">UrlReservations</span><span class="p">()</span> <span class="p">{</span> <span class="n">CreateAutomatically</span> <span class="p">=</span> <span class="k">true</span> <span class="p">}</span>
 <span class="p">};</span>
	
 <span class="n">_nancy</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">NancyHost</span><span class="p">(</span><span class="n">configuration</span><span class="p">,</span> <span class="n">uri</span><span class="p">);</span>
</code></pre></div>    </div>

    <p>This essentially does the same thing and a UAC prompt pops up so it’s not that automatical!</p>
  </li>
  <li>
    <p>Run the Visual Studio (and the standalone application when deployed) as administrator</p>
  </li>
</ol>

<p>After applying either one of the 3 solutions, let’s run the application and try the address http://localhost:12345 in a browser and we get …</p>

<p><img src="/images/vpblogimg/2015/11/self-hosting-with-nancy-404.png" alt=""></p>

<p>Excellent! We are actually getting a response from the server even though it’s just a 404 error.</p>

<p>Now let’s add some functionality, otherwise it isn’t terribly useful.</p>

<h2 id="handling-requests">Handling requests</h2>
<p>Requests are handled by <em>modules</em>. Creating a module is as simple as creating a class deriving from <em>NancyModule</em>. Let’s create two handlers for the root, one for GET verbs and one for POST:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SimpleModule</span> <span class="p">:</span> <span class="n">Nancy</span><span class="p">.</span><span class="n">NancyModule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SimpleModule</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Get</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="s">"Received GET request"</span><span class="p">;</span>

        <span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="s">"Received POST request"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Nancy automatically discovers all modules so we don’t have to register them. If there are conflicting handlers the last one discovered overrides the previous ones. For example the following example would work fine and the second GET handler will be executed:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">SimpleModule</span> <span class="p">:</span> <span class="n">Nancy</span><span class="p">.</span><span class="n">NancyModule</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">SimpleModule</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Get</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="s">"Received GET request"</span><span class="p">;</span>

        <span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="s">"Received POST request"</span><span class="p">;</span>

        <span class="n">Get</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="s">"Let me have the request!"</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="working-with-input-data-request-parameters">Working with input data: Request parameters</h2>
<p>In the simple we used underscore to represent input as didn’t care but most of the time we would. In that case we can get the request parameters as a DynamicDictionary (a type that comes with Nancy). For example let’s create a route for <em>/user</em>:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">SimpleModule</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Get</span><span class="p">[</span><span class="s">"/user/{id}"</span><span class="p">]</span> <span class="p">=</span> <span class="n">parameters</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">parameters</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="p">==</span> <span class="m">666</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">$"All hail user #</span><span class="p">{</span><span class="n">parameters</span><span class="p">.</span><span class="n">id</span><span class="p">}</span><span class="s">! \\m/"</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="s">"Just a regular user!"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And send the GET request:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET http://localhost:12345/user/666 HTTP/1.1
User-Agent: Fiddler
Host: localhost:12345
Content-Length: 2
</code></pre></div></div>

<p>which would return the response:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Content-Type: text/html
Server: Microsoft-HTTPAPI/2.0
Date: Tue, 10 Nov 2015 11:40:08 GMT
Content-Length: 23

All hail user #666! \m/
</code></pre></div></div>

<h2 id="working-with-input-data-request-body">Working with input data: Request body</h2>
<p>Now let’s try to handle the data posted in the request body. Data posted in the body can be accessed though <strong>this.Request.Body</strong> property such as for the following request</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST http://localhost:12345/ HTTP/1.1
User-Agent: Fiddler
Host: localhost:12345
Content-Length: 55
Content-Type: application/json

{
    "username": "volkan",
    "isAdmin": "sure!"
}
</code></pre></div></div>

<p>this code would first convert the request stream to a string and deserialize it to a POCO:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">length</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">length</span><span class="p">];</span>
    <span class="n">id</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">body</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="n">JsonConvert</span><span class="p">.</span><span class="n">DeserializeObject</span><span class="p">&lt;</span><span class="n">SimpleRequest</span><span class="p">&gt;(</span><span class="n">body</span><span class="p">);</span>
    <span class="k">return</span> <span class="m">200</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>
<p>If the was posted from a form for example and sent in the following format in the body</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>username=volkan&amp;isAdmin=sure!
</code></pre></div></div>

<p>then we could simply convert it to a dictionary with a little bit of LINQ:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">parameters</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Body</span><span class="p">;</span>
    <span class="kt">long</span> <span class="n">length</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">length</span><span class="p">];</span>
    <span class="n">id</span><span class="p">.</span><span class="nf">Read</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">length</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">body</span> <span class="p">=</span> <span class="n">System</span><span class="p">.</span><span class="n">Text</span><span class="p">.</span><span class="n">Encoding</span><span class="p">.</span><span class="n">Default</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">p</span> <span class="p">=</span> <span class="n">body</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'&amp;'</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">s</span> <span class="p">=&gt;</span> <span class="n">s</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'='</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">ToDictionary</span><span class="p">(</span><span class="n">k</span> <span class="p">=&gt;</span> <span class="n">k</span><span class="p">.</span><span class="nf">ElementAt</span><span class="p">(</span><span class="m">0</span><span class="p">),</span> <span class="n">v</span> <span class="p">=&gt;</span> <span class="n">v</span><span class="p">.</span><span class="nf">ElementAt</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s">"username"</span><span class="p">]</span> <span class="p">==</span> <span class="s">"volkan"</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">"awesome!"</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="k">return</span> <span class="s">"meh!"</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>This is nice but it’s a lot of work to read the whole and manually deserialize it! Fortunately Nancy supports model binding. First we need to add the using statement as the <strong>Bind</strong> extension method lives in <em>Nancy.ModelBinding</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>using Nancy.ModelBinding;
</code></pre></div></div>

<p>Now we can simplify the code by the help of model binding:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Bind</span><span class="p">&lt;</span><span class="n">SimpleRequest</span><span class="p">&gt;();</span>
    <span class="k">return</span> <span class="n">request</span><span class="p">.</span><span class="n">username</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>The important thing to note is to send the data with the appropriate content type. For the form data example the request should be like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST http://localhost:12345/ HTTP/1.1
User-Agent: Fiddler
Host: localhost:12345
Content-Length: 29
Content-Type: application/x-www-form-urlencoded

username=volkan&amp;isAdmin=sure!
</code></pre></div></div>

<p>It also works for binding JSON to the same POCO.</p>

<h2 id="preparing-responses">Preparing responses</h2>
<p>Nancy is very flexible in terms of responses. As shown in the above examples you can return a string</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">"This is a valid response"</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>which would yield this HTTP message on the wire:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Content-Type: text/html
Server: Microsoft-HTTPAPI/2.0
Date: Tue, 10 Nov 2015 15:48:12 GMT
Content-Length: 20

This is a valid response
</code></pre></div></div>

<p>Response code is set to 200 - OK automatically and the text is sent in the response body.</p>

<p>We can just set the code and return a response with a simple one-liner:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="m">405</span><span class="p">;</span>
</code></pre></div></div>

<p>which would produce:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 405 Method Not Allowed
Content-Type: text/html
Server: Microsoft-HTTPAPI/2.0
Date: Tue, 10 Nov 2015 15:51:36 GMT
Content-Length: 0
</code></pre></div></div>

<p>To prepare more complex responses with headers and everything we can construct a new Response object like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">jsonString</span> <span class="p">=</span> <span class="s">"{ username: \"admin\", password: \"just kidding\" }"</span><span class="p">;</span>
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">jsonBytes</span> <span class="p">=</span> <span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetBytes</span><span class="p">(</span><span class="n">jsonString</span><span class="p">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">Response</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">StatusCode</span> <span class="p">=</span> <span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span>
        <span class="n">ContentType</span> <span class="p">=</span> <span class="s">"application/json"</span><span class="p">,</span>
        <span class="n">ReasonPhrase</span> <span class="p">=</span> <span class="s">"Because why not!"</span><span class="p">,</span>
        <span class="n">Headers</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;()</span>
        <span class="p">{</span>
            <span class="p">{</span> <span class="s">"Content-Type"</span><span class="p">,</span> <span class="s">"application/json"</span> <span class="p">},</span>
            <span class="p">{</span> <span class="s">"X-Custom-Header"</span><span class="p">,</span> <span class="s">"Sup?"</span> <span class="p">}</span>
        <span class="p">},</span>
        <span class="n">Contents</span> <span class="p">=</span> <span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="nf">Write</span><span class="p">(</span><span class="n">jsonBytes</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">jsonBytes</span><span class="p">.</span><span class="n">Length</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">};</span>
</code></pre></div></div>

<p>and we would get this at the other end of the line:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 Because why not!
Content-Type: application/json
Server: Microsoft-HTTPAPI/2.0
X-Custom-Header: Sup?
Date: Tue, 10 Nov 2015 16:09:19 GMT
Content-Length: 47

{ username: "admin", password: "just kidding" }
</code></pre></div></div>

<p>Response also comes with a lot of useful methods like AsJson, AsXml and AsRedirect. For example we could simplify returning a JSON response like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Post</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">_</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">.</span><span class="n">AsJson</span><span class="p">&lt;</span><span class="n">SimpleResponse</span><span class="p">&gt;(</span>
        <span class="k">new</span> <span class="nf">SimpleResponse</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Status</span> <span class="p">=</span> <span class="s">"A-OK!"</span><span class="p">,</span> <span class="n">ErrorCode</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">Description</span> <span class="p">=</span> <span class="s">"All systems are go!"</span>
        <span class="p">});</span>
<span class="p">};</span>
</code></pre></div></div>

<p>and the result would contain the appropriate header and status code:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8
Server: Microsoft-HTTPAPI/2.0
Date: Tue, 10 Nov 2015 16:19:18 GMT
Content-Length: 68

{"status":"A-OK!","errorCode":1,"description":"All systems are go!"}
</code></pre></div></div>

<p>One extension I like is the AsRedirect method. The following example would return Google search results for a given parameter:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get</span><span class="p">[</span><span class="s">"/search"</span><span class="p">]</span> <span class="p">=</span> <span class="n">parameters</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Query</span><span class="p">[</span><span class="s">"q"</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">.</span><span class="nf">AsRedirect</span><span class="p">(</span><span class="s">$"http://www.google.com/search?q=</span><span class="p">{</span><span class="n">s</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="https">HTTPS</h2>
<p>What if we needed to support HTTPS for our tests for some reason? Fear not, Nancy covers that too. By default, if we just try to use HTTPS by changing the protocol we would get this exception:</p>

<blockquote>
  <p>The connection to ‘localhost’ failed. 
System.Security.SecurityException Failed to negotiate HTTPS connection with server.fiddler.network.https HTTPS handshake to localhost (for #2) failed. System.IO.IOException Unable to read data from the transport connection: An existing connection was forcibly closed by the remote host.</p>
</blockquote>

<p>The solution is to add create a self-signed certificate and add it using netsh http add command. Here’s the step-by-step process:</p>

<ol>
  <li>Create a self-signed certificate: Open a Visual Studio command prompt and enter the following command:</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>makecert nancy.cer
</code></pre></div></div>

<p>You can provide more properties so that it would look with a name that makes sense. Here’s an MSD page to</p>

<ol>
  <li>Run mmc and add Certificates snap-in. Make sure to select <strong>Computer Account</strong>.</li>
</ol>

<p><img src="/images/vpblogimg/2015/11/self-hosting-with-nancy-cert-account.png" alt=""></p>

<p>I selected <em>My User Account</em> at first and it gave the following error:</p>

<blockquote>
  <p>SSL Certificate add failed, Error: 1312 A specified logon session does not exist. It may already have been terminated.</p>
</blockquote>

<p>In that case the solution is just to drag and drop the certificate to the computer account as shown below:</p>

<p><img src="/images/vpblogimg/2015/11/self-hosting-with-nancy-cert-store.png" alt=""></p>

<ol>
  <li>
    <p>Right-click on Certificates (Local Computer) -&gt; Personal -&gt; Certificates and select All tasks -&gt; Import and browse to nancy.cer file created in Step 1</p>
  </li>
  <li>
    <p>Double-click on the certificate, switch to Details tab and scroll to the bottom and copy the Thumbprint value (and remove the spaces after copied it)</p>
  </li>
</ol>

<p><img src="/images/vpblogimg/2015/11/self-hosting-with-nancy-cert-thumbnail.png" alt=""></p>

<ol>
  <li>Now enter the following commands. The first one is the same as before, just with HTTPS as protocol. The second command add the certificate we’ve just created.</li>
</ol>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netsh http add urlacl url=https://+:12345/ user="Everyone"

netsh http add sslcert ipport=0.0.0.0:1234 ccerthash=653a1c60d4daaae00b2a103f242eac965ca21bec appid={A0DEC7A4-CF28-42FD-9B85-AFFDDD4FDD0F} clientcertnegotiation=enable
</code></pre></div></div>

<p>Here appid can be any GUID.</p>

<p>Let’s take it out for a test drive:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Get</span><span class="p">[</span><span class="s">"/"</span><span class="p">]</span> <span class="p">=</span> <span class="n">parameters</span> <span class="p">=&gt;</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="s">"Response over HTTPS! Weeee!"</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<p>This request</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET https://localhost:12345 HTTP/1.1
Host: localhost:12345


</code></pre></div></div>

<p>returns this response</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>HTTP/1.1 200 OK
Content-Type: text/html
Server: Microsoft-HTTPAPI/2.0
Date: Wed, 11 Nov 2015 10:24:58 GMT
Content-Length: 27

Response over HTTPS! Weeee!
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>There are a few alternatives when you need a small web server to test something locally. Nancy is one of them. It’s easy to configure, use and it’s lightweight. Apparently you can even <a href="https://github.com/NancyFx/Nancy/wiki/Running-Nancy-on-your-Raspberry-Pi" target="_blank" rel="noopener noreferrer">host in on a Raspberry Pi!</a></p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://nancyfx.org/" target="_blank" rel="noopener noreferrer">Official Nancy site</a></li>
  <li><a href="https://github.com/NancyFx" target="_blank" rel="noopener noreferrer">GitHub repository</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/cc307223(v=vs.85).aspx" target="_blank" rel="noopener noreferrer">Windows Dev Centre reference for add urlacl</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/bfsktky3(v=vs.110).aspx" target="_blank" rel="noopener noreferrer">MSDN Reference for Makecert</a></li>
  <li><a href="https://github.com/NancyFx/Nancy/wiki/Accessing-the-client-certificate-when-using-SSL" target="_blank" rel="noopener noreferrer">Accessing the client certificate when using SSL</a></li>
  <li><a href="https://coderead.wordpress.com/2014/08/07/enabling-ssl-for-self-hosted-nancy/" target="_blank" rel="noopener noreferrer">Blogpost: Enabling SSL for Self-Hosted Nancy</a></li>
  <li><a href="https://github.com/NancyFx/Nancy/wiki/Running-Nancy-on-your-Raspberry-Pi" target="_blank" rel="noopener noreferrer">Running Nancy on your Raspberry Pi</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/10/22/ip-checker-with-mef/" itemprop="url">Building Plugin-Based Applications with Managed Extensibility Framework (MEF)</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-10-22T12:30:00+01:00" itemprop="datePublished">October 22, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devdesign">dev</a></span> -->

<!-- dev, design -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/design">design</a>
    
</span>
	<span class="tags">csharp, mef, managed_extensibility_framework, plugin</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I will try to cover some of the basic concepts and features of MEF over a working example. In the future I’ll post more articles demonstraint MEF usage with more complex applications.</p>

<h3 id="background">Background</h3>
<p>Many successful and popular applications, such as Visual Studio, Eclipse, Sublime Text, support a plug-in model. Adopting a plugin-based model, whenever possible, has quite a few advantages:</p>

<ul>
  <li>Helps to keep the core lightweight instead of cramming all features into the same code-base.</li>
  <li>Helps to make the application more robust: New functionality can be added without changing any existing code.</li>
  <li>Helps to make development easier as different modules can be developed by different people simultaneously</li>
  <li>Allows plugin development without distributing the main the source code</li>
</ul>

<p>Extensibility is based on composition and it is very helpful to build SOLID compliant applications as it adopts <em>Open/closed</em> and <em>Dependency Inversion</em> principles.</p>

<p>MEF is part of .NET framework as of version 4.0 and it lives inside <em>System.ComponentModel.Composition</em> namespace. This is also the standard extension model that has been used in Visual Studio. It is not meant to replace Invesion of Control (IoC) frameworks. It is rather meant to simplify building extensible applications using dependency injection based on component composition.</p>

<h3 id="some-terminology">Some terminology</h3>
<p>Before diving into the sample, let’s look at some MEF terminology and core terms:</p>

<ul>
  <li>
    <p><strong>Part:</strong> Basic elements in MEF are called <strong>parts</strong>. Parts can provide services to other parts (<em>exporting</em>) and can consume other parts’ services (<em>importing</em>).</p>
  </li>
  <li>
    <p><strong>Container:</strong> This is the part that performs the composition. Most common one is <em>CompositionContainer</em> class.</p>
  </li>
  <li>
    <p><strong>Catalog:</strong> In order to discover the parts, containers use <em>catalogs</em>. There are various catelogs suplied by MEF such as</p>

    <ul>
      <li>AssemblyCatalog: Discovers attributed parts in a managed code assembly.</li>
      <li>DirectoryCatalog: Discovers attributed parts in the assemblies in a specified directory.</li>
      <li>AggregateCatalog: A catalog that combines the elements of ComposablePartCatalog objects.</li>
      <li>ApplicationCatalog: Discovers attributed parts in the dynamic link library (DLL) and EXE files in an application’s directory and path</li>
    </ul>
  </li>
  <li>
    <p><strong>Export / import:</strong> The way the plugins make themselves discoverable is by exporting their implementation of a <em>contract</em>. A contract is simply a common interface that the application and the plugins understand so they can speak the same language so to speak.</p>
  </li>
</ul>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<h3 id="sample-project">Sample Project</h3>
<p>As I learn best by playing around, I decided to start with a simple project. I’ve recently published a sample project for Strategy design pattern which I blogged <a href="https://volkanpaksoy.com/archive/2015/10/12/design-patterns-strategy">here</a>. In this post I will use the same project and convert it into a plugin-based version.</p>

<h3 id="ip-checker-with-mef-v1-bare-essentials">IP Checker with MEF v1: Bare Essentials</h3>
<p>At this point we have everything we need for the first version of the plugin-based IP checker. Firstly, I divided my project into 5 parts:</p>

<p><img src="/images/vpblogimg/2015/10/ip-checker-with-mef-v1-project-structure.png" alt=""></p>

<ul>
  <li>IPCheckerWithMEF.Lab: The consumer application</li>
  <li>IPCheckerWithMEF.Contract: Project containing the common interface</li>
  <li>Plugins: Extensions for the main application
    <ul>
      <li>IPCheckerWithMEF.Plugins.AwsIPChecker</li>
      <li>IPCheckerWithMEF.Plugins.CustomIPChecker</li>
      <li>IPCheckerWithMEF.Plugins.DynDnsIPChecker</li>
    </ul>
  </li>
</ul>

<p>I set the output folder of the plugins to a directory called Plugins at the project level.</p>

<h3 id="lets-see-some-code">Let’s see some code!</h3>
<p>For this basic version we need 3 things:</p>

<ul>
  <li>A container to handle the composition.</li>
  <li>A catalog that the container can use to discover the plugins.</li>
  <li>A way to tell which classes should be discovered and imported</li>
</ul>

<p>In this sample I used a DirectoryCatalog that points to the output folder of the plugin projects. So after adding the required parts above the main application shaped up to be something like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MainApplication</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">CompositionContainer</span> <span class="n">_container</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">ImportMany</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IIpChecker</span><span class="p">))]</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IIpChecker</span><span class="p">&gt;</span> <span class="n">IpCheckerList</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">MainApplication</span><span class="p">(</span><span class="kt">string</span> <span class="n">pluginFolder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">catalog</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DirectoryCatalog</span><span class="p">(</span><span class="n">pluginFolder</span><span class="p">);</span>
        <span class="n">_container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CompositionContainer</span><span class="p">(</span><span class="n">catalog</span><span class="p">);</span>

        <span class="nf">LoadPlugins</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">LoadPlugins</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">_container</span><span class="p">.</span><span class="nf">ComposeParts</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">CompositionException</span> <span class="n">compositionException</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">compositionException</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the constructor, it instantiates a DirectoryCatalog with the given path and passes it to the container. The container imports IIpChecker type objects found in the assemblies inside that folder. Note that we didn’t do anything about IpCheckerList. By decorating it with ImportMany attribute we declared that it’s to be filled by the composition engine. In this example we could only use <em>ImportMany</em> as opposed to <em>Import</em> which would look for a single part to compose. If we used Import we would get the following exception:</p>

<p><img src="/images/vpblogimg/2015/10/ip-checker-with-mef-v1-single-import-exception.png" alt=""></p>

<p>Now to complete the circle we need to export our plugins with <em>Export</em> attribute such as:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">Export</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IIpChecker</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">AwsIPChecker</span> <span class="p">:</span> <span class="n">IIpChecker</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetExternalIp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Alternatively we can use InheritedExport attribute on the interface to export any class that implements the IIpChecker interface.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">InheritedExport</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IIpChecker</span><span class="p">))]</span>
<span class="k">public</span> <span class="k">interface</span> <span class="nc">IIpChecker</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="nf">GetExternalIp</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This way the plugins would still be discovered even if they weren’t decorated with Export attribute because of this inheritance model.</p>

<h3 id="putting-it-together">Putting it together</h3>
<p>Now that we’ve seen the plugins that export the implementation and part that discovers and imports them let’s see them all in action:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Starting the main application"</span><span class="p">);</span>

        <span class="kt">string</span> <span class="n">pluginFolder</span> <span class="p">=</span> <span class="s">@"..\..\..\Plugins\"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">app</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MainApplication</span><span class="p">(</span><span class="n">pluginFolder</span><span class="p">);</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">app</span><span class="p">.</span><span class="n">IpCheckerList</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> plugin(s) loaded.."</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Executing all plugins..."</span><span class="p">);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">ipChecker</span> <span class="k">in</span> <span class="n">app</span><span class="p">.</span><span class="n">IpCheckerList</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="nf">ObfuscateIP</span><span class="p">(</span><span class="n">ipChecker</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">()));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ObfuscateIP</span><span class="p">(</span><span class="kt">string</span> <span class="n">actualIp</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">Regex</span><span class="p">.</span><span class="nf">Replace</span><span class="p">(</span><span class="n">actualIp</span><span class="p">,</span> <span class="s">"[0-9]"</span><span class="p">,</span> <span class="s">"*"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We create the consumer application that loads all the plugins in the directory we specify. Then we can loop over and execute all of them:</p>

<p><img src="/images/vpblogimg/2015/10/ip-checker-with-mef-v1-output.png" alt=""></p>

<p>So far so good. Now, let’s try to export some metadata about our plugins so that we can display the loaded plugins to the user.</p>

<h3 id="ip-checker-with-mef-v2-metadata-comes-into-play">IP Checker with MEF v2: Metadata comes into play</h3>
<p>In almost all applications plugins come with some sort of information so that the user can identify which ones have been installed and what they do. To export the extra data let’s add a new interface:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IPluginInfo</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">DisplayName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">Description</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">string</span> <span class="n">Version</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And on the plugins we fill that data and export it using the <em>ExportMetadata</em> attribute:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">Export</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">IIpChecker</span><span class="p">))]</span>
<span class="p">[</span><span class="nf">ExportMetadata</span><span class="p">(</span><span class="s">"DisplayName"</span><span class="p">,</span> <span class="s">"Custom IP Checker"</span><span class="p">)]</span>
<span class="p">[</span><span class="nf">ExportMetadata</span><span class="p">(</span><span class="s">"Description"</span><span class="p">,</span> <span class="s">"Uses homebrew service developed with Node.js and hosted on Heroku"</span><span class="p">)]</span>
<span class="p">[</span><span class="nf">ExportMetadata</span><span class="p">(</span><span class="s">"Version"</span><span class="p">,</span> <span class="s">"2.1"</span><span class="p">)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">CustomIpChecker</span> <span class="p">:</span> <span class="n">IIpChecker</span>
<span class="p">{</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In v1, we only imported a list of objects implementing IIpChecker. So how do we accommodate this new piece of information? In order to do that we have to change the way we import the plugins and use the <em>Lazy</em> construct:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">ImportMany</span><span class="p">]</span>
<span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Lazy</span><span class="p">&lt;</span><span class="n">IIpChecker</span><span class="p">,</span> <span class="n">IPluginInfo</span><span class="p">&gt;&gt;</span> <span class="n">Plugins</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>According to <a href="https://msdn.microsoft.com/en-us/library/vstudio/ee155691%28v=vs.100%29.aspx" target="_blank" rel="noopener noreferrer">MSDN</a> this is mandatory to get metadata out of plugins:</p>

<blockquote>
  <p>The importing part can use this data to decide which exports to use, or to gather information about an export without having to construct it. For this reason, an import must be lazy to use metadata</p>
</blockquote>

<p>So let’s load and display this new plugin information:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">PrintPluginInfo</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">_app</span><span class="p">.</span><span class="n">Plugins</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> plugin(s) loaded.."</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Displaying plugin info..."</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">ipChecker</span> <span class="k">in</span> <span class="n">_app</span><span class="p">.</span><span class="n">Plugins</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"----------------------------------------"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Name: </span><span class="p">{</span><span class="n">ipChecker</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Description: </span><span class="p">{</span><span class="n">ipChecker</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Description</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Version: </span><span class="p">{</span><span class="n">ipChecker</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Version</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Notice that we access the metadata through <em>[PluginName].Metadata.[PropertyName]</em> properties. To access the actual plugin and call the exported methods we have to use <em>[PluginName].Value</em> such as:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">ipChecker</span> <span class="k">in</span> <span class="n">_app</span><span class="p">.</span><span class="n">Plugins</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ipChecker</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p><img src="/images/vpblogimg/2015/10/ip-checker-with-mef-v2-output-with-metadata.png" alt=""></p>

<h3 id="managing-the-plugins">Managing the plugins</h3>
<p>What if we want to add or remove plugins at runtime? We can do it without restarting the application but refreshing the catalog and calling the container’s ComposeParts method again.</p>

<p>In this sample application I added a FileSystemWatcher that listens to the Created and Deleted events on the Plugins folder and calls the LoadPlugins method of the application when an event fires. LoadPlugins first refreshes the catalog and composes the parts:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">LoadPlugins</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">_catalog</span><span class="p">.</span><span class="nf">Refresh</span><span class="p">();</span>
        <span class="n">_container</span><span class="p">.</span><span class="nf">ComposeParts</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">catch</span> <span class="p">(</span><span class="n">CompositionException</span> <span class="n">compositionException</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">compositionException</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>But making this change alone isn’t sufficient and we would end up getting a CompositionException:</p>

<p><img src="/images/vpblogimg/2015/10/ip-checker-with-mef-v2-recomposition-exception.png" alt=""></p>

<p>By default recomposition is disabled so we have to specify it explicitly while importing parts:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nf">ImportMany</span><span class="p">(</span><span class="n">AllowRecomposition</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
<span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Lazy</span><span class="p">&lt;</span><span class="n">IIpChecker</span><span class="p">,</span> <span class="n">IPluginInfo</span><span class="p">&gt;&gt;</span> <span class="n">Plugins</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>After these changes the final version of composing class looks like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MainApplication</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="n">CompositionContainer</span> <span class="n">_container</span><span class="p">;</span>
    <span class="k">private</span> <span class="n">DirectoryCatalog</span> <span class="n">_catalog</span><span class="p">;</span>

    <span class="p">[</span><span class="nf">ImportMany</span><span class="p">(</span><span class="n">AllowRecomposition</span> <span class="p">=</span> <span class="k">true</span><span class="p">)]</span>
    <span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Lazy</span><span class="p">&lt;</span><span class="n">IIpChecker</span><span class="p">,</span> <span class="n">IPluginInfo</span><span class="p">&gt;&gt;</span> <span class="n">Plugins</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="nf">MainApplication</span><span class="p">(</span><span class="kt">string</span> <span class="n">pluginFolder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_catalog</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DirectoryCatalog</span><span class="p">(</span><span class="n">pluginFolder</span><span class="p">);</span>
        <span class="n">_container</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CompositionContainer</span><span class="p">(</span><span class="n">_catalog</span><span class="p">);</span>

        <span class="nf">LoadPlugins</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">LoadPlugins</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="n">_catalog</span><span class="p">.</span><span class="nf">Refresh</span><span class="p">();</span>
            <span class="n">_container</span><span class="p">.</span><span class="nf">ComposeParts</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">CompositionException</span> <span class="n">compositionException</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">compositionException</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and the client app:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">static</span> <span class="k">readonly</span> <span class="kt">string</span> <span class="n">_pluginFolder</span> <span class="p">=</span> <span class="s">@"..\..\..\Plugins\"</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">FileSystemWatcher</span> <span class="n">_pluginWatcher</span><span class="p">;</span>
    <span class="k">private</span> <span class="k">static</span> <span class="n">MainApplication</span> <span class="n">_app</span><span class="p">;</span>

    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Starting the main application"</span><span class="p">);</span>

        <span class="n">_pluginWatcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileSystemWatcher</span><span class="p">(</span><span class="n">_pluginFolder</span><span class="p">);</span>
        <span class="n">_pluginWatcher</span><span class="p">.</span><span class="n">Created</span> <span class="p">+=</span> <span class="n">PluginWatcher_FolderUpdated</span><span class="p">;</span>
        <span class="n">_pluginWatcher</span><span class="p">.</span><span class="n">Deleted</span> <span class="p">+=</span> <span class="n">PluginWatcher_FolderUpdated</span><span class="p">;</span>
        <span class="n">_pluginWatcher</span><span class="p">.</span><span class="n">EnableRaisingEvents</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="n">_app</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">MainApplication</span><span class="p">(</span><span class="n">_pluginFolder</span><span class="p">);</span>

        <span class="nf">PrintPluginInfo</span><span class="p">();</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadLine</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">PrintPluginInfo</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">_app</span><span class="p">.</span><span class="n">Plugins</span><span class="p">.</span><span class="n">Count</span><span class="p">}</span><span class="s"> plugin(s) loaded.."</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Displaying plugin info..."</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">ipChecker</span> <span class="k">in</span> <span class="n">_app</span><span class="p">.</span><span class="n">Plugins</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"----------------------------------------"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Name: </span><span class="p">{</span><span class="n">ipChecker</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">DisplayName</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Description: </span><span class="p">{</span><span class="n">ipChecker</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Description</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
            <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Version: </span><span class="p">{</span><span class="n">ipChecker</span><span class="p">.</span><span class="n">Metadata</span><span class="p">.</span><span class="n">Version</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">PluginWatcher_FolderUpdated</span><span class="p">(</span><span class="kt">object</span> <span class="n">sender</span><span class="p">,</span> <span class="n">FileSystemEventArgs</span> <span class="n">e</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"===================================="</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Folder changed. Reloading plugins..."</span><span class="p">);</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">();</span>
        
        <span class="n">_app</span><span class="p">.</span><span class="nf">LoadPlugins</span><span class="p">();</span>

        <span class="nf">PrintPluginInfo</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After these changes I started the application with 2 plugins in the target folder and added a 3rd one while it’s running and got this output:</p>

<p><img src="/images/vpblogimg/2015/10/ip-checker-with-mef-v2-output-with-updated-plugins.png" alt=""></p>

<p>It also works the same way for deleted plugins but not for updates because the assemblies are locked by .NET. Adding new plugins at runtime is painless but removing and updating would require more attention as the plugin might be running at the time.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/ip-checker-with-mef" target="_blank" rel="noopener noreferrer">Sample project source code</a></li>
  <li><a href="https://volkanpaksoy.com/archive/2015/10/12/design-patterns-strategy">IP Checker with strategy design pattern blog post</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/dd460648%28v=vs.110%29.aspx" target="_blank" rel="noopener noreferrer">MSDN: Managed Extensibility Framework (MEF)</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/system.componentmodel.composition.hosting" target="_blank" rel="noopener noreferrer">MSDN: System.ComponentModel.Composition.Hosting Namespace</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/vstudio/ee155691%28v=vs.100%29.aspx" target="_blank" rel="noopener noreferrer">MSDN: Attributed Programming Model Overview</a></li>
  <li><a href="https://mef.codeplex.com/" target="_blank" rel="noopener noreferrer">MEF Source Code on Codeplex</a></li>
  <li><a href="http://msdn.microsoft.com/en-us/magazine/ee291628.aspx" target="_blank" rel="noopener noreferrer">MSDN Magazine Article: Building Composable Apps in .NET 4 with the Managed Extensibility Framework</a></li>
</ul>


		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/20" class="prev">Prev</a>
    
    
        <a href="/page/22" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2022 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
