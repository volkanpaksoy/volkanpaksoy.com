<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/22/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script data-ad-client="ca-pub-0414743900624675" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35583486-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/10/12/design-patterns-strategy/" itemprop="url">Design Patterns: Strategy</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-10-12T15:00:00+01:00" itemprop="datePublished">October 12, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/designdev">design</a></span> -->

<!-- design, dev -->




    <a href="/category/design">design</a>
    , 

    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">design_patterns, csharp</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>Often times we need to change some algorithm with another without changing the client code that’s consuming it. In this post I want to show a use case I came across and utilised Strategy pattern.</p>

<h3 id="what-is-it">What is it?</h3>
<p>Here’s the official definition of the pattern from GoF book:</p>

<blockquote>
  <p>Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently from clients that use it.</p>
</blockquote>

<h3 id="use-case-get-external-ip-address">Use case: Get external IP address</h3>
<p>In an application I was working on I needed to get the external IP address of the computer the application is running on. There are various ways to achieve that. This looked like a good opprtunity to use the Strategy pattern as I wanted to be able switch between the different methods easily.</p>

<h3 id="implementation">Implementation</h3>
<p>The interface is quite simple:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IIpCheckStrategy</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="nf">GetExternalIp</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Some services return their data in JSON format, some have extra text in it. But encapsulating the algorithms in their own classes this way, the clint code doesn’t have to worry about parsing these various return values. It’s handled in each class. If one service changes it’s output and breaks the implementation I can recover just by changing the code instantiates the class.</p>

<p>The concrete implementations of the interface are below. They implement the IIpCheckStrategy and are responsible for getting the data and return parsed IP address as string.</p>

<p>AWS IP Checker:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">AwsIPCheckStrategy</span> <span class="p">:</span> <span class="n">IIpCheckStrategy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetExternalIp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">client</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://checkip.amazonaws.com/"</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetStringAsync</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="nf">TrimEnd</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>DynDns IP Checker:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">DynDnsIPCheckStrategy</span> <span class="p">:</span> <span class="n">IIpCheckStrategy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetExternalIp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">client</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://checkip.dyndns.org/"</span><span class="p">);</span>
            <span class="n">HttpResponseMessage</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">HelperMethods</span><span class="p">.</span><span class="nf">ExtractIPAddress</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Custom IP Checker:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CustomIpCheckStrategy</span> <span class="p">:</span> <span class="n">IIpCheckStrategy</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="nf">GetExternalIp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">())</span>
        <span class="p">{</span>
            <span class="n">client</span><span class="p">.</span><span class="n">BaseAddress</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://check-ip.herokuapp.com/"</span><span class="p">);</span>
            <span class="n">client</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Clear</span><span class="p">();</span>
            <span class="n">client</span><span class="p">.</span><span class="n">DefaultRequestHeaders</span><span class="p">.</span><span class="n">Accept</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">MediaTypeWithQualityHeaderValue</span><span class="p">(</span><span class="s">"application/json"</span><span class="p">));</span>

            <span class="n">HttpResponseMessage</span> <span class="n">response</span> <span class="p">=</span> <span class="n">client</span><span class="p">.</span><span class="nf">GetAsync</span><span class="p">(</span><span class="s">""</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
            <span class="kt">string</span> <span class="n">json</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
            <span class="kt">dynamic</span> <span class="n">ip</span> <span class="p">=</span> <span class="n">Newtonsoft</span><span class="p">.</span><span class="n">Json</span><span class="p">.</span><span class="n">JsonConvert</span><span class="p">.</span><span class="nf">DeserializeObject</span><span class="p">(</span><span class="n">json</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">result</span> <span class="p">=</span> <span class="n">ip</span><span class="p">.</span><span class="n">ipAddress</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="choosing-the-algorithm">Choosing the algorithm</h3>
<p>The consumer of the algorithm can pick any class that implements IIpCheckStrategy and switch between them. For example:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StrategyClient1</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">IIpCheckStrategy</span> <span class="n">ipChecker</span><span class="p">;</span>

        <span class="n">ipChecker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DynDnsIPCheckStrategy</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ipChecker</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">());</span>

        <span class="n">ipChecker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AwsIPCheckStrategy</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ipChecker</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">());</span>

        <span class="n">ipChecker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CustomIpCheckStrategy</span><span class="p">();</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ipChecker</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">());</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">ReadKey</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Also the class name to be used can be stored in the configuration in some cases so that it can be changed at runtime without recompiling the application. For instance:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StrategyClient2</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">ipcheckerTypeName</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"IPChecker"</span><span class="p">];</span>

        <span class="n">IIpCheckStrategy</span> <span class="n">ipchecker</span> <span class="p">=</span> <span class="n">Assembly</span><span class="p">.</span><span class="nf">GetExecutingAssembly</span><span class="p">().</span><span class="nf">CreateInstance</span><span class="p">(</span><span class="n">ipcheckerTypeName</span><span class="p">)</span> <span class="k">as</span> <span class="n">IIpCheckStrategy</span><span class="p">;</span>

        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">ipchecker</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and the appSettings in the configuration would look like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;appSettings&gt;</span>
	<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"IPChecker"</span> <span class="na">value=</span><span class="s">"Strategy.AwsIPCheckStrategy"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/appSettings&gt;</span>
</code></pre></div></div>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/design-pattern-workout" target="_blank" rel="noopener noreferrer">Sample source code</a></li>
  <li><a href="http://www.amazon.co.uk/Head-First-Design-Patterns-Freeman/dp/0596007124" target="_blank" rel="noopener noreferrer">Head First Design Patterns</a></li>
  <li><a href="http://www.amazon.co.uk/Design-patterns-elements-reusable-object-oriented/dp/0201633612" target="_blank" rel="noopener noreferrer">GoF Book: Design Patterns : Elements of Reusable Object-Oriented Software</a></li>
  <li><a href="http://www.pluralsight.com/courses/csharp-design-strategies" target="_blank" rel="noopener noreferrer">Pluralsight course: C# Design Strategies</a></li>
  <li><a href="http://www.dofactory.com/net/strategy-design-pattern" target="_blank" rel="noopener noreferrer">DoFactory Strategy Design Pattern</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/10/09/aws-lambda-official-scheduling-support/" itemprop="url">AWS Lambda Official Scheduling Support</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-10-09T15:00:00+01:00" itemprop="datePublished">October  9, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">lambda</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>Just two days ago I was jumping through a lot of hoops (maintain state on S3, subscribe to public SNS topics) just to schedule a Lambda function, as explained <a href="https://volkanpaksoy.com/archive/2015/10/07/mail-automation-with-aws-lambda-and-sns/">here</a>. If I knew all these problems were to be solved in a day, I would just wait! In re-Invent 2015 event AWS announced scheduled event support for Lambda functions.</p>

<p><img src="/images/vpblogimg/2015/10/aws-lambda-scheduled-event.png" alt=""></p>

<p>After tweaking around a little bit with the sample I set my schedule like this which will run first day of every month at 10:00:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cron(0 10 1 * ? *)
</code></pre></div></div>

<p>That’s all there is to it for a monthly schedule. Reliable and no need for my state management workarounds. So the final code becomes as simple as sending an email when invoked:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/51d914294557c637eb85d98c9ecda287.js"> </script>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://aws.amazon.com/blogs/aws/aws-lambda-update-python-vpc-increased-function-duration-scheduling-and-more/" target="_blank" rel="noopener noreferrer">AWS Lambda Update – Python, VPC, Increased Function Duration, Scheduling, and More</a></li>
  <li><a href="http://docs.aws.amazon.com/lambda/latest/dg/getting-started-scheduled-events.html" target="_blank" rel="noopener noreferrer">Documentation on scheduling</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/10/07/mail-automation-with-aws-lambda-and-sns/" itemprop="url">Mail automation with AWS Lambda and SNS</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-10-07T15:00:00+01:00" itemprop="datePublished">October  7, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">lambda, s3, sns</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>UPDATE: Yesterday (October 8th, 2015) Amazon announced official support for scheduled events so I updated my function to use this feature. 
For the most up-to-date version of this project please visit the <a href="https://volkanpaksoy.com/archive/2015/10/09/aws-lambda-official-scheduling-support/">updated version</a></p>
</blockquote>

<p>I have a great accountant but he has one flaw: I have to ask for the invoice every month! While waiting for him to automate the process, I decided to automate what I can on my end. There are many ways to skin a cat, as the saying goes, the way I picked for this task was developing an AWS Lambda funciton and trigger it by subscribing to a public SNS topic.</p>

<h2 id="step-1-prepare-a-function-to-send-emails">Step 1: Prepare a function to send emails</h2>
<p>Developing a simple node.js function that sends E-mails was simple. First I needed the install two modules:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install nodemailer
npm install nodemailer-smtp-transport
</code></pre></div></div>

<p>And the function is straightforward:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">transporter</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">smtpTransport</span><span class="p">({</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'email-smtp.eu-west-1.amazonaws.com'</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">587</span><span class="p">,</span>
    <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">user</span><span class="p">:</span> <span class="s1">'{ACCESS KEY}'</span><span class="p">,</span>
        <span class="na">pass</span><span class="p">:</span> <span class="s1">'{SECRET KEY}'</span>
    <span class="p">}</span>
<span class="p">}));</span>

<span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="s1">'Hi, Invoice! Thanks!'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">from</span><span class="p">:</span> <span class="s1">'from@me.net'</span><span class="p">,</span>
    <span class="na">to</span><span class="p">:</span> <span class="s1">'to@someone.net'</span><span class="p">,</span>
    <span class="na">bcc</span><span class="p">:</span> <span class="s1">'me2@me.com'</span><span class="p">,</span>
    <span class="na">subject</span><span class="p">:</span> <span class="s1">'Invoice'</span><span class="p">,</span>
    <span class="na">text</span><span class="p">:</span> <span class="nx">text</span> 
<span class="p">};</span>

<span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">info</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Message sent'</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>The challenge was deployment as the script had some dependencies. If you choose Edit Inline and just paste the script you would get an error like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"errorMessage": "Cannot find module 'nodemailer'",
</code></pre></div></div>

<p>But it’s very easy to deploy a full package with dependencies. Just zip everything in the folder (wihtout the folder itself) and upload the zip file. The downside of this method is you can no longer edit the code inline. So even just for fixing a trivial typo you need to re-zip and re-upload.</p>

<h2 id="step-2-schedule-the-process">Step 2: Schedule the process</h2>
<p>One simple method to schedule the process is to invoke the method using Powershell and schedule a task to run the script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-LMFunction -FunctionName automatedEmails -AccessKey accessKey -SecretKey secretKey -Region eu-west-1
</code></pre></div></div>

<p>But I don’t want a dependency on any machine (local or EC2 instance). Otherwise I could write a few lines of code in C# to do the same job anyway. The idea of using Lambda is to avoid maintenance and let everything run on infrastructure that’s maintained by AWS.</p>

<h3 id="unreliable-town-clock">Unreliable Town Clock</h3>
<p>Unfortunately AWS doesn’t provide an easy method to schedule Lambda function invocations. For the sake of simplicity I decided to use <a href="https://alestic.com/2015/05/aws-lambda-recurring-schedule/" target="_blank" rel="noopener noreferrer">Unreliable Town Clock (UTC)</a> which is essentially a public SNS topic that sends “chime” messages every 15 minutes.</p>

<p><img src="/images/vpblogimg/2015/10/mail-automation-sns-subscription.png" alt=""></p>

<p>Since all I need is one email, I don’t care if it skips a beat or two as long as it chimes at least once throughout the day.</p>

<h3 id="state-management">State management</h3>
<p>Of course to avoid bombarding my accountant with emails I have to maintain a state so that I would only send one email per month. But Lambda functions must be stateless. Some alternatives are using AWS S3 or DynamoDB. Since all I need is one simple integer value I decided to store in a text file on S3. So first I download the log file and check the last sent email month:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">downloadLog</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s3</span><span class="p">.</span><span class="nx">getObject</span><span class="p">({</span>
			<span class="na">Bucket</span><span class="p">:</span> <span class="nx">bucketName</span><span class="p">,</span>
			<span class="na">Key</span><span class="p">:</span> <span class="nx">fileName</span>
		<span class="p">},</span>
		<span class="nx">next</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">checkDate</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">currentDay</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Sns</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">day</span><span class="p">);</span>
	<span class="nx">currentMonth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Sns</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">month</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">lastMailMonth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">lastMailMonth</span><span class="p">))</span> <span class="p">{</span>
		<span class="nx">lastMailMonth</span> <span class="o">=</span> <span class="nx">currentMonth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="nx">currentDay</span> <span class="o">==</span> <span class="nx">targetDayOfMonth</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">currentMonth</span> <span class="o">&gt;</span> <span class="nx">lastMailMonth</span><span class="p">))</span> <span class="p">{</span>
		<span class="nx">next</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="putting-it-together">Putting it together</h3>
<p>So putting it all together the final code is:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/01d54e98dcc1cd0b3dcfaf12e57bc4fe.js"> </script>

<p>Let’s see if it’s going to help me get my invoices automatically!</p>

<h2 id="conclusion">Conclusion</h2>
<ul>
  <li>
    <p>A better approach would be to check emails for the invoice and send only if it wasn’t received already. Also a copule of reminders after the initial email would be nice. But as my new resolution is to progress in small, incremental steps I’ll call it version 1.0 and leave the remaining tasks for a later version.</p>
  </li>
  <li>
    <p>My main goal was to achieve this task without having to worry about the infrastructure. I still don’t but that’s only because a nice guy (namely Eric Hammond) decided to setup a public service for the rest of us.</p>
  </li>
  <li>
    <p>During my research I came across a few references saying that the same task can be done using AWS Simple Workflow (SWF). I haven’t used this service before. Looked complicated and felt like there is a steep learning curve to go through. In Version 2 I should look into SWF which would…</p>

    <ul>
      <li>allow me to handle a complex workflow</li>
      <li>make dependency to public SNS topic redundant</li>
      <li>handle state properly</li>
    </ul>
  </li>
</ul>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://javascript.tutorialhorizon.com/2015/07/02/send-email-node-js-express/" target="_blank" rel="noopener noreferrer">Send email using nodejs and express in 5 simple steps</a></li>
  <li><a href="https://aws.amazon.com/blogs/compute/nodejs-packages-in-lambda/" target="_blank" rel="noopener noreferrer">Using Packages and Native nodejs Modules in AWS Lambda</a></li>
  <li><a href="http://docs.aws.amazon.com/lambda/latest/dg/walkthrough-s3-events-adminuser-create-test-function-create-function.html" target="_blank" rel="noopener noreferrer">Create a Lambda Function Deployment Package</a></li>
  <li><a href="https://alestic.com/2015/05/aws-lambda-recurring-schedule/" target="_blank" rel="noopener noreferrer">Schedule Recurring AWS Lambda Invocations With The Unreliable Town Clock (UTC)</a></li>
  <li><a href="https://aws.amazon.com/about-aws/whats-new/2015/08/trigger-aws-lambda-functions-using-amazon-simple-workflow/" target="_blank" rel="noopener noreferrer">Trigger AWS Lambda Functions Using Amazon Simple Workflow</a></li>
  <li><a href="http://docs.aws.amazon.com/amazonswf/latest/awsflowguide/lambda-task.html" target="_blank" rel="noopener noreferrer">Implementing AWS Lambda Tasks</a></li>
</ul>

		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/21" class="prev">Prev</a>
    
    
        <a href="/page/23" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2021 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
