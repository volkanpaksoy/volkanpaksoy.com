<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/14/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script data-ad-client="ca-pub-0414743900624675" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35583486-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2018/06/26/Automated-Email-Processing-with-AWS-SES-and-Lambda/" itemprop="url">Automated Email Processing with AWS SES and Lambda</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2018-06-26T07:00:00+01:00" itemprop="datePublished">June 26, 2018</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">ses, lambda</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>A few years ago AWS announced a new SES feature: Incoming Emails. So far I have only used it once to receive domain verification emails to an S3 bucket but haven’t built a meaningful project. In this blog post my goal is to develop a sample project to demonstrate receiving emails with SES and processing those emails automatically by triggering Lambda functions.</p>

<p>As a demo project I will build a system that automatically responds to a sender with my latest CV as shown in the diagram below</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-00-architecture.png" alt=""></p>

<h2 id="receiving-email-with-amazon-simple-email-service">Receiving Email with Amazon Simple Email Service</h2>
<p>Amazon Simple Email Service (SES) is Amazon’s SMTP server. It’s core functionality has been sending emails but Amazon kept adding more features such as using templates and receiving emails.</p>

<h3 id="step-1-verify-a-new-domain">Step 1: Verify a New Domain</h3>
<p>First, we need a verified domain to receive emails. If you already have one you ca skip this step.</p>

<ul>
  <li>Step 1.1: In the SES console, click Domains –&gt; Verify a New Domain</li>
  <li>Step 1.2: Enter the domain name to verify and click Verify This Domain</li>
</ul>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-01-verify-domain.png" alt=""></p>

<ul>
  <li>Step 1.3: In the new dialog click Use Route 53</li>
</ul>

<p>(This is assuming your domain is in Route53. If not you have to verify it by other means)</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-02-verify-domain-confirmation.png" alt=""></p>

<ul>
  <li>Step 1.4: Make sure you check Email Receiving Record checkbox and proceed</li>
</ul>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-03-verify-domain-create-record-sets.png" alt=""></p>

<ul>
  <li>Step 1.5 Confirm verification status</li>
</ul>

<p>Go back to Domains page in SES console and make sure the verification has been completed successfully</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-04-verify-domain-confirm-results.png" alt=""></p>

<p>In my example, it only took about 2 minutes.</p>

<h3 id="step-2-create-a-lambda-function-to-send-the-cv">Step 2: Create a Lambda function to send the CV</h3>

<p>In the next step we will continue to configure SES to specify what to do with the received email. But first we need the actual Lambda function to do the work. Then we will connect this to SES so that it runs everytime when we receive an email to a specific email.</p>

<ul>
  <li>Step 2.1: Create a Lambda function from scratch</li>
</ul>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-06-create-lambda.png" alt=""></p>

<ul>
  <li>Step 2.2: Create an SNS topic</li>
</ul>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-08-create-sns-topic.png" alt=""></p>

<p>SES will publish emails to this topic. We will do the plumbing and give necessary permissions later.</p>

<ul>
  <li>Step 2.3: Create subscription for the Lambda function to SNS topic</li>
</ul>

<p>Now we tie the topic to our Lambda by creating a subscription</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-10-create-sns-subscription.png" alt=""></p>

<ul>
  <li>Step 2.4: Attach necessary permissions to the new role</li>
</ul>

<p>In my example, I store my CV in an S3 bucket. So the policy would need to receive SNS notifications, read access to S3 bucket and permissions to send emails.</p>

<p>By default a new Lambda role comes with AWSLambdaBasicExecutionRole attached to it</p>

<p>First add this to have read-only access to a single bucket:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor0"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"s3:GetObjectAcl"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:GetObject"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"s3:ListBucket"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"arn:aws:s3:::{BUCKET NAME}"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"arn:aws:s3:::*/*"</span><span class="w">
            </span><span class="p">]</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Then this to be able to send emails</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor0"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"ses:SendEmail"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ses:SendTemplatedEmail"</span><span class="p">,</span><span class="w">
                </span><span class="s2">"ses:SendRawEmail"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>I like to keep these small, modular policies so that I can reuse then in other projects.</p>

<p>After adding the policies you should be able to see these in your Lambda function’s access list when you refresh the function’s page:</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-07-updated-permissions.png" alt=""></p>

<h3 id="step-3-develop-the-lambda-function">Step 3: Develop the Lambda function</h3>

<p>In this exmample I’m going to use a .NET Core and C# 2.0 to create the Lambda function.</p>

<ul>
  <li>Step 3.1: Install Lambda templates</li>
</ul>

<p>In Windows, AWS Lambda function templates come with AWS Visual Studio extension but in Mac we have to install them via command line.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new -i Amazon.Lambda.Templates::*
</code></pre></div></div>

<ul>
  <li>Step 3.2: Create Lambda function</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet new lambda.EmptyFunction --name SendEmailWithAttachmentFromS3 --profile default --region eu-west-1
</code></pre></div></div>

<ul>
  <li>Step 3.3:</li>
</ul>

<p>Now it’s time for the actual implementation. I’m not going to paste the whole code here. Best place to get it is its <a href="https://github.com/volkanpaksoy/lab/tree/master/blog/SendEmailWithAttachmentFromS3/src/SendEmailWithAttachmentFromS3" target="_blank" rel="noopener noreferrer">GitHub repository</a></p>

<ul>
  <li>Step 3.4 Deploy the function</li>
</ul>

<p>Create an IAM user with access to Lambda deployment and create a profile locally named deploy-lambda-profile.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dotnet restore
dotnet lambda deploy-function send_cv
</code></pre></div></div>

<h3 id="step-4-create-a-receipt-rule">Step 4: Create a Receipt Rule</h3>
<p>Now that we have a verified domain, we need a rule to receive emails.</p>

<p>In my example project, I’m going to use an email address that will send my latest CV to a provided email adress.</p>

<ul>
  <li>
    <p>Step 4.1: In the Email Receiving section click on Rule Sets –&gt; Create a Receipt Rule</p>
  </li>
  <li>
    <p>Step 4.2: Add a recipient</p>
  </li>
</ul>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-05-add-recipient.png" alt=""></p>

<ul>
  <li>Step 4.3: Add an Action</li>
</ul>

<p>Now we choose what to do when an email is received. In this example I want it to be published to an SNS topic that I created earlier. I could invoke the Lambda function directly but leveraging publish/subscribe gives me more flexibility as in I can change the subscriber in the future or add more stuff to do without affecting the rule configuration.</p>

<p>Since it supports multiple actions I could choose to invoke Lambda directly and add more actions here later on if need be but I’d like to use a standard approach which is all events are published to SNS and the interested parties subscribe to the topics.</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-09-add-action.png" alt=""></p>

<p>I chose UTF-8 because I’m not expecting any data in the message body so it doesn’t matter too much in this example.</p>

<ul>
  <li>Step 4.4 Give it a name and create the rule.</li>
</ul>

<h2 id="step-4-test-end-to-end">Step 4: Test end-to-end</h2>

<p>Now that it’s all set up, it is time to test.</p>

<ul>
  <li>Step 4.1: Send a blank email to cv@vlkn.me (Or any other address if you’re setting up your own)</li>
</ul>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-11-test-send-email.png" alt=""></p>

<ul>
  <li>Step 4.2:</li>
</ul>

<p>Then after a few seconds later, receive an email with the attachment:</p>

<p><img src="/images/vpblogimg/2018/06/process-email-with-ses-12-test-confirm-email.png" alt=""></p>

<p>The second email is optional. Basically, I creted an email subscriber too. So that whenever a blank email is received I get notified by SNS directly. This helps me to keep an eye on traffic if there is any.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/lab/tree/master/blog/SendEmailWithAttachmentFromS3/src/SendEmailWithAttachmentFromS3" target="_blank" rel="noopener noreferrer">Demo Source Code</a></li>
  <li><a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/receiving-email.html" target="_blank" rel="noopener noreferrer">Receiving Email with Amazon SES</a></li>
  <li><a href="https://aws.amazon.com/blogs/aws/new-receive-and-process-incoming-email-with-amazon-ses/" target="_blank" rel="noopener noreferrer">AWS Blog: Receive and Process Incoming Email with Amazon SES</a></li>
  <li><a href="https://aws.amazon.com/blogs/messaging-and-targeting/introducing-email-templates-and-bulk-sending/" target="_blank" rel="noopener noreferrer">Introducing Email Templates and Bulk Sending</a></li>
  <li><a href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-dotnet-coreclr-deployment-package.html" target="_blank" rel="noopener noreferrer">.NET Core CLI</a></li>
  <li><a href="https://github.com/aws/aws-lambda-dotnet/tree/master/Libraries/src/Amazon.Lambda.SNSEvents" target="_blank" rel="noopener noreferrer">Amazon.Lambda.SNSEvents</a></li>
  <li><a href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/send-personalized-email-api.html" target="_blank" rel="noopener noreferrer">Sending Personalized Email Using the Amazon SES API</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2018/06/15/AWS-certification/" itemprop="url">AWS Certification</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2018-06-15T07:00:00+01:00" itemprop="datePublished">June 15, 2018</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/aws">aws</a></span> -->

<!-- aws -->




    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">certification</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>I’ve been working with AWS for years. Since I love everything about it and planning to use it for the foreseeable future, I’ve decided to go ahead and get the official certificates. This is to make sure I’ve covered all the important aspects of AWS fully. Also it motivates me to devleop more projects and blog posts on it.</p>

<h2 id="overview">Overview</h2>
<p>There are 2 main categories of tracks:</p>

<ul>
  <li>Role-based Certifications</li>
  <li>Specialty Certifications</li>
</ul>

<p>The tracks and exam paths to take are shown in the diagram below:</p>

<p><img src="/images/vpblogimg/2018/06/aws-certification-01-overview.png" alt=""></p>

<p>My plan is to start with Cloud Practitioner exam, continue with AWS Solutions Architect track and move on to developer and sysops tracks.</p>

<h2 id="costs">Costs</h2>
<p>I think it’s important to analyze costs first to assess whether or not this is a journey you want to start.</p>

<h3 id="individual-exam-costs">Individual Exam Costs</h3>
<p>|Exam Name|Cost|Notes
|AWS Certified Cloud Practitioner|100 USD|Optional
|Associate-level exams|150 USD|
|Professional-level exams|300 USD|
|Specialty exams|300 USD|
|Recertification exams|75 USD|Recertification is required every two years for all AWS Certifications
|Associate-level practice exams|20 USD|
|Professional-level practice exams|40 USD|</p>

<h3 id="total-tracks-costs">Total Tracks Costs</h3>
<p>|Exam Track|Total Cost|With VAT|Notes|
|AWS Solutions Architect|450 USD|540 USD|
|AWS Certified DevOps Engineer|450 USD|540 USD|
|All Associate Level Exams |300 USD|360 USD|3 Exams
|All Professional Level Exams |600 USD|720 USD|2 Exams (There’s no professional level for developer, both associate level exams lead to DevOps engineer)
|All Exams|1150 USD|1380 USD|Includes the optional Cloud Practitioner exam</p>

<p>The total cost is quite cheap but I think in the end it’s worth it.</p>

<h2 id="taking-the-exams">Taking the Exams</h2>
<p>It all starts with <a href="https://aws.training" target="_blank" rel="noopener noreferrer">aws.training</a> site. Just sign in with your Amazon account or create a new one. This allows you to take the online free courses. To take the exams you’d need a new account. I think this is because they partnered with a 3rd party to provide this.</p>

<p><img src="/images/vpblogimg/2018/06/aws-certification-02-new-certification-account.png" alt=""></p>

<p>Registration is quite similar. Just provide name and address and search for an exam centre.</p>

<h2 id="online-training">Online Training</h2>

<h3 id="free-courses">Free Courses</h3>

<h4 id="aws-training"><a href="https://aws.training" target="_blank" rel="noopener noreferrer">AWS Training</a></h4>
<p>This is the official certification site of AWS. It allows the user to enroll to courses and view their transcript.</p>

<p>It’s a bit hard to find the actual course after you enrol because you can’t jump to contents from search results. What you should do is first go to My Transcript and under current courses you should be able to see the course and a link that says “Open”. Clickking that link takes to the actual content.</p>

<ul>
  <li><a href="https://www.aws.training/learningobject/curriculum?id=16357" target="_blank" rel="noopener noreferrer">AWS Cloud Practitioner Essentials (Digital)</a></li>
</ul>

<p>It has more content in the site. I’ll discover more as I go along.</p>

<h4 id="edx"><a href="https://www.edx.org/school/aws" target="_blank" rel="noopener noreferrer">edX</a></h4>
<p>edX have recently launched 3 free AWS courses.</p>

<p><img src="/images/vpblogimg/2018/06/aws-certification-03-edx-aws-exams.png" alt=""></p>

<h3 id="paid-courses">Paid Courses</h3>
<ul>
  <li><a href="https://www.cbtnuggets.com/blog/2018/01/new-course-aws-certified-cloud-practitioner/" target="_blank" rel="noopener noreferrer">CBT Nuggets: AWS Certified Cloud Practitioner</a></li>
  <li><a href="https://www.udemy.com/aws-certified-developer-associate/" target="_blank" rel="noopener noreferrer">Udemy: AWS Certified Developer - Associate 2018</a></li>
  <li><a href="https://www.pluralsight.com/courses/aws-certified-solutions-architect-associate" target="_blank" rel="noopener noreferrer">Pluralsight: AWS Certified Solutions Architect - Associate</a></li>
  <li><a href="https://acloud.guru/courses?vendors=aws" target="_blank" rel="noopener noreferrer">acloud.guru: AWS Courses</a></li>
  <li><a href="https://www.lynda.com/learning-paths/IT/become-an-aws-cloud-practitioner" target="_blank" rel="noopener noreferrer">Lynda: Become an AWS Cloud Practitioner</a></li>
</ul>

<h3 id="various-training-resources">Various Training Resources</h3>
<ul>
  <li><a href="https://aws.amazon.com/new/" target="_blank" rel="noopener noreferrer">What’s New with AWS</a></li>
  <li><a href="https://cloudacademy.com/blog/amazon-aws-2/" target="_blank" rel="noopener noreferrer">CloudAcademy AWS Blog</a></li>
  <li><a href="http://www.ajsnetworking.com/" target="_blank" rel="noopener noreferrer">AJS Networking</a></li>
  <li><a href="https://gist.github.com/volkanpaksoy/840b2059e739b0a37a4444683b24124b" target="_blank" rel="noopener noreferrer">A curated list of AWS resources to prepare for the AWS Certifications</a></li>
</ul>

<h2 id="conclusion">Conclusion</h2>
<p>As my favourite saying goes: “It’s not about the destination, it’s about the journey”.</p>

<p>AWS certification for me is not a destination. It just plays a role for me to stay on course and stay motivated to create more projects and blog posts in a timely manner.</p>

<p>I’m hoping to see this journey to completion. I’ll be posting more on AWS and my journey on certification soon.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://aws.training" target="_blank" rel="noopener noreferrer">aws.training</a></li>
  <li><a href="https://aws.amazon.com/certification/certified-cloud-practitioner/" target="_blank" rel="noopener noreferrer">AWS Certified Cloud Practitioner exam</a></li>
  <li><a href="https://aws.amazon.com/certification/faqs/" target="_blank" rel="noopener noreferrer">AWS Certification FAQ</a></li>
  <li><a href="https://www.certmetrics.com/amazon/public/transcript.aspx" target="_blank" rel="noopener noreferrer">Transcript validation</a></li>
  <li><a href="https://hackernoon.com/3-reasons-why-you-should-get-aws-certified-this-year-7e44dbc51519" target="_blank" rel="noopener noreferrer">Hackernoon article: 3 Reasons Why You Should Get AWS Certified This Year</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2018/05/16/Using-Custom-Domains-with-AWS-API-Gateway/" itemprop="url">Using Custom Domains with AWS API Gateway</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2018-05-16T07:00:00+01:00" itemprop="datePublished">May 16, 2018</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">api_gateway</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>API Gateway is Amazon’s managed API service. Serverless architecture is growing more on me everyday. I think leveraging infinite auto-scaling and only paying for what you use makes perfect sense. But to have an API that will be customer-facing first thing that needs to be setup is a custom domain which might be a bit involved when SSL certificates come in to play. In this post I’d like to create an API from scratch and use a custom domain name assigned to it.</p>

<h2 id="step-1-create-an-api">Step 1: Create an API</h2>
<p>Creating an API is straightforward: Just assign a meaningful and description. However, to me it was a bit confusing when it came to choosing the endpoint type.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-01-create-api.png" alt=""></p>

<p>The two options provided are: <em>Regional</em> and <em>Edge optimized</em>.</p>

<ul>
  <li>
    <p>Edge-optimized API endpoint: The API is deployed to the specified region and a CloudFront distribution is created. API requests are routed to the nearest CloudFront Point of Presence (POP).</p>
  </li>
  <li>
    <p>Regional API endpoint: This type was added in November 2017. The main goal is to prevent a roundtrip for in-region requests. API requests are targeted directly to the region-specific API Gateway without going through any CloudFront distribution.</p>
  </li>
</ul>

<p>Custom domain names are supported for both endpoint types.</p>

<p>In this example, I’ll use <strong>Regional</strong> endpoint type. For further reading, here’s <a href="http://blog.ryangreen.ca/2017/11/03/api-gateway-regional-vs-edge-optimized-endpoints/" target="_blank" rel="noopener noreferrer">a nice blog post about endpoint types</a>.</p>

<h2 id="step-2-create-a-resource-and-method">Step 2: Create a resource and method</h2>
<p>For demonstration purposes I created a resource called customer and a GET method that is which calls a mock endpoint.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-02-create-resource-and-method.png" alt=""></p>

<h2 id="step-3-deploy-the-api">Step 3: Deploy the API</h2>
<p>From the Actions menu in Resources tab, I selected Deploy API.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-03-deploy.png" alt=""></p>

<p>Deployment requires a stage. Since this is the first deployment, I had to create a new stage called test. A new stage can be created while deploying. After the deployment test stage looks like this:</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-04-stage.png" alt=""></p>

<p>At this point API Gateway assigned a non-user-friendly URL already:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://81dkdt6q81.execute-api.eu-west-2.amazonaws.com/test
</code></pre></div></div>

<p>This is the root domain of the API. So I was able to call the endpoint like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://81dkdt6q81.execute-api.eu-west-2.amazonaws.com/test/albums
</code></pre></div></div>

<p>My goal was to get it working with my own domain such as:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://hmdb.myvirtualhome.net/albums
</code></pre></div></div>

<h2 id="step-4-generate-the-certificate-in-acm">Step 4: Generate the certificate in ACM</h2>
<p>I’m using Route53 for all my domains and using ACM (AWS Certificate Manager) for generating SSL/TLS certificates. Before creating the custom domain name I needed my certificate available.</p>

<p>The wizard is quite simple: I just added the subdomain for the API and selected DNS validation.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-05-acm-add-domain-name.png" alt=""></p>

<p>After the review comes the validation process. Since I’m using Route 53 and ACM plays well with it, it simply provided a nice big button that said Create record in Route 53.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-06-acm-validation.png" alt=""></p>

<p>After clicking and confirming I got this confirmation message:</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-07-acm-confirmation.png" alt=""></p>

<p>After waiting for about 3 minutes, the cerficate was issued already:</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-08-acm-done.png" alt=""></p>

<h2 id="step-5-create-custom-domain-name-in-api-gateway">Step 5: Create Custom Domain Name in API Gateway</h2>

<p>Now that the certificate was ready I had to go back to API Gateway to create the custom domain name and associate it with the newly created cert.</p>

<p>First, I clicked on Custom Domain Names on left menu and filled out the details. Make sure that your subdomain matches the one the certificate was generated for.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-09-create-custom-domain.png" alt=""></p>

<p>I assigned /test path to the test stage I had created earlier. I will use root path for the production stage when I deploy the final version.</p>

<p>After creating the custom domain, take note of Target Domain Name generated by AWS.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-10-target-domain-name.png" alt=""></p>

<h2 id="step-6-create-a-record-in-route-53">Step 6: Create A Record in Route 53</h2>

<p>I had to also point DNS to the domain generated by API Gateway.</p>

<p>Since I was using a regional endpoint I had to map the custom domain name to the target domain name mentioned in the previous step.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-11-add-a-record-to-route-53-error.png" alt=""></p>

<p>Now the problem was when I tried to do it via AWS Management Console, it failed as explained in this <a href="https://stackoverflow.com/questions/47827670/understanding-aws-api-gateway-custom-domain-names" target="_blank" rel="noopener noreferrer">StackOverflow answer</a>.</p>

<p>So I had to do it via CLI as below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws route53 change-resource-record-sets --hosted-zone-id {ZONE_ID_OF_MY_DOMAIN} --change-batch file://changedns.json
</code></pre></div></div>

<p>whereas the contents of changedns.json were</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"Changes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CREATE"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"ResourceRecordSet"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"Name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"api.hmdb.myvirtualhome.net"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"AliasTarget"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="s2">"DNSName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"d-xyz.execute-api.eu-west-2.amazonaws.com"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"HostedZoneId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ZJ5UAJN8Y3Z2Q"</span><span class="p">,</span><span class="w">
          </span><span class="s2">"EvaluateTargetHealth"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>In the JSON above, DNSName is the Target Domain Name created by AWS is Step 5. The HostedZoneId (ZJ5UAJN8Y3Z2Q), on the other hand, is the zone ID of API Gateway which is listed <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#apigateway_region" target="_blank" rel="noopener noreferrer">here</a>.</p>

<h3 id="update">UPDATE</h3>
<p>If you are having issues running the command above that might mean you don’t have a default profile setup which has permissions to change DNS settings. To fix that:</p>

<h4 id="1-create-a-new-user-with-no-permissions">1. Create a new user with no permissions</h4>

<p>Go to IAM console and create a new user. Skip all the steps and download the credentials as .csv in the last step.</p>

<h4 id="2-assign-required-permissions">2. Assign required permissions</h4>
<p>Create a new policy using the JSON template below and attach it to the new user</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="s2">"Sid"</span><span class="p">:</span><span class="w"> </span><span class="s2">"VisualEditor0"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"route53:ChangeResourceRecordSets"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"Resource"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arn:aws:route53:::hostedzone/{ZONE ID OF YOUR DOMAIN}"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h4 id="3-create-a-new-profile-for-the-user">3. Create a new profile for the user</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws configure --profile temp-route53-profile
</code></pre></div></div>

<p>and set the Access/Secret keys along with the region of your hosted zone.</p>

<p>Then you run the first CLI command with providing profile name:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aws route53 change-resource-record-sets --hosted-zone-id {ZONE_ID_OF_MY_DOMAIN} --change-batch file://changedns.json --profile temp-route53-profile
</code></pre></div></div>

<p>An important point here is to get your hosted zone ID from Route53. In the API Gateway, it shows a hosted zone ID which is actually AWS API Gateway zone ID. We use that zone ID in our DNS configuration (which is in changedns.json file in this example) but when we provide the hosted zone ID on the command line we provide our domain ID which can be found in Route53.</p>

<h2 id="step-7-test">Step 7: Test</h2>
<p>So after creating the alias for my API I visited the URL on a browser and I was able to get the green padlock indicating that it loaded the correct SSL certificate.</p>

<p><img src="/images/vpblogimg/2018/05/api-gateway-custom-domain-12-success.png" alt=""></p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-basic-concept.html" target="_blank" rel="noopener noreferrer">Amazon API Gateway Concepts</a></li>
  <li><a href="https://aws.amazon.com/about-aws/whats-new/2017/11/amazon-api-gateway-supports-regional-api-endpoints/" target="_blank" rel="noopener noreferrer">Amazon API Gateway Supports Regional API Endpoints</a></li>
  <li><a href="https://docs.aws.amazon.com/apigateway/latest/developerguide/how-to-custom-domains.html" target="_blank" rel="noopener noreferrer">Set up Custom Domain Name for an API in API Gateway</a></li>
  <li><a href="https://stackoverflow.com/questions/47827670/understanding-aws-api-gateway-custom-domain-names" target="_blank" rel="noopener noreferrer">StackOverflow answer: Understanding AWS API Gateway Custom Domain Names
</a></li>
  <li><a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#apigateway_region" target="_blank" rel="noopener noreferrer">AWS Regions and Endpoints</a></li>
  <li><a href="http://blog.ryangreen.ca/2017/11/03/api-gateway-regional-vs-edge-optimized-endpoints/" target="_blank" rel="noopener noreferrer">API Gateway Regional vs. Edge-Optimized Endpoints</a></li>
  <li><a href="https://docs.aws.amazon.com/powershell/latest/userguide/pstools-getting-set-up-linux-mac.html" target="_blank" rel="noopener noreferrer">Setting up the AWS Tools for PowerShell Core on Linux or macOS X</a></li>
  <li><a href="https://docs.aws.amazon.com/powershell/latest/reference/" target="_blank" rel="noopener noreferrer">AWS Tools for PowerShell Cmdlet Reference</a></li>
  <li><a href="https://docs.aws.amazon.com/apigateway/api-reference/" target="_blank" rel="noopener noreferrer">Amazon API Gateway REST API</a></li>
</ul>

		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/13" class="prev">Prev</a>
    
    
        <a href="/page/15" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2021 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
