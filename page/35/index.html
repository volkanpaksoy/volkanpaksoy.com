<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/35/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3V7V2XX9Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y3V7V2XX9Q');
</script>

<!-- <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'G-Y3V7V2XX9Q']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script> -->



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="volkanpaksoy" data-color="#005050" data-emoji="" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>

<div id="ezoic-pub-ad-placeholder-102">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <!-- vp.com - default -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/01/02/enter-fsharp/" itemprop="url">Enter F#</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-01-02T22:30:00+00:00" itemprop="datePublished">January  2, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">fsharp</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>I’m not a big fan of New Year’s resolutions. I was meaning to start learning F# and since it’s the new year’s 2nd day it might a good time to finally give it a shot!</p>

<h3 id="where-to-start">Where to start</h3>
<p>It’s always hard to find the best resource when you are starting. Some time ago I heard about a Microsoft Research project called TryFSharp.org. It’s a tutorial website geared towards the absolute beginners. It comes with a REPL editor so no extra tools are needed to start.</p>

<p>From now on I’m planning to spend 2 pomodoros (around 1 hour) every day to learn F#. After my first 2 pomodoros I completed the first 3 sections and below are my notes for today’s training.</p>

<h3 id="lecture-notes">Lecture Notes</h3>

<ul>
  <li>
<strong>let</strong> keyword to bind names to values. These bindings are <em>immutable</em>. If you try to assign a value to a same name twice you get the following error:</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">duplicated</span> <span class="p">=</span> <span class="s2">"original value"</span>
<span class="k">let</span> <span class="n">duplicated</span> <span class="p">=</span> <span class="s2">"new value"</span>
</code></pre></div></div>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<p>causes the following error:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>stdin(8,5): error FS0037: Duplicate definition of value 'duplicated'
</code></pre></div></div>

<ul>
  <li>Mutable variables can be created by explicitly specifiying <strong>mutable</strong> keyword but it should be used cautiously.</li>
  <li>F# is a statically typed language like C#</li>
  <li>
<strong>printfn</strong> can be used to display messages. Strings can be formatted by using special characters such %d for int, %s for string such as</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">printfn</span> <span class="s2">"The answer is %d"</span> <span class="mi">42</span>
</code></pre></div></div>

<ul>
  <li>let can also be used bind a name to a function. The following code</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">square</span> <span class="n">x</span> <span class="p">=</span>
    <span class="n">x</span> <span class="p">*</span> <span class="n">x</span>

<span class="n">square</span> <span class="mi">4</span>
</code></pre></div></div>

<p>produces this result in the output window:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; let square x =
      x * x
  
  square 4

val square : x:int -&gt; int
val it : int = 16

&gt; 
</code></pre></div></div>

<ul>
  <li>F# is whitespace-sensitive. In the function above the body of the function was denoted by indenting it 4 spaces and return values is the last line of the function.</li>
  <li>In times when F# cannot determine the type on itw own, it can specified explicitly bu using type annotations. For example:</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">toLeetSpeak</span> <span class="p">(</span><span class="n">phrase</span><span class="p">:</span><span class="kt">string</span><span class="p">)</span> <span class="p">=</span>
    <span class="n">phrase</span><span class="p">.</span><span class="nc">Replace</span><span class="p">(</span><span class="k">'</span><span class="n">t'</span><span class="p">,</span> <span class="k">'</span><span class="mi">7</span><span class="k">'</span><span class="o">).</span><span class="nc">Replace</span><span class="p">(</span><span class="k">'</span><span class="n">o'</span><span class="p">,</span> <span class="k">'</span><span class="mi">0</span><span class="k">'</span><span class="p">)</span>

<span class="n">toLeetSpeak</span> <span class="s2">"root"</span>
</code></pre></div></div>

<p>In the example above it needs to be specified that phrase if of type string before String.Replace method can be called.</p>

<ul>
  <li>Functions can be defined inside other functions:</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">quadruple</span> <span class="n">x</span> <span class="p">=</span>    
    <span class="k">let</span> <span class="n">double</span> <span class="n">x</span> <span class="p">=</span>
        <span class="n">x</span> <span class="p">*</span> <span class="mi">2</span>

    <span class="n">double</span><span class="p">(</span><span class="n">double</span><span class="p">(</span><span class="n">x</span><span class="o">))</span>
</code></pre></div></div>

<ul>
  <li>A function can be used as an argument to another function to create what’s called a <strong>higher order function</strong>.</li>
  <li>Inline functions can be created such as</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">square</span> <span class="p">=</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="p">*</span> <span class="n">x</span><span class="p">)</span>
</code></pre></div></div>

<p>Theres are called <strong>lambda functions</strong> or <strong>lambdas</strong>.</p>

<ul>
  <li>Lists can be created by semi-colon separated single values or a range values with .. in between such as</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">evens</span> <span class="p">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">;</span> <span class="mi">4</span><span class="p">;</span> <span class="mi">6</span><span class="p">;</span> <span class="mi">8</span><span class="p">]</span>
<span class="k">let</span> <span class="n">firstHundred</span> <span class="p">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
</code></pre></div></div>

<ul>
  <li>Higher-order functions can be combined with other functions such as</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">let</span> <span class="n">firstHundred</span> <span class="p">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
<span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="p">*</span> <span class="mi">2</span><span class="p">)</span> 
    <span class="p">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">firstHundred</span><span class="p">)</span>
</code></pre></div></div>

<p>which produces the following output</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>val it : int list =
  [0; 4; 8; 12; 16; 20; 24; 28; 32; 36; 40; 44; 48; 52; 56; 60; 64; 68; 72; 76;
   80; 84; 88; 92; 96; 100; 104; 108; 112; 116; 120; 124; 128; 132; 136; 140;
   144; 148; 152; 156; 160; 164; 168; 172; 176; 180; 184; 188; 192; 196; 200]
</code></pre></div></div>

<p>It first filters the odd numbers out of <em>firstHundred</em> list and send the result to map function to double all the values.</p>

<ul>
  <li>Forward-pipe operator can be used to make the code easier to read when functions are chained:</li>
</ul>

<div class="language-fsharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">100</span><span class="p">]</span>
<span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">2</span> <span class="p">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="p">(</span><span class="k">fun</span> <span class="n">x</span> <span class="p">-&gt;</span> <span class="n">x</span> <span class="p">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">sum</span>
</code></pre></div></div>

<ul>
  <li>Array indexing is zero-based.</li>
</ul>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://TryFSharp.org" target="_blank" rel="noopener noreferrer">TryFSharp.org website</a></li>
  <li><a href="http://fsharpshow.com/" target="_blank" rel="noopener noreferrer">The F# Show Podcast</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2014/12/15/simple-ids-with-nmap/" itemprop="url">Simple IDS with Nmap</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2014-12-15T22:45:00+00:00" itemprop="datePublished">December 15, 2014</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/securityawsdev">security</a></span> -->

<!-- security, aws, dev -->




    <a href="/category/security">security</a>
    , 

    <a href="/category/aws">aws</a>
    , 

    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">network, raspberry_pi, nmap</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>One of the Nmap’s many usages is for asset management as it is very good at discovering devices in a network. I’m going to use it to develop a simple IDS (Intrusion Detection System). Of course IDS software is much more complex and I hope I will look into installing a proper one, like <a href="https://www.snort.org/" target="_blank" rel="noopener noreferrer">Snort</a>, when I have the time but for now I’ll just roll out my own. My goals in this project are:</p>

<ol>
  <li>Utilise the idle old Raspberry Pi: I used one to <a href="https://volkanpaksoy.com/archive/2014/11/19/media-centre-raspberry-pi/">build a media server</a> another one as a <a href="https://volkanpaksoy.com/archive/2014/12/12/homebrew-security-camera-with-raspberry-pi/">security camera</a>. The 3rd one is one of the first releases. It has 256MB memory and failed to run various projects I tried in the past. Looks like it’s at least good enough to run Nmap so it may have a use after all.</li>
  <li>Practice more Powershell and discover XML parsing capabilities.</li>
  <li>Writing a Python version of the same script so that everything can run on Pi but I’ll defer that to a later date.</li>
</ol>

<h3 id="basics">Basics</h3>
<p>So like every Raspberry Pi project, first step is to download a distro suitable for Raspberry Pi and write to an SD/miroSD card. There is a Pi version of the (in)famous security distro Kali Linux. It’s convenient as it comes with all security tools pre-installed but for my purposes I just used a plain <a href="http://www.raspberrypi.org/downloads/" target="_blank" rel="noopener noreferrer">Raspbian</a> as I only need Nmap.</p>

<p>Nmap that is installed from Linux repositories was a bit outdated (v6.00) so I decided to download the latest version (v6.47) and build it from source. Even though all I need is a simple command I like to keep my tools current!</p>

<h3 id="how-does-it-work">How Does It Work</h3>
<p>I placed the Pi near the switch so that it can use Ethernet. It gets results much faster so I recommend wired over wireless. So the initial version will work like this:</p>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<ol>
  <li>A cron job runs on Pi every n minutes. Executes Nmap and uploads the results in XML format to AWS S3.</li>
  <li>A scheduled task runs on a Windows Server running Powershell. It gets the latest XML from S3 and gets the active hosts on the network.</li>
  <li>Compares the results to a device list and sends a notification if an intruder is detected.</li>
</ol>

<p>Of course in order this to work first I need to assign static IPs to all my devices and record these addresses along with MAC addresses in the configuration.</p>

<h3 id="lets-get-cracking">Let’s get cracking!</h3>

<p>I covered Nmap basics <a href="https://volkanpaksoy.com/archive/2014/12/13/nmap-basics/">here</a>. In this project all I need is host discovery so I’m not interested in the services, machine names, operating systems etc. I’ll just run this command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo nmap -sn 172.16.1.0/24 -oX output.xml
</code></pre></div></div>

<p>Also I need my old friend s3cmd so I ran this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo apt-get install s3cmd
</code></pre></div></div>

<p>Then</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s3cmd --configure
</code></pre></div></div>

<p>and entered the credentials for the new IAM user I created who has access only to a single S3 bucket.</p>

<p>So to put it together in a shell script I created the simple script below.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

echo "Running Nmap"
sudo nmap -sn 172.16.1.0/24 -oX /home/pi/output.xml

timestamp=$(date +%Y%m%d_%H%M%S)
s3FileName=nmap_output_$timestamp.xml

echo "Uploading the output to S3"
sudo s3cmd put /home/pi/output.xml s3://{BUCKET}/$s3FileName

sudo rm /home/pi/output.xml
</code></pre></div></div>

<p>Also to make the script executable so I ran this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chmod 755 my_script
</code></pre></div></div>

<h3 id="analyze-and-alert">Analyze and alert</h3>
<p>So now I have a list of devices running on the network. The Nmap XML output looks something like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0"?&gt;</span>
<span class="cp">&lt;?xml-stylesheet href="file:///usr/bin/../share/nmap/nmap.xsl" type="text/xsl"?&gt;</span>
<span class="c">&lt;!-- Nmap 6.47 scan initiated Mon Dec 15 13:30:01 2014 as: nmap -sn -oX /home/pi/output.xml 172.16.1.0/24 --&gt;</span>
<span class="nt">&lt;nmaprun</span> <span class="na">scanner=</span><span class="s">"nmap"</span> <span class="na">args=</span><span class="s">"nmap -sn -oX /home/pi/output.xml 172.16.1.0/24"</span> <span class="na">start=</span><span class="s">"1418650201"</span> <span class="na">startstr=</span><span class="s">"Mon Dec 15 13:30:01 2014"</span> <span class="na">version=</span><span class="s">"6.47"</span> <span class="na">xmloutputversion=</span><span class="s">"1.04"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;verbose</span> <span class="na">level=</span><span class="s">"0"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;debugging</span> <span class="na">level=</span><span class="s">"0"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;host&gt;</span>
    <span class="nt">&lt;status</span> <span class="na">state=</span><span class="s">"up"</span> <span class="na">reason=</span><span class="s">"arp-response"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;address</span> <span class="na">addr=</span><span class="s">"172.16.1.10"</span> <span class="na">addrtype=</span><span class="s">"ipv4"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;address</span> <span class="na">addr=</span><span class="s">"AA:BB:CC:DD:EE:FF"</span> <span class="na">addrtype=</span><span class="s">"mac"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;hostnames&gt;</span>
    <span class="nt">&lt;/hostnames&gt;</span>
    <span class="nt">&lt;times</span> <span class="na">srtt=</span><span class="s">"1142"</span> <span class="na">rttvar=</span><span class="s">"5000"</span> <span class="na">to=</span><span class="s">"100000"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/host&gt;</span>
  <span class="nt">&lt;runstats&gt;</span>
    <span class="nt">&lt;finished</span> <span class="na">time=</span><span class="s">"1418650208"</span> <span class="na">timestr=</span><span class="s">"Mon Dec 15 13:30:08 2014"</span> <span class="na">elapsed=</span><span class="s">"6.40"</span> <span class="na">summary=</span><span class="s">"Nmap done at Mon Dec 15 13:30:08 2014; 256 IP addresses (11 hosts up) scanned in 6.40 seconds"</span> <span class="na">exit=</span><span class="s">"success"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;hosts</span> <span class="na">up=</span><span class="s">"11"</span> <span class="na">down=</span><span class="s">"245"</span> <span class="na">total=</span><span class="s">"256"</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/runstats&gt;</span>
<span class="nt">&lt;/nmaprun&gt;</span>
</code></pre></div></div>

<p>And my configuration file looks like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;assetList&gt;</span>
  <span class="nt">&lt;host</span> <span class="na">name=</span><span class="s">"Dev"</span> <span class="na">ip=</span><span class="s">"172.16.1.10"</span> <span class="na">mac=</span><span class="s">"12:12:12:12:12:12"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;host</span> <span class="na">name=</span><span class="s">"Raspberry Pi XBMC"</span> <span class="na">ip=</span><span class="s">"172.16.1.11"</span> <span class="na">mac=</span><span class="s">"AA:AA:AA:AA:AA:AA"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;host</span> <span class="na">name=</span><span class="s">"Printer"</span> <span class="na">ip=</span><span class="s">"172.16.1.12"</span> <span class="na">mac=</span><span class="s">"BB:BB:BB:BB:BB:BB"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;host</span> <span class="na">name=</span><span class="s">"iPad"</span> <span class="na">ip=</span><span class="s">"172.16.1.13"</span> <span class="na">mac=</span><span class="s">"CC:CC:CC:CC:CC:CC"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/assetList&gt;</span>
</code></pre></div></div>

<p>A gem I discovered about Powershell is the Powershell ISE (Integrated Shell Environment). It supports IntelliSense-type discovery so makes it much easier and faster to write and run scripts.</p>

<p><img src="/images/vpblogimg/2014/12/powershell-ise.png" alt="Powershell ISE"></p>

<h3 id="into-the-powershell">Into the Powershell</h3>
<p>The script does the following</p>

<ol>
  <li>Load the configuration</li>
  <li>Get the latest asset list from S3 and load</li>
  <li>Compare and see if there are any unknown devices on the network</li>
  <li>If there is send an email notification</li>
</ol>

<p>Since Powershell is based on .NET framework, working with XML is nothing new. I just used standard XPath queries to match the MAC and IP addresses of the discovered devices to the ones I entered to the configuration file.</p>

<p>Here’s the script:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/0caef92a4562d17b404d37c8b0445902.js"> </script>

<h3 id="time-for-some-action">Time for some action</h3>
<p>OK let’s see how we are doing now. After I recorded all the known devices the output of the script was like below:</p>

<p><img src="/images/vpblogimg/2014/12/powershell-script-output-no-alarm.png" alt="Script output"></p>

<p>One interesting thing to note is Nmap cannot discover its own MAC address. I guess that’s because as it’s using ARP protocol to resolve MAC addresses on the local subnet and it doesn’t have its own MAC in its ARP table it cannot find it. I decided to skip the entry but may be a better choice to compare only the IP address if this is the case.
Anyway, I will leave it as is for now.</p>

<p>To test it I turned on my old phone and connected to the network. Within 10 minutes I received the following notification email:</p>

<p><img src="/images/vpblogimg/2014/12/powershell-new-device-alert.png" alt=""></p>

<p>So far so good!</p>

<h3 id="conclusion">Conclusion</h3>
<p>I would never trust such a thing as the ultimate defence mechanism but even so I believe it may come in handy in some situations. More importantly this was a fun little project for me as it involved bash scripting, Powershell, AWS and XML. I’m glad I finally came up with a use for the idle Raspberry Pi also happy to discover Powershell ISE.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://www.alexrams.com/blog/2014/10/11/install-latest-version-nmap-ubuntu-12-04/" target="_blank" rel="noopener noreferrer">Installing Nmap from source</a></li>
  <li><a href="http://technet.microsoft.com/en-us/library/dd315244.aspx" target="_blank" rel="noopener noreferrer">Introducing the Windows PowerShell ISE</a></li>
  <li><a href="https://www.kali.org/tag/raspberry-pi/" target="_blank" rel="noopener noreferrer">Kali Linux for Raspberry Pi</a></li>
  <li><a href="http://zxq9.com/archives/795" target="_blank" rel="noopener noreferrer">Most common Bash date commands for timestamping</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2014/12/13/nmap-basics/" itemprop="url">Nmap Basics</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2014-12-13T20:00:00+00:00" itemprop="datePublished">December 13, 2014</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/security">security</a></span> -->

<!-- security -->




    <a href="/category/security">security</a>
    
</span>
	<span class="tags">network, nmap</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<h3 id="what-is-nmap">What is Nmap?</h3>
<p>Nmap (Network Mapper) is a powerful network scanner that lets you discover the hosts and services on a network. It sends specific packets to remote hosts and analyses the responses to map the network. These packets can be standard ICMP/TCP/UDP packets as well as deliberately malformed packets to observe the hosts’ behaviour.</p>

<p>I believe it is very important to keep an eye on what’s going on in your network. As Nmap is one of the basic tools for this kind of job, I decided to spend some time to cover it and harness it in my own projects.</p>

<h3 id="specifying-target">Specifying Target</h3>
<p>First you need to specify your targets. Nmap is very flexible and accepts different notations for specifying targets:</p>

<ul>
  <li>
<strong>Single IP:</strong> i.e. 192.168.1.15</li>
  <li>
<strong>Name:</strong> i.e: www.google.com</li>
  <li>
<strong>List:</strong> For example, 192.168.1,2.1,10 will scan 192.168.1.1, 192.168.1.10, 192.168.2.1 and 192.168.2.10. Note that the comma separated values are not ranges but single values</li>
  <li>
<strong>Range:</strong> i.e: 192.168.1.1-10 For ranges hyphen is used as the separator. The start and end values are inclusive. Also one octet can be omitted such as 192.168.-.1. In this case Nmap will scan all IPs from 192.168.0.1 to 192.168.255.1</li>
  <li>
<strong>CIDR (Classless Inter-Domain Routing):</strong> For example 192.168.1.240/29 will scan 8 IPs from 192.168.1.240 to 192.168.1.247</li>
</ul>

<p>You can use any combinations of these values as a list separated with spaces such as: 192.168.1.42 www.google.com will scan the single LAN IP and Google. You can use <strong>-sL</strong> parameter to view the target list without scanning them.</p>

<p><img src="/images/vpblogimg/2014/12/nmap-list-hosts.png" alt="Nmap list hosts"></p>

<p>In complex scenarios you can use an input file to load the target list by using the <strong>-iL</strong> flag and providing the file name.</p>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<p>To exclude specific IP addresses <strong>–exclude</strong> flag is used with the same notations.</p>

<h3 id="port-scanning">Port Scanning</h3>
<p>Ports can be specified in 2 ways:</p>

<ul>
  <li>Using -p flag: Single value, comma-separated list, or hyphen-separated values as a range. If just hyphen is specified it scans all ports from 1 to 65535. Also protocol can be specified such as T:80 U:53</li>
  <li>Using nmap-services file: You can refer to a service by name and this file is used to look it up.</li>
</ul>

<p>Both methods can be used in combinations such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -p http*,25,U:53 192.168.1.15
</code></pre></div></div>

<h3 id="output">Output</h3>
<p>While a scan is running you can an updated status by hitting enter. Also you can save the output results to a file in different formats with the values below following the <strong>-o</strong> flag:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>* N: Normal
* X: XML
* G: Grepable
</code></pre></div></div>

<p>such as</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -v 172.16.1.0/24 -oG output.gnmap
</code></pre></div></div>

<p>Also a helpful flag is <strong>-v</strong> for verbose output</p>

<p>An added bonus about using output files is that you can resume a scan by using the <strong>–resume</strong> flag and specifying the output file name such as</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap --resume output.gnmap
</code></pre></div></div>

<h3 id="basic-scanning-options">Basic scanning options</h3>
<ul>
  <li>
    <p><strong>TCP SYN scan (-sS):</strong> This is the default option Nmap uses. It’s very fast and can scan thousands of ports per second. It sends a SYN packet to target and if the port is open target sends back a SYN/ACK packet. Thus far it’s just like a normal 3-way TCP handshake but in the final step instead of sending an ACK Nmap sends RST (Reset) packet and cancels the process. Since it has already acquired the information it’s looking for it doesn’t need to establish an actual connection. If the port is closed the target sends a RST packet. SYN scan is very powerful because it’s fast and quiet as it doesn’t create a session. on Linux, it requires root privileges to run it.</p>
  </li>
  <li>
    <p><strong>TCP connect() Scan (-sT):</strong> This one uses a full handshake and opens a session. Then sends a RST packet to close the session. The advantage of this method over SYN scan is that it doesn’t require root privileges. As it opens sessions they are logged so it’s noisies than SYN scan.</p>
  </li>
  <li>
    <p><strong>Ping scan (-sn formerly known as -sP):</strong> This is the quickest scan method.For local subnets it uses ARP (Address Resolution Protocol) to identify active hosts. ARP only works on local subnets so for remote subnets, it uses ICMP echo requests. It also sends a TCP ACK packet to port 80 which is completely unexpected for the host as it’s just sent out of the blue. So the host sends a RST packet to end connection (as it’s the right thing to do!) but that helps Nmap to identify there is a host up with that address. This scan is only helpful to identify hosts rather than ports and services.</p>
  </li>
  <li>
    <p><strong>UDP scan (-sU):</strong> This is the only scan that can identify open UDP ports. Since there’s no handshake the overhead is lower compared to TCP scan. When a port is closed the target returns ICMP port unreachable packet so this may increase the number of packets. Like SYN scan it requires privileged access.</p>
  </li>
</ul>

<p>In total there are lots of scanning options. You can find the full list <a href="http://nmap.org/book/man-port-scanning-techniques.html" target="_blank" rel="noopener noreferrer">here</a></p>

<h3 id="os-and-service-version-detection">OS and Service Version Detection</h3>
<p>To detect version <strong>-sV</strong> flag is used. An intensity level between 0-9 can be specified. Default is 7</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -sV --version-intensity 9 172.16.1.10
</code></pre></div></div>

<p>Versioning can be useful in some cases but also significantly increases the scan time.</p>

<p>For operating system detection <strong>-O</strong> flag can be used</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	nmap -O -v 172.16.1.10
</code></pre></div></div>

<p><img src="/images/vpblogimg/2014/12/nmap-os-detection.png" alt="Nmap OS detection"></p>

<h3 id="timing-categories">Timing Categories</h3>
<p>If you are concerned about being detected when scanning the network</p>

<ol>
  <li>You might be doing something nasty!</li>
  <li>You might consider using timing categories so add some delay between each packets to evade IDSs</li>
</ol>

<p>There are 6 categories that can be specified by T flag followed by a number from 0 to 5. Alternatively you can use the templates’ names:</p>

<ul>
  <li>paranoid (0)</li>
  <li>sneaky (1)</li>
  <li>polite (2)</li>
  <li>normal (3)</li>
  <li>aggressive (4)</li>
  <li>insane (5)</li>
</ul>

<p>With “Paranoid” template Nmap will wait 5 minutes between each probe making the total scan time very very long. “Insane” will speed up the process to a point that the delay is down to 5ms. So be careful which option you use. There are many more flags for tailoring the scans to your performance requirements: <a href="http://nmap.org/book/man-performance.html" target="_blank" rel="noopener noreferrer">http://nmap.org/book/man-performance.html</a></p>

<h3 id="scripting-engine">Scripting engine</h3>
<p>Nmap comes with an embedded Lua interpreter which is the core of its scripting engine.</p>

<p>By using <strong>-sC</strong> flag all scripts in the default category can be executed such as</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -sC -p www.google.com
</code></pre></div></div>

<p><img src="/images/vpblogimg/2014/12/nmap-script-output.png" alt="Nmap script output"></p>

<p>There are lots of scripts which can be found at <a href="http://nmap.org/nsedoc" target="_blank" rel="noopener noreferrer">NSE(Nmap Scripting Engine) documentation page</a></p>

<p>For example there is a script to scan OpenSSL Heartbleed vulnerability. It can be executed as follows:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nmap -p 443 --script ssl-heartbleed &lt;target&gt;
</code></pre></div></div>

<p>On my machine this script was blocked by Norton!</p>

<p><img src="/images/vpblogimg/2014/12/nmap-script-attack.png" alt="Norton attack block"></p>

<p>So be careful which script to run. Your intentions may be misinterpreted if you are running them against systems that you are not authorized.</p>

<h3 id="conclusion">Conclusion</h3>
<p>Nmap is one of the core tools that hackers (white or black hat) use. So it has many more options geared towards attacking and being stealthy. You can spoof your IP address, use idle stations to avoid detection etc. I left out many of those options as my intention for studying Nmap is discovering devices on my network so that I can take action if any unknown devices appear. Based on these notes I will develop a simple script/applicaton to find out if anything fishy is going on in my network. I’ll blog about it when it’s ready. Stay tuned!</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://nmap.org/book/man.html" target="_blank" rel="noopener noreferrer">Nmap documentation</a></li>
  <li><a href="http://nmap.org/nsedoc" target="_blank" rel="noopener noreferrer">Scripting engine documentation</a></li>
  <li><a href="https://www.youtube.com/watch?v=Hk-21p2m8YY" target="_blank" rel="noopener noreferrer">DEFCON 16: Nmap: Scanning the Internet by Fyodor</a></li>
</ul>


		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/34" class="prev">Prev</a>
    
    
        <a href="/page/36" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2022 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
