<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/2/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3V7V2XX9Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y3V7V2XX9Q');
</script>

<!-- <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'G-Y3V7V2XX9Q']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script> -->



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<!-- <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="volkanpaksoy" data-color="#005050" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" ></script> -->

<a href="https://www.buymeacoffee.com/volkanpaksoy" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-green.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a>

<div id="ezoic-pub-ad-placeholder-102">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <!-- vp.com - default -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2019/12/05/Using-Audio-in-Docker-Container/" itemprop="url">Using Audio in Docker Container</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2019-12-05T06:00:00+00:00" itemprop="datePublished">December  5, 2019</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dockerdev">docker</a></span> -->

<!-- docker, dev -->




    <a href="/category/docker">docker</a>
    , 

    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">audio</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post I’m going to show an example of playing audio in a Docker container.</p>

<h2 id="test-environment-setup">Test Environment Setup</h2>
<p>I’m going to use dotnet core 3.1 runtime image:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker pull mcr.microsoft.com/dotnet/core/runtime:3.1
</code></pre></div></div>

<p>Here’s my Dockerfile:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM mcr.microsoft.com/dotnet/core/runtime:3.1

RUN apt-get update -y

RUN apt-get install mpg123 -y
RUN apt-get install wget -y

COPY ./play-audio.sh .
RUN chmod +x ./play-audio.sh

ENTRYPOINT ["/play-audio.sh"]
</code></pre></div></div>

<p>and the script (play-audio.sh) that plays the audio looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

url=$1
filename="${url##*/}"

if [ ! -f $filename ]; then
    echo "File doesn't exist. Downloading."
    wget $url
fi

# check if the audio player program exists. helpful to test the script individually on macOS
if hash mpg123 2&gt;/dev/null; then
    echo "Playing file using mpg123"
    mpg123 $filename
elif hash afplay 2&gt;/dev/null; then
    echo "Playing file using afplay"
    afplay $filename
else 
    echo "No player could be found."    
fi
</code></pre></div></div>

<p>I built the image with the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker build -t audio-test .
</code></pre></div></div>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<h2 id="testing-the-audio">Testing the audio</h2>
<p>Initially I rana container like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run audio-test https://file-examples.com/wp-content/uploads/2017/11/file_example_MP3_5MG.mp3
</code></pre></div></div>

<p>After running the container like this I got the error shown below:</p>

<p><img src="/images/vpblogimg/2019/12/audio-in-docker/error-while-running-audio.png" alt=""></p>

<h2 id="solution">Solution</h2>
<p>The trick is ro run with the following parameter:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--device /dev/snd
</code></pre></div></div>

<p>So the full Docker run command looks like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker run --rm --device /dev/snd audio-test https://file-examples.com/wp-content/uploads/2017/11/file_example_MP3_5MG.mp3
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>
<p>This was a long-winded setup for a very short solution but I enjoyed practicing with Bash scripting and Docker.</p>

<p>Unfortunately this solution works on Raspberry Pi only and not on Mac. Every resource I found points to installing Pulse Audio Server on macOS and Pulse Audio client in the Docker image. I haven’t tried it yet as it was beyond the scope of my requirements but I might need to implement it later in which case I will post about it.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://stackoverflow.com/questions/41083436/how-to-play-sound-in-a-docker-container" target="_blank" rel="noopener noreferrer">How to play sound in a docker container</a></li>
  <li><a href="https://stackoverflow.com/questions/40136606/how-to-expose-audio-from-docker-container-to-a-mac" target="_blank" rel="noopener noreferrer">How to expose audio from Docker container to a Mac?</a></li>
  <li><a href="https://devops.datenkollektiv.de/running-a-docker-soundbox-on-mac.html" target="_blank" rel="noopener noreferrer">Running a Docker Soundbox on Mac</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2019/11/06/Continuous-Integration-with-CodeBuild/" itemprop="url">Continuous Integration with CodeBuild</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2019-11-06T02:00:00+00:00" itemprop="datePublished">November  6, 2019</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devopsaws">devops</a></span> -->

<!-- devops, aws -->




    <a href="/category/devops">devops</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">github, codebuild, continuous_integration, ci</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>In this post, I’d like to show how to achieve continuous integration using CodeBuild service.</p>

<p>Main goals to achieve:</p>

<ul>
  <li>Run unit tests in a Docker container</li>
  <li>Kick off build automatically when code is pushed</li>
  <li>Show build status</li>
  <li>Send notifications when tests fail</li>
</ul>

<h2 id="codebuild-setup">Codebuild Setup</h2>

<h3 id="step-01-project-configuration">Step 01: Project Configuration</h3>
<p>Specify a unique name and make sure to tick “Enable build badge” checkbox</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/project-configuration.png" alt=""></p>

<h3 id="step-02-source-selection">Step 02: Source Selection</h3>
<p>In this step select GitHub as source provider and select “Repository in my GitHub account” option. AWS will use OAuth and redirect to GitHub to ask for authoization to access your repositories. After granting access you should be able to see your repositories in the dropdown list:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/select-source.png" alt=""></p>

<p>I left “Source version” field blank as I want the build to run for all branches and for all commits.</p>

<h3 id="step-03-webhook-configuration">Step 03: Webhook Configuration</h3>
<p>Tick the “Rebuild every time a code change is pushed to this repository” checkbox and select PUSH from the event type list. You can select more events to trigger builds for CI purposes it should be enough to run after every time code is pushed.</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/webhook-configuration.png" alt=""></p>

<p>What this does is add a CodeBuild webhook in GitHub that looks like this:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/webhook-in-github.png" alt=""></p>

<p>Whenever a push happens in the repository, GitHub posts the details to CodeBuild webhook and that triggers a build.</p>

<h3 id="step-04-environment-configuration">Step 04: Environment configuration</h3>
<p>The build takes place in a Docker container so we have to provide a Docker image with build tools installed. Alternatively we can use one of the managed images that AWS provides. In this example I’ll use a managed image:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/environment-configuration.png" alt=""></p>

<h3 id="step-05-other-configuration">Step 05: Other configuration</h3>
<p>In this example, I will accept the defaults for the rest of the settings because I don’t need to generate artifacts to run unit tests. It’s generally wise to enable CloudWatch logs so that you can monitor the build process closely. Since I accept the default path for buildspec.yml, I have to place it at the root of the repository.</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/buildspec-artifacts-logs-configuration.png" alt=""></p>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<h2 id="running-the-tests">Running the tests</h2>
<p>The core responsibility of CI pipeline is to run the unit tests. CodeBuild is a generic service and it doesn’t come with any tools to run unit tests as it’s application and environment dependent. The way we configure is by using buildspec.yml file. In this example I’m running a dotnet core project and making sure the unit tests are run first is as easy as this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>version: 0.2

phases:
  install:
    runtime-versions:
        dotnet: 2.2
  build:
    commands:
      - dotnet restore
      - dotnet test
      - dotnet publish Sample.UI.Web -c Release -o ./output
</code></pre></div></div>

<p>This way CodeBuild will execute the steps above and all the unit tests in the solution will be run.</p>

<h2 id="run-build-automatically">Run build automatically</h2>
<p>Now that the GitHub repository and CodeBuild projects are both ready, let’s see if we can kick off a build by pushing some code changes:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/auto-build-after-commit-1.png" alt=""></p>

<p>Also after pushing code to a feature branch I was able to see that build was triggered.</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/auto-build-after-commit-2.png" alt=""></p>

<p>So now I could confirm running the build automatically.</p>

<p>As a side note, the failed ones were failing due to this error</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>YAML_FILE_ERROR: This build image requires selecting at least one runtime version.
</code></pre></div></div>

<p>The solution was to specify the runtime in the buildspec.yml file explicitly by adding this bit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>install:
  runtime-versions:
      dotnet: 2.2
</code></pre></div></div>

<p>Also it’s worth noting that the source version value in Codebuild corresponds to commit hash. For example the commit hash shown below</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/commit-id-on-github.png" alt=""></p>

<p>appears on CodeBuild as</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/commit-id-on-codebuild.png" alt=""></p>

<h2 id="showing-build-status">Showing build status</h2>
<p>Showing the build status on GitHub repository is very easy. We already enabled build badge while creating the build project. Now we have to copy the badge URL as shown below:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/copy-badge-url.png" alt=""></p>

<p>Then in the GitHub repository, edit the readme.md file and add the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>![Build status](badge URL copied from AWS console)
</code></pre></div></div>

<p>Now if you go to the GitHub repository page and refresh you can see the latest status of the build (of master branch):</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/displaying-build-status.png" alt=""></p>

<p>After I fixed the error and merged into master branch I could see the build passing badge as well:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/build-status-passing.png" alt=""></p>

<h2 id="notifications">Notifications</h2>
<p>It would be nice to have a direct integration with notifications. This can be achieved using CloudWatch Events. In this sample project I’m going to use SNS to send email notifications.</p>

<p>First, I went to CloudWatch and created a rule and added the build state changed events. Just gave it a name and created the rule so that it looked like this:</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/cloudwatch-event-rule-view.png" alt=""></p>

<p>After that I broke the test intentionally and received email for build failure in JSON format.</p>

<p><img src="/images/vpblogimg/2019/11/ci-with-codebuild/build-notification-json.png" alt=""></p>

<h2 id="conclusion">Conclusion</h2>
<p>In this post I wanted to show a continuous integration pipeline using GitHub and CodeBuild. It can further be improved by posting the build status to Slack so that the whole team can get the notifications instantly. For the time being I achieved the goals I set out for initially so I’ll wrap it up here.</p>

<h2 id="source-code">Source Code</h2>
<p>Source code can be found in the repo below under blog/CodeBuild_CI_Pipeline folder</p>

<p></p>
<div class="github-widget" data-repo="volkanpaksoy/lab"></div>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://docs.aws.amazon.com/en_pv/codebuild/latest/userguide/sample-build-notifications.html" target="_blank" rel="noopener noreferrer">Build Notifications Sample for CodeBuild</a></li>
  <li><a href="https://github.com/volkanpaksoy/lab/tree/master/blog/CodeBuild_CI_Pipeline" target="_blank" rel="noopener noreferrer">Source code</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2019/10/26/Infrastructure-as-Code-with-AWS-CloudFormation-and-Cloud-Development-Kit/" itemprop="url">Infrastructure as Code with AWS CloudFormation and Cloud Development Kit (CDK)</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2019-10-26T13:00:00+01:00" itemprop="datePublished">October 26, 2019</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devopsaws">devops</a></span> -->

<!-- devops, aws -->




    <a href="/category/devops">devops</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">cloudformation, cdk</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<h2 id="introduction">Introduction</h2>
<p>Using AWS is great as it simplifies and improves infrastructure provisioning and maintenance quite a lot. As you depend more and more on AWS you quickly realize that managing everything through AWS Management Console is not an ideal way.</p>

<p>Earlier this year, I published this <a href="https://volkanpaksoy.com/archive/2019/01/15/Infrastructure-as-code-with-AWS-CloudFormation/">post</a> about AWS CloudFormation. This post will also discuss using CloudFormation but by taking it a higher level by using AWS Cloud Development Kit (CDK).</p>

<h2 id="levels-of-infrastructure">Levels of infrastructure</h2>
<p>I liked the way the several approaches of infrastructure management is illustrated as levels here: <a href="https://www.youtube.com/watch?v=184S7ki6fJA" target="_blank" rel="noopener noreferrer">Develop a Web App Using Amazon ECS and AWS Cloud Development Kit (CDK) - AWS Online Tech Talks (YouTube Video)</a></p>

<p>In a nutshell, those levels are:</p>

<h3 id="level-0-by-hand">Level 0: By hand</h3>
<p>This approach is simply using AWS Management Console user interface to manage the infrastructure.</p>

<p><strong>Pros:</strong></p>

<ul>
  <li>Simple and easy</li>
  <li>Helps to get results faster for exploratory projects</li>
</ul>

<p><strong>Cons:</strong></p>

<ul>
  <li>Hard to reproduce</li>
  <li>Possible inconsistencies based on people’s preferences</li>
  <li>Error-prone</li>
  <li>Slow for complex systems</li>
</ul>

<h3 id="level-1-imperative-infrastructure-as-code">Level 1: Imperative Infrastructure as Code</h3>
<p>In this approach you write your own scripts using AWS SDK and manage the resources programmatically.</p>

<p><strong>Pros:</strong></p>

<ul>
  <li>Repeatable and reusable</li>
  <li>Can be source-controlled</li>
</ul>

<p><strong>Cons:</strong></p>

<ul>
  <li>Lots of boilerplate code</li>
  <li>It needs to address all edge cases</li>
</ul>

<h3 id="level-2-declarative-infrastructure-as-code">Level 2: Declarative Infrastructure as Code</h3>
<p>Describe the infrastructure as a script (in JSON or YAML) and use an resource provisioning engine such as AWS CloudFormation or HashiCorp Terraform which in turn use AWS SDK to manage the infrastructure.</p>

<p><strong>Pros:</strong></p>

<ul>
  <li>No boilerplate</li>
  <li>Creating and updating resources is handled automatically</li>
</ul>

<p><strong>Cons:</strong></p>

<ul>
  <li>Templates can become verbose</li>
  <li>Implementing logic is limited to some built-in helper functions</li>
</ul>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<h3 id="level-3-aws-cloud-development-kit">Level 3: AWS Cloud Development Kit</h3>
<p>In this approach software is developed using AWS CDK which generates the input for AWS CloudFormation.</p>

<p><img src="/images/vpblogimg/2019/10/aws_cdk/aws-cdk-overview.jpg" alt=""></p>

<p>The application can be developed in a number of languages. At the time of this writing the following languages are supported: TypeScript, JavaScript, Python, Java, C#.</p>

<p><strong>Pros:</strong></p>

<ul>
  <li>Handles creation of underlying resources. For example, when creating a VPC it also automatically generates YAML for all other networking resources (routing tables, NAT gateways etc) that are required by VPC.</li>
  <li>Helps with local workflow</li>
  <li>CDK constructs are reusable. Can be developed by AWS or third parties and can be installed separately.</li>
  <li>Ability to use familiar programming languages</li>
</ul>

<p><strong>Cons:</strong></p>

<ul>
  <li>Extra installation</li>
</ul>

<h2 id="basic-concepts">Basic Concepts</h2>
<ul>
  <li>
<strong>Construct:</strong> Basic building block for an AWS CDK app. Represents a “cloud component” and encapsulates everything AWS CloudFormation needs to create the component. They can be developed or downloaded from <a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-construct-library.html" target="_blank" rel="noopener noreferrer">AWS Construct Library</a>
</li>
  <li>
<strong>Stack:</strong> Constructs need to be created within the scope of a Stack. This corresponds to a CloudFormation template.</li>
  <li>
<strong>App:</strong> Stacks are created in the scope of an App. An App can contain multiple stacks.</li>
</ul>

<h2 id="cdk-basics">CDK Basics</h2>
<ul>
  <li>In order to create an application that uses CDK we need to install the CDK</li>
  <li>The application can have one of the 3 supported templates:
    <ul>
      <li>app: General purpose application. This is the default template</li>
      <li>lib: Used to develop a CDK construct</li>
      <li>sample-app: Creates an application already populated with a sample CDK application.</li>
    </ul>
  </li>
  <li>The following diagram illustrates the app lifecycle:</li>
</ul>

<p><img src="/images/vpblogimg/2019/10/aws_cdk/aws-cdk-app-lifecycle.png" alt=""></p>

<h2 id="installing-cdk">Installing CDK</h2>
<p>AWS CDK is developed using TypeScript. It’s available via npm:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install -g aws-cdk
</code></pre></div></div>

<h2 id="using-cdk">Using CDK</h2>
<p>In my example, I will use C#. A new project can be created by using <strong>cdk init</strong> command:</p>

<p><img src="/images/vpblogimg/2019/10/aws_cdk/aws-cdk-init.png" alt=""></p>

<p>It expects 2 parameters: Language (Can be one of these: csharp, fsharp, java, javascript, python or typescript).</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk init app --language csharp
</code></pre></div></div>

<p>To test my first app, I followed the sample app provided and added an S3 construct to my code:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CdkWorkoutStack</span> <span class="p">:</span> <span class="n">Stack</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CdkWorkoutStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">parent</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">IStackProps</span> <span class="n">props</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bucket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">"CdkBucket"</span><span class="p">,</span> <span class="k">new</span> <span class="n">BucketProps</span>
        <span class="p">{</span>
            <span class="n">Versioned</span> <span class="p">=</span> <span class="k">true</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Next step is to synnthesize a CloudFormation template by running</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk synth
</code></pre></div></div>

<p>This generates a folder called cdk.out which contains a file named CdkWorkoutStack.template.json and with the following contents:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"CdkBucket2FB0D10E"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::S3::Bucket"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"VersioningConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"Status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Enabled"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"UpdateReplacePolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Retain"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DeletionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Retain"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"aws:cdk:path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CdkWorkoutStack/CdkBucket/Resource"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">  
</span></code></pre></div></div>

<p>Final step is to create the resources by running</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk deploy
</code></pre></div></div>

<p>This produces the following results:</p>

<p><img src="/images/vpblogimg/2019/10/aws_cdk/aws-cdk-deployment-results.png" alt=""></p>

<p>And not surprisingly a CloudFormation stack with the bucket is created in AWS.</p>

<p>In the next version I’m going to change some properties of the bucket such as:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CdkWorkoutStack</span> <span class="p">:</span> <span class="n">Stack</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CdkWorkoutStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">parent</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">IStackProps</span> <span class="n">props</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">_</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bucket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">"CdkBucket"</span><span class="p">,</span> <span class="k">new</span> <span class="n">BucketProps</span>
        <span class="p">{</span>
            <span class="n">Versioned</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
            <span class="n">BlockPublicAccess</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlockPublicAccess</span><span class="p">(</span><span class="k">new</span> <span class="nf">BlockPublicAccessOptions</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">BlockPublicAcls</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="n">BlockPublicPolicy</span> <span class="p">=</span> <span class="k">true</span>
            <span class="p">})</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>After this change in the code we can review what’s going to be updated by running the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk diff
</code></pre></div></div>

<p>and it produces the following result outlining the changes between the current code and the deployed version:</p>

<p><img src="/images/vpblogimg/2019/10/aws_cdk/aws-cdk-diff-results.png" alt=""></p>

<p>And the stack can be deleted by running the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cdk destroy
</code></pre></div></div>

<p>In the CDK version I’m using the default deletion policy is to retain. That’s why when I deleted the stack via CDK it didn’t delete the bucket. In order to change that behaviour I had to change the value to delete as such:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CdkWorkoutStack</span> <span class="p">:</span> <span class="n">Stack</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">CdkWorkoutStack</span><span class="p">(</span><span class="n">Construct</span> <span class="n">parent</span><span class="p">,</span> <span class="kt">string</span> <span class="n">id</span><span class="p">,</span> <span class="n">IStackProps</span> <span class="n">props</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">props</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">bucket</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Bucket</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s">"CdkBucket"</span><span class="p">,</span> <span class="k">new</span> <span class="n">BucketProps</span>
        <span class="p">{</span>
            <span class="n">Versioned</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
            <span class="n">BlockPublicAccess</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BlockPublicAccess</span><span class="p">(</span><span class="k">new</span> <span class="nf">BlockPublicAccessOptions</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">BlockPublicAcls</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                <span class="n">BlockPublicPolicy</span> <span class="p">=</span> <span class="k">true</span>
            <span class="p">})</span>
        <span class="p">});</span>

        <span class="kt">var</span> <span class="n">resource</span> <span class="p">=</span> <span class="n">bucket</span><span class="p">.</span><span class="n">Node</span><span class="p">.</span><span class="nf">FindChild</span><span class="p">(</span><span class="s">"Resource"</span><span class="p">)</span> <span class="k">as</span> <span class="n">Amazon</span><span class="p">.</span><span class="n">CDK</span><span class="p">.</span><span class="n">CfnResource</span><span class="p">;</span>
        <span class="n">resource</span><span class="p">.</span><span class="nf">ApplyRemovalPolicy</span><span class="p">(</span><span class="n">RemovalPolicy</span><span class="p">.</span><span class="n">DESTROY</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This time it produces a CloudFormation template with a different policy:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Resources"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"CdkBucket2FB0D10E"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AWS::S3::Bucket"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"PublicAccessBlockConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"BlockPublicAcls"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
          </span><span class="nl">"BlockPublicPolicy"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"VersioningConfiguration"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"Status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Enabled"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"UpdateReplacePolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Delete"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"DeletionPolicy"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Delete"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"aws:cdk:path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"CdkWorkoutStack/CdkBucket/Resource"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>This time after destroy command it did delete the bucket as well.</p>

<h2 id="conclusion">Conclusion</h2>
<p>I think infrastructure as code is definitely the way to manage cloud resources and CDK provides a great way to simplify the process. It’s at early stages for the time being as the NuGet packages are in devpreview mode but it’s good enough to rely on and start developing with CDK.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://www.youtube.com/watch?v=Lh-kVC2r2AU" target="_blank" rel="noopener noreferrer">AWS re:Invent 2018: Infrastructure Is Code with the AWS Cloud Development Kit (DEV372) (YouTube Video)</a></li>
  <li><a href="https://www.youtube.com/watch?v=184S7ki6fJA" target="_blank" rel="noopener noreferrer">Develop a Web App Using Amazon ECS and AWS Cloud Development Kit (CDK) - AWS Online Tech Talks (YouTube Video)</a></li>
  <li><a href="https://docs.aws.amazon.com/en_pv/cdk/latest/guide/getting_started.html" target="_blank" rel="noopener noreferrer">AWS Documentation: Getting Started With the AWS CDK</a></li>
  <li><a href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-construct-library.html" target="_blank" rel="noopener noreferrer">AWS CDK Construct Library</a></li>
</ul>

		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/page/3" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2022 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
