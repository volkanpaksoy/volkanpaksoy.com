<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/25/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35583486-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
<!-- vp.com - default -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/08/12/dynamic-dns-with-aws-route53/" itemprop="url">Dynamic DNS with AWS Route 53</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-08-12T01:30:00+01:00" itemprop="datePublished">August 12, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/awsdev">aws</a></span> -->

<!-- aws, dev -->




    <a href="/category/aws">aws</a>
    , 

    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">route53, csharp</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>If you don’t have a static IP and you need to access your home network for some reason you may find Dynamic DNS services useful. I was using No-IP until its limitations became offputting. Since I love DIY stuff and AWS I thought I could build the exact same service on my own using Route 53.</p>

<h2 id="enter-dyndns53">Enter DynDns53</h2>

<p>It’s a simple application. What it does is basically:</p>

<ul>
  <li>Get current external IP</li>
  <li>For each subdomain in the configuration, call AWS API and get domain info</li>
  <li>Check if the recorded IP is different than the current one</li>
  <li>If so, call AWS API to update it with the new one, if not do nothing.</li>
</ul>

<p>In a different post on <a href="https://volkanpaksoy.com/archive/2015/03/07/portable-online-library-with-calibre-and-raspberry-pi/">setting up Calibre on a Raspberry Pi</a> I developed a script that did the same thing:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">boto.route53</span>
<span class="kn">import</span> <span class="nn">urllib2</span>
<span class="n">currentIP</span> <span class="o">=</span> <span class="n">urllib2</span><span class="p">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">"http://checkip.amazonaws.com/"</span><span class="p">).</span><span class="n">read</span><span class="p">()</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">boto</span><span class="p">.</span><span class="n">connect_route53</span><span class="p">()</span>
<span class="n">zone</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">get_zone</span><span class="p">(</span><span class="s">"volki.info."</span><span class="p">)</span>
<span class="n">change_set</span> <span class="o">=</span> <span class="n">boto</span><span class="p">.</span><span class="n">route53</span><span class="p">.</span><span class="n">record</span><span class="p">.</span><span class="n">ResourceRecordSets</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s">'{HOSTED_ZONE_ID}'</span><span class="p">)</span>

<span class="k">for</span> <span class="n">rrset</span> <span class="ow">in</span> <span class="n">conn</span><span class="p">.</span><span class="n">get_all_rrsets</span><span class="p">(</span><span class="n">zone</span><span class="p">.</span><span class="nb">id</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">rrset</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">'calibre.volki.info.'</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">change_set</span><span class="p">.</span><span class="n">add_change</span><span class="p">(</span><span class="s">"UPSERT"</span><span class="p">,</span> <span class="n">rrset</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rrset</span><span class="p">.</span><span class="nb">type</span><span class="p">,</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
        <span class="n">rrset</span><span class="p">.</span><span class="n">resource_records</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">currentIP</span>
        <span class="n">u</span><span class="p">.</span><span class="n">add_value</span><span class="p">(</span><span class="n">rrset</span><span class="p">.</span><span class="n">resource_records</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">change_set</span><span class="p">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div></div>

<p>The difference of DynDns53 is that it can run as a background service and it has a cute logo! The C# equivalent of above code is like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Update</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="n">_configHandler</span><span class="p">.</span><span class="nf">GetConfig</span><span class="p">();</span>
    <span class="kt">string</span> <span class="n">currentExternalIp</span> <span class="p">=</span> <span class="n">_ipChecker</span><span class="p">.</span><span class="nf">GetExternalIp</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">domain</span> <span class="k">in</span> <span class="n">config</span><span class="p">.</span><span class="n">DomainList</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">subdomain</span> <span class="p">=</span> <span class="n">domain</span><span class="p">.</span><span class="n">DomainName</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">zoneId</span> <span class="p">=</span> <span class="n">domain</span><span class="p">.</span><span class="n">ZoneId</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">listResourceRecordSetsResponse</span> <span class="p">=</span> <span class="n">_amazonClient</span><span class="p">.</span><span class="nf">ListResourceRecordSets</span><span class="p">(</span><span class="k">new</span> <span class="nf">ListResourceRecordSetsRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">HostedZoneId</span> <span class="p">=</span> <span class="n">zoneId</span> <span class="p">});</span>
        <span class="kt">var</span> <span class="n">resourceRecordSet</span> <span class="p">=</span> <span class="n">listResourceRecordSetsResponse</span><span class="p">.</span><span class="n">ResourceRecordSets</span><span class="p">.</span><span class="nf">First</span><span class="p">(</span><span class="n">recordset</span> <span class="p">=&gt;</span> <span class="n">recordset</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="n">subdomain</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">resourceRecord</span> <span class="p">=</span> <span class="n">resourceRecordSet</span><span class="p">.</span><span class="n">ResourceRecords</span><span class="p">.</span><span class="nf">First</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">resourceRecord</span><span class="p">.</span><span class="n">Value</span> <span class="p">!=</span> <span class="n">currentExternalIp</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">resourceRecord</span><span class="p">.</span><span class="n">Value</span> <span class="p">=</span> <span class="n">currentExternalIp</span><span class="p">;</span>

            <span class="n">_amazonClient</span><span class="p">.</span><span class="nf">ChangeResourceRecordSets</span><span class="p">(</span><span class="k">new</span> <span class="nf">ChangeResourceRecordSetsRequest</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="n">HostedZoneId</span> <span class="p">=</span> <span class="n">zoneId</span><span class="p">,</span>
                <span class="n">ChangeBatch</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ChangeBatch</span><span class="p">()</span>
                <span class="p">{</span>
                    <span class="n">Changes</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Change</span><span class="p">&gt;()</span> 
                    <span class="p">{</span> 
                        <span class="k">new</span> <span class="nf">Change</span><span class="p">(</span><span class="n">ChangeAction</span><span class="p">.</span><span class="n">UPSERT</span><span class="p">,</span> <span class="n">resourceRecordSet</span><span class="p">)</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">});</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>That’s it. The rest is just user interface, a Windows service and some basic uni tests.</p>

<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>

<p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></p>

<h2 id="usage">Usage</h2>

<p>The project has a WPF user interface and a Windows service. Both are using the same library (DynDns53.Core) so the functionality is the same. Using the user interface is pretty straightforward.</p>

<p><img src="/images/vpblogimg/2015/08/dyndns53-mainwindow.png" alt=""></p>

<p>Just add your AWS keys that have access privileges to your domains. You can set it to run at system start so you don’t have to start it manually.</p>

<p><img src="/images/vpblogimg/2015/08/dyndns53-settings-window.png" alt=""></p>

<p>I built the Windows service using Topshelf. To install it, build the application and on an elevated command prompt just run</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DynDns53.Service.exe install
</code></pre></div></div>

<p>Similarly to uninstall:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DynDns53.Service.exe uninstall
</code></pre></div></div>

<h1 id="whats-missing">What’s missing</h1>

<ul>
  <li>Landing page: I’ll update the project details on the site generated by GitHub Pages.</li>
  <li>Mac/Linux support: As the worlds are colliding I’d like to discover what I can do with the new .NET Core runtime. Since this is a simple project I think it’s a good place to start</li>
</ul>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="https://github.com/volkanpaksoy/dyndns53" target="_blank" rel="noopener noreferrer">DynDns53 Source Code</a></li>
  <li><a href="http://dyndns53.com" target="_blank" rel="noopener noreferrer">Project website</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/08/08/checking-domain-availability-with-aws-route53-part-3/" itemprop="url">Checking domain availability with AWS Route 53 - Part 3</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-08-08T23:00:00+01:00" itemprop="datePublished">August  8, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">csharp, route53</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<h1 id="part-3-consuming-the-apis">Part 3: Consuming the APIs</h1>

<p>So far in the series:</p>

<ul>
  <li><a href="https://volkanpaksoy.com/archive/2015/08/04/checking-domain-availability-with-aws-route53-part-1/">Part 1: Getting TLD List</a></li>
  <li><a href="https://volkanpaksoy.com/archive/2015/08/06/checking-domain-availability-with-aws-route53-part-2/">Part 2: Implementing API for TLD service</a></li>
</ul>

<p>In this installment it’s time to implement the actual application that consumes the TLD API as well as AWS Route 53 API. I decided to turn this into a little project with a name, logo and everything. I’ll keep updating the project. Currently it just has the core library and a console application. I know it’s not enough but you have to start somewhere!</p>

<h3 id="core-functionality">Core functionality</h3>

<p>Basically what it does is:</p>

<ol>
  <li>
    <p>Get the supported TLD list</p>
  </li>
  <li>
    <p>For each TLD send a CheckDomainAvailability request to AWS</p>
  </li>
  <li>
    <p>Return the resultset</p>
  </li>
</ol>

<p>When I first started out I was meaning to make these requests run in parallel. But they got throttled and I ended up using all my allowance. So I changed the code to make a call per second:</p>

<p>The TldProvider I developed can be used in two different ways:</p>

<ol>
  <li>As a NuGet Package</li>
</ol>

<p>I uploaded my package to NuGet.org so you can install it by running</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Package TldProvider.Core.dll
</code></pre></div></div>

<p>and the usage would be:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tld</span><span class="p">&gt;</span> <span class="nf">GetTldListFromLibrary</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">url</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"Aws.Route53.DocPageUrl"</span><span class="p">];</span>
    <span class="kt">var</span> <span class="n">tldListProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TldListProvider</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">supportedTLDlist</span> <span class="p">=</span> <span class="n">tldListProvider</span><span class="p">.</span><span class="nf">GetSupportedTldList</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">supportedTLDlist</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>

<p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></p>

<ol>
  <li>As an API the usage is a bit more complex because of the JSON to list conversion:</li>
</ol>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tld</span><span class="p">&gt;</span> <span class="nf">GetTldListFromApi</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">apiUrl</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"TldProvider.Api.EndPoint"</span><span class="p">];</span>
    <span class="kt">var</span> <span class="n">httpClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpClient</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpRequestMessage</span><span class="p">()</span> <span class="p">{</span> <span class="n">Method</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpMethod</span><span class="p">(</span><span class="s">"GET"</span><span class="p">),</span> <span class="n">RequestUri</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="n">apiUrl</span><span class="p">)</span> <span class="p">};</span>
    <span class="kt">var</span> <span class="n">httpResponse</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="nf">SendAsync</span><span class="p">(</span><span class="n">request</span><span class="p">).</span><span class="n">Result</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">apiResponse</span> <span class="p">=</span> <span class="n">httpResponse</span><span class="p">.</span><span class="n">Content</span><span class="p">.</span><span class="nf">ReadAsStringAsync</span><span class="p">().</span><span class="n">Result</span><span class="p">;</span>
    <span class="kt">dynamic</span> <span class="n">resp</span> <span class="p">=</span> <span class="n">Newtonsoft</span><span class="p">.</span><span class="n">Json</span><span class="p">.</span><span class="n">JsonConvert</span><span class="p">.</span><span class="nf">DeserializeObject</span><span class="p">(</span><span class="n">apiResponse</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">resultAsStringList</span> <span class="p">=</span> <span class="n">JToken</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">apiResponse</span><span class="p">)[</span><span class="s">"tldList"</span><span class="p">].</span><span class="n">ToObject</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;();</span> <span class="p">;</span>
    <span class="kt">var</span> <span class="n">resultAsTldList</span> <span class="p">=</span> <span class="n">resultAsStringList</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Tld</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="n">t</span> <span class="p">}).</span><span class="nf">ToList</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">resultAsTldList</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Actually this method should not return List<tld> as it would require a reference to the library. The idea of using the API is to get rid of that dependency in the first place but I just wanted to add both and use them interchangably.</tld></p>

<p>So finally tha main course: The check method that loops through the TLD list and gets the availability from AWS Route 53 API</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DomainCheckResult</span><span class="p">&gt;</span> <span class="nf">Check</span><span class="p">(</span><span class="kt">string</span> <span class="n">domainName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">ACCESS_KEY</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"Aws.Route53.AccessKey"</span><span class="p">];</span>
    <span class="kt">string</span> <span class="n">SECRET_KEY</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"Aws.Route53.SecretKey"</span><span class="p">];</span>

    <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">DomainCheckResult</span><span class="p">&gt;();</span>

    <span class="kt">var</span> <span class="n">credentials</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">BasicAWSCredentials</span><span class="p">(</span><span class="n">ACCESS_KEY</span><span class="p">,</span> <span class="n">SECRET_KEY</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmazonRoute53DomainsConfig</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="n">RegionEndpoint</span> <span class="p">=</span> <span class="n">RegionEndpoint</span><span class="p">.</span><span class="n">USEast1</span>
    <span class="p">};</span>

    <span class="kt">var</span> <span class="n">amazonRoute53DomainsClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">AmazonRoute53DomainsClient</span><span class="p">(</span><span class="n">credentials</span><span class="p">,</span> <span class="n">config</span><span class="p">);</span>

    <span class="c1">// var supportedTLDlist = GetTldListFromLibrary();</span>
    <span class="kt">var</span> <span class="n">supportedTLDlist</span> <span class="p">=</span> <span class="nf">GetTldListFromApi</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">tld</span> <span class="k">in</span> <span class="n">supportedTLDlist</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">request</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">CheckDomainAvailabilityRequest</span><span class="p">()</span> <span class="p">{</span> <span class="n">DomainName</span> <span class="p">=</span>  <span class="s">$"</span><span class="p">{</span><span class="n">domainName</span><span class="p">}</span><span class="s">.</span><span class="p">{</span><span class="n">tld</span><span class="p">.</span><span class="n">Name</span><span class="p">}</span><span class="s">"</span> <span class="p">};</span>

        <span class="kt">var</span> <span class="n">response</span> <span class="p">=</span> <span class="n">amazonRoute53DomainsClient</span><span class="p">.</span><span class="nf">CheckDomainAvailabilityAsync</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="n">response</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"</span><span class="p">{</span><span class="n">request</span><span class="p">.</span><span class="n">DomainName</span><span class="p">}</span><span class="s"> --&gt; </span><span class="p">{</span><span class="n">result</span><span class="p">.</span><span class="n">Availability</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
        <span class="n">results</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">DomainCheckResult</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">Domain</span> <span class="p">=</span> <span class="n">domainName</span><span class="p">,</span>
            <span class="n">Tld</span> <span class="p">=</span> <span class="n">tld</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span>
            <span class="n">Availability</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">Availability</span><span class="p">,</span>
            <span class="n">CheckDate</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span>
        <span class="p">});</span>

        <span class="n">System</span><span class="p">.</span><span class="n">Threading</span><span class="p">.</span><span class="n">Thread</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="m">1000</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="troubleshooting">TroubleShooting</h3>
<p>I had a few problems while implementing. Learned a few things while fixing them. So here they are:</p>

<ul>
  <li>
    <p>I created an IAM account that has access to Route53. But that wasn’t enough. There is a separate action called <strong>route53domains</strong>. I had to grant access to this as well to use domains API.</p>
  </li>
  <li>
    <p>I use EUWest1 region since it’s the closest one. Normally Route53 doesn’t require any region setting but weirdly I had to set region to US East1 in order to access Route53Domains API.</p>
  </li>
</ul>

<p>The problems above makes me think domains didn’t fit very well with the current Route53. It feels like it has not integrated seamlessly yet.</p>

<h3 id="first-client-console-application">First client: Console application</h3>
<p>This used to be the test application but since I don’t have any user interface currently this will be my first client. It just accepts the domain name from the user, checks the availability and saves the results in JSON format. This is all the code of the console application:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Usage: DomChk53.UI.Console {domain name}"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">string</span> <span class="n">domain</span> <span class="p">=</span> <span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">];</span>
    <span class="kt">var</span> <span class="n">checker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DomainChecker</span><span class="p">();</span>
    <span class="kt">var</span> <span class="n">results</span> <span class="p">=</span> <span class="n">checker</span><span class="p">.</span><span class="nf">Check</span><span class="p">(</span><span class="n">domain</span><span class="p">);</span>

    <span class="kt">string</span> <span class="n">outputFilename</span> <span class="p">=</span> <span class="s">$"results-</span><span class="p">{</span><span class="n">domain</span><span class="p">}</span><span class="s">-</span><span class="p">{</span><span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"yyyyMMdd-HHmmss"</span><span class="p">)}</span><span class="s">.json"</span><span class="p">;</span>
    <span class="kt">string</span> <span class="n">json</span> <span class="p">=</span> <span class="n">Newtonsoft</span><span class="p">.</span><span class="n">Json</span><span class="p">.</span><span class="n">JsonConvert</span><span class="p">.</span><span class="nf">SerializeObject</span><span class="p">(</span><span class="n">results</span><span class="p">);</span>
    <span class="n">File</span><span class="p">.</span><span class="nf">WriteAllText</span><span class="p">(</span><span class="n">outputFilename</span><span class="p">,</span> <span class="n">json</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">$"Saved the results to </span><span class="p">{</span><span class="n">outputFilename</span><span class="p">}</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It also displays the results of each domain on the console you can have keep track of what it’s doing</p>

<p><img src="/images/vpblogimg/2015/08/domchk53-console-output.png" alt=""></p>

<p>It saves the results with a timestamp so a history can be maintained:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  {
    "Domain": "volkan",
    "Tld": "cool",
    "Availability": "AVAILABLE",
    "CheckDate": "2015-08-05T12:31:58.40081Z"
  },
</code></pre></div></div>

<h3 id="whats-missing">What’s missing</h3>
<p>It’s not much but at least it delivers what it promises: You give it a domain name and it checks the availability of all supported TLDs by AWS Route 53 and returns the results. But there’s a lot to do to improve this project. Some items in my list:</p>

<ul>
  <li>A web-based user interface that allows viewing these results online.</li>
  <li>Get the price list for each tLD as well and display it along with the name</li>
  <li>Registering selected domains: It would be nice if you could buy the available domains using the same interface</li>
  <li>A landing page at domchk53.com so that it can have links to the source code, online checker etc.</li>
</ul>

<h3 id="conclusion">Conclusion</h3>
<p>The reason I started this project was to overcome the limitations of AWS Route 53 domains UI and be able to search all supported TLDs all at once. To consider the project complete I will prepare a single-page website about the project and develop a nice user-interface. But in terms of basic functionality I can get what I set out for so I can think of it as a small success I guess.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/domchk53" target="_blank" rel="noopener noreferrer">Project source code</a></li>
  <li><a href="http://domchk53.com" target="_blank" rel="noopener noreferrer">Project website</a></li>
  <li><a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar-tld-list.html" target="_blank" rel="noopener noreferrer">List of Supported TLDs</a></li>
  <li><a href="http://docs.aws.amazon.com/general/latest/gr/rande.html" target="_blank" rel="noopener noreferrer">AWS Documentation for Route 53 Domains region</a></li>
  <li><a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/DNSLimitations.html" target="_blank" rel="noopener noreferrer">AWS Documentation for Route 53 limitations</a></li>
  <li><a href="https://d32ze2gidvkk54.cloudfront.net/Amazon_Route_53_Domain_Registration_Pricing_20140731.pdf" target="_blank" rel="noopener noreferrer">AWS Domain price list</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/08/06/checking-domain-availability-with-aws-route53-part-2/" itemprop="url">Checking domain availability with AWS Route 53 - Part 2</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-08-06T12:30:00+01:00" itemprop="datePublished">August  6, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">csharp, javascript, route53, lambda, amazon_api_gateway, nodejs</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<h1 id="part-2-converting-tld-provider-into-an-api">Part 2: Converting TLD Provider into an API</h1>

<p>In all fairness, this part is not entirely necessary for the project. I already found a way to get the list of TLDs from Amazon documentation so I could easily integrate it with my client applications. But I recently heard about Amazon API Gateway which has been introduced a few weeks back so I thought it would be cool to access my JavaScript method via a web API hosted on AWS. After all, the point of many projects I develop is to learn new stuff! In light of that I’ll try something new with the C# version as well and use a self-hosted service so that I can use a Windows Service instead of IIS.</p>

<h3 id="api-1-amazon-api-gateway">API #1: Amazon API Gateway</h3>
<p>There are a couple of new technologies here that I haven’t used before so this was a good chance for me to play with them.</p>

<p>Amazon API Gateway looks like a great service to create hosted APIs. Also it’s integrated with AWS Lambda. You can bind an endpoint directly to lambda function. There are other binding options but in this project I will use Lambda as it was also in my to-learn list.</p>

<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>

<p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></p>

<h4 id="setup-amazon-api-gateway">Setup Amazon API Gateway</h4>
<p>API Gateway interface is very intuitive. Within minutes I was able to create a GET method calling my Lambda function. First you create the API by clicking the “Create API” button!</p>

<p>Then you add your resource by clicking “Create Resource”. By default it comes with the root resource (“/”) so you can just use that one as well to add methods.</p>

<p>I created a resource called tldlist. All I needed was a GET method so I created it by “Create Method”.</p>

<p><img src="/images/vpblogimg/2015/08/domchk53-api-gateway-create-method.png" alt=""></p>

<p>You select the region and enter the full ARN of your Lambda function. In the UI it just says “function name” but it requires full ARN (i.e.: arn:aws:lambda:eu-west-1:1234567890:function:getTldList)</p>

<h4 id="and-lambda">…and Lambda</h4>
<p>The function is a bit different from the previous version. In Node.js I wasn’t able to use <em>XMLHttpRequest</em> object and turns out your use the http module to make web requests so I modified the code a bit. Here’s the final version of my Lambda function:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Loading function</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">docHost</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">docs.aws.amazon.com</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">docPath</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">/Route53/latest/DeveloperGuide/registrar-tld-list.html</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">supportedTldPage</span> <span class="o">=</span> <span class="nx">docHost</span> <span class="o">+</span> <span class="nx">docPath</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">http</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">exports</span><span class="p">.</span><span class="nx">handler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">host</span><span class="p">:</span> <span class="nx">docHost</span><span class="p">,</span>
      <span class="na">path</span><span class="p">:</span> <span class="nx">docPath</span><span class="p">,</span>
      <span class="na">port</span><span class="p">:</span> <span class="mi">80</span>
    <span class="p">};</span>
    
    <span class="nx">http</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">options</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">data</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">chunk</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">body</span> <span class="o">+=</span> <span class="nx">chunk</span><span class="p">;</span>
        <span class="p">});</span>
        
        <span class="nx">res</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
            <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">parseHtml</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
            <span class="nx">context</span><span class="p">.</span><span class="nx">succeed</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="dl">'</span><span class="s1">error</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Got error: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
    <span class="p">});</span>     

<span class="p">};</span>

<span class="kd">function</span> <span class="nx">parseHtml</span><span class="p">(</span><span class="nx">pageHtml</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/&lt;a class="xref" href="registrar-tld-list.html#.+</span><span class="se">?</span><span class="sr">"&gt;</span><span class="se">[</span><span class="sr">.</span><span class="se">](</span><span class="sr">.+</span><span class="se">?)</span><span class="sr">&lt;</span><span class="se">\/</span><span class="sr">a&gt;/g</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">regEx</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">supportedTldPage</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toUTCString</span><span class="p">();</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">tldList</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">regEx</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">pageHtml</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">tldList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In order to return a value from Lambda function you have to call succeed, fail or done:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>context.succeed (Object result);
context.fail (Error error);
context.done (Error error, Object result);
</code></pre></div></div>

<p>Succeed and fail are self-explanatory. done is like a combination of both. If error is non-null it treats it as failure. Even if you call fail or done with an error the HTTP response code is always 200. what changes is the message body. For example, I played around with a few possibilities to test various results:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Method call: context.succeed(result);  
Output: Full JSON results

Method call: context.done(null, result);  
Output: Full JSON results

Method call: context.fail("FAIL!!!");  
Output: {"errorMessage":"FAIL!!!"}

Method call: context.done("FAIL!!!", results);  
Output: {"errorMessage":"FAIL!!!"}
</code></pre></div></div>

<p>As you can see, if error parameter is not null it ignores the actual results. Also I removed the JSON.stringify call from the parseHtml method because API gateway automatically converts it to JSON.</p>

<h4 id="tying-things-together">Tying things together</h4>
<p>Deployment is also a breeze, just like creating the API, resource and the methods all it takes is a few button clicks. You click Deploy API and create an environment such as staging or prod. And that’s it! You’re good to go!</p>

<p>Since this will be a public-facing API with no authentication I also added a CloudWatch alarm:</p>

<p><img src="/images/vpblogimg/2015/08/domchk53-api-gateway-create-alarm.png" alt=""></p>

<p>This way if some mental decides to abuse I will be aware of it. The good thing is it’s very cheap. It costs $3.5 per million API calls which is about £2.25. I don’t think it will break the bank but for serious applications authorization is a must so I will need to investigate that feature in the future anyway.</p>

<p>At this point, I have a Lambda function called from the API hosted by AWS. I don’t have to worry about anything regarding the maintenance and scaling which feels great!</p>

<h3 id="api-2-c--self-hosting-on-a-windows-service">API #2: C# &amp; Self-hosting on a Windows Service</h3>
<p>Speaking of maintenance, here comes the Windows version! I don’t intend to deploy it on production but I was meaning to learn self-hosting APIs with Web API to avoid IIS and here’s chance to do so.</p>

<p>Found this nice concise <a href="http://www.asp.net/web-api/overview/hosting-aspnet-web-api/use-owin-to-self-host-web-api" target="_blank" rel="noopener noreferrer">article</a> showing how to run a Web API inside a console application. I tweaked the code a little bit to suit my needs. Basically it takes 4 simple steps:</p>

<h4 id="step-01-install-owin-self-host-nuget-package">Step 01. Install OWIN Self-Host NuGet package:</h4>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Install-Package Microsoft.AspNet.WebApi.OwinSelfHost
</code></pre></div></div>

<h4 id="step-02-setup-routing">Step 02. Setup routing</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Startup</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">Configuration</span><span class="p">(</span><span class="n">IAppBuilder</span> <span class="n">appBuilder</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">HttpConfiguration</span> <span class="n">config</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">HttpConfiguration</span><span class="p">();</span>
        <span class="n">config</span><span class="p">.</span><span class="n">Routes</span><span class="p">.</span><span class="nf">MapHttpRoute</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">"DefaultApi"</span><span class="p">,</span>
            <span class="n">routeTemplate</span><span class="p">:</span> <span class="s">"api/{controller}/{id}"</span><span class="p">,</span>
            <span class="n">defaults</span><span class="p">:</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="n">RouteParameter</span><span class="p">.</span><span class="n">Optional</span> <span class="p">}</span>
        <span class="p">);</span>

        <span class="n">appBuilder</span><span class="p">.</span><span class="nf">UseWebApi</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="step-03-add-the-controller">Step 03. Add the controller</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">TldController</span> <span class="p">:</span> <span class="n">ApiController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">HttpResponseMessage</span> <span class="nf">Get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">supportedTLDPage</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"AWS-URL"</span><span class="p">];</span>
        <span class="kt">var</span> <span class="n">tldProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TldListProvider</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">tldList</span> <span class="p">=</span> <span class="n">tldProvider</span><span class="p">.</span><span class="nf">GetSupportedTldList</span><span class="p">(</span><span class="n">supportedTLDPage</span><span class="p">);</span>
        <span class="kt">var</span> <span class="n">output</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span>
            <span class="n">url</span> <span class="p">=</span> <span class="n">supportedTLDPage</span><span class="p">,</span> 
            <span class="n">date</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(),</span>
            <span class="n">tldList</span> <span class="p">=</span> <span class="n">tldList</span><span class="p">.</span><span class="nf">Select</span><span class="p">(</span><span class="n">tld</span> <span class="p">=&gt;</span> <span class="n">tld</span><span class="p">.</span><span class="n">Name</span><span class="p">)</span>
        <span class="p">};</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="nf">CreateResponse</span><span class="p">(</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">OK</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="step-04-start-owin-webapp">Step 04. Start OWIN WebApp</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">void</span> <span class="nf">Start</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">baseAddress</span> <span class="p">=</span> <span class="n">ConfigurationManager</span><span class="p">.</span><span class="n">AppSettings</span><span class="p">[</span><span class="s">"BaseAddress"</span><span class="p">];</span>
    <span class="n">WebApp</span><span class="p">.</span><span class="n">Start</span><span class="p">&lt;</span><span class="n">Startup</span><span class="p">&gt;(</span><span class="n">url</span><span class="p">:</span> <span class="n">baseAddress</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Service started"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Final step is installation. As I used TopShelf all I had to do was running a command prompt with administrator privileges run this command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TldProvider.Service.exe install

</code></pre></div></div>

<p>Now that my service is running in the background and accepting HTTP requests let’s take it out for a spin:</p>

<p><img src="/images/vpblogimg/2015/08/domchk53-self-hosted-service-output.png" alt=""></p>

<p>Brilliant!</p>

<h3 id="whats-next">What’s next?</h3>
<p>So now I have an API that returns me the supported TLD list. In the next post I’ll work on a basic client that consumes that API and AWS Route53 to get the availability results finally.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/aws-tld-provider" target="_blank" rel="noopener noreferrer">Project source code on GitHub</a></li>
  <li><a href="https://aws.amazon.com/blogs/aws/amazon-api-gateway-build-and-run-scalable-application-backends/" target="_blank" rel="noopener noreferrer">Amazon API Gateway Announcement</a></li>
  <li><a href="http://aws.amazon.com/api-gateway/" target="_blank" rel="noopener noreferrer">Amazon API Gateway official site</a></li>
  <li><a href="http://docs.aws.amazon.com/lambda/latest/dg/programming-model.html" target="_blank" rel="noopener noreferrer">AWS Documentation: Lambda programming model</a></li>
  <li><a href="http://owin.org/" target="_blank" rel="noopener noreferrer">OWIN official website</a></li>
  <li><a href="http://www.asp.net/web-api/overview/hosting-aspnet-web-api/use-owin-to-self-host-web-api" target="_blank" rel="noopener noreferrer">Use OWIN to Self-Host ASP.NET Web API 2</a></li>
</ul>

		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/24" class="prev">Prev</a>
    
    
        <a href="/page/26" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2021 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
