<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/23/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script data-ad-client="ca-pub-0414743900624675" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35583486-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/10/07/mail-automation-with-aws-lambda-and-sns/" itemprop="url">Mail automation with AWS Lambda and SNS</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-10-07T15:00:00+01:00" itemprop="datePublished">October  7, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">lambda, s3, sns</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<blockquote>
  <p>UPDATE: Yesterday (October 8th, 2015) Amazon announced official support for scheduled events so I updated my function to use this feature. 
For the most up-to-date version of this project please visit the <a href="https://volkanpaksoy.com/archive/2015/10/09/aws-lambda-official-scheduling-support/">updated version</a></p>
</blockquote>

<p>I have a great accountant but he has one flaw: I have to ask for the invoice every month! While waiting for him to automate the process, I decided to automate what I can on my end. There are many ways to skin a cat, as the saying goes, the way I picked for this task was developing an AWS Lambda funciton and trigger it by subscribing to a public SNS topic.</p>

<h2 id="step-1-prepare-a-function-to-send-emails">Step 1: Prepare a function to send emails</h2>
<p>Developing a simple node.js function that sends E-mails was simple. First I needed the install two modules:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install nodemailer
npm install nodemailer-smtp-transport
</code></pre></div></div>

<p>And the function is straightforward:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">transporter</span> <span class="o">=</span> <span class="nx">nodemailer</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">(</span><span class="nx">smtpTransport</span><span class="p">({</span>
    <span class="na">host</span><span class="p">:</span> <span class="s1">'email-smtp.eu-west-1.amazonaws.com'</span><span class="p">,</span>
    <span class="na">port</span><span class="p">:</span> <span class="mi">587</span><span class="p">,</span>
    <span class="na">auth</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">user</span><span class="p">:</span> <span class="s1">'{ACCESS KEY}'</span><span class="p">,</span>
        <span class="na">pass</span><span class="p">:</span> <span class="s1">'{SECRET KEY}'</span>
    <span class="p">}</span>
<span class="p">}));</span>

<span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="s1">'Hi, Invoice! Thanks!'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">mailOptions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">from</span><span class="p">:</span> <span class="s1">'from@me.net'</span><span class="p">,</span>
    <span class="na">to</span><span class="p">:</span> <span class="s1">'to@someone.net'</span><span class="p">,</span>
    <span class="na">bcc</span><span class="p">:</span> <span class="s1">'me2@me.com'</span><span class="p">,</span>
    <span class="na">subject</span><span class="p">:</span> <span class="s1">'Invoice'</span><span class="p">,</span>
    <span class="na">text</span><span class="p">:</span> <span class="nx">text</span> 
<span class="p">};</span>

<span class="nx">transporter</span><span class="p">.</span><span class="nx">sendMail</span><span class="p">(</span><span class="nx">mailOptions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">info</span><span class="p">){</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Message sent'</span><span class="p">);</span>
      <span class="p">}</span>
  <span class="p">});</span>
</code></pre></div></div>

<p>The challenge was deployment as the script had some dependencies. If you choose Edit Inline and just paste the script you would get an error like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"errorMessage": "Cannot find module 'nodemailer'",
</code></pre></div></div>

<p>But it’s very easy to deploy a full package with dependencies. Just zip everything in the folder (wihtout the folder itself) and upload the zip file. The downside of this method is you can no longer edit the code inline. So even just for fixing a trivial typo you need to re-zip and re-upload.</p>

<h2 id="step-2-schedule-the-process">Step 2: Schedule the process</h2>
<p>One simple method to schedule the process is to invoke the method using Powershell and schedule a task to run the script:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Invoke-LMFunction -FunctionName automatedEmails -AccessKey accessKey -SecretKey secretKey -Region eu-west-1
</code></pre></div></div>

<p>But I don’t want a dependency on any machine (local or EC2 instance). Otherwise I could write a few lines of code in C# to do the same job anyway. The idea of using Lambda is to avoid maintenance and let everything run on infrastructure that’s maintained by AWS.</p>

<h3 id="unreliable-town-clock">Unreliable Town Clock</h3>
<p>Unfortunately AWS doesn’t provide an easy method to schedule Lambda function invocations. For the sake of simplicity I decided to use <a href="https://alestic.com/2015/05/aws-lambda-recurring-schedule/" target="_blank" rel="noopener noreferrer">Unreliable Town Clock (UTC)</a> which is essentially a public SNS topic that sends “chime” messages every 15 minutes.</p>

<p><img src="/images/vpblogimg/2015/10/mail-automation-sns-subscription.png" alt=""></p>

<p>Since all I need is one email, I don’t care if it skips a beat or two as long as it chimes at least once throughout the day.</p>

<h3 id="state-management">State management</h3>
<p>Of course to avoid bombarding my accountant with emails I have to maintain a state so that I would only send one email per month. But Lambda functions must be stateless. Some alternatives are using AWS S3 or DynamoDB. Since all I need is one simple integer value I decided to store in a text file on S3. So first I download the log file and check the last sent email month:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">downloadLog</span><span class="p">(</span><span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s3</span><span class="p">.</span><span class="nx">getObject</span><span class="p">({</span>
			<span class="na">Bucket</span><span class="p">:</span> <span class="nx">bucketName</span><span class="p">,</span>
			<span class="na">Key</span><span class="p">:</span> <span class="nx">fileName</span>
		<span class="p">},</span>
		<span class="nx">next</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">checkDate</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">currentDay</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Sns</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">day</span><span class="p">);</span>
	<span class="nx">currentMonth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Records</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Sns</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">month</span><span class="p">);</span>
	<span class="kd">var</span> <span class="nx">lastMailMonth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">toString</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">lastMailMonth</span><span class="p">))</span> <span class="p">{</span>
		<span class="nx">lastMailMonth</span> <span class="o">=</span> <span class="nx">currentMonth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="nx">currentDay</span> <span class="o">==</span> <span class="nx">targetDayOfMonth</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">currentMonth</span> <span class="o">&gt;</span> <span class="nx">lastMailMonth</span><span class="p">))</span> <span class="p">{</span>
		<span class="nx">next</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="putting-it-together">Putting it together</h3>
<p>So putting it all together the final code is:</p>

<noscript><pre>400: Invalid request</pre></noscript>
<script src="https://gist.github.com/01d54e98dcc1cd0b3dcfaf12e57bc4fe.js"> </script>

<p>Let’s see if it’s going to help me get my invoices automatically!</p>

<h2 id="conclusion">Conclusion</h2>
<ul>
  <li>
    <p>A better approach would be to check emails for the invoice and send only if it wasn’t received already. Also a copule of reminders after the initial email would be nice. But as my new resolution is to progress in small, incremental steps I’ll call it version 1.0 and leave the remaining tasks for a later version.</p>
  </li>
  <li>
    <p>My main goal was to achieve this task without having to worry about the infrastructure. I still don’t but that’s only because a nice guy (namely Eric Hammond) decided to setup a public service for the rest of us.</p>
  </li>
  <li>
    <p>During my research I came across a few references saying that the same task can be done using AWS Simple Workflow (SWF). I haven’t used this service before. Looked complicated and felt like there is a steep learning curve to go through. In Version 2 I should look into SWF which would…</p>

    <ul>
      <li>allow me to handle a complex workflow</li>
      <li>make dependency to public SNS topic redundant</li>
      <li>handle state properly</li>
    </ul>
  </li>
</ul>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://javascript.tutorialhorizon.com/2015/07/02/send-email-node-js-express/" target="_blank" rel="noopener noreferrer">Send email using nodejs and express in 5 simple steps</a></li>
  <li><a href="https://aws.amazon.com/blogs/compute/nodejs-packages-in-lambda/" target="_blank" rel="noopener noreferrer">Using Packages and Native nodejs Modules in AWS Lambda</a></li>
  <li><a href="http://docs.aws.amazon.com/lambda/latest/dg/walkthrough-s3-events-adminuser-create-test-function-create-function.html" target="_blank" rel="noopener noreferrer">Create a Lambda Function Deployment Package</a></li>
  <li><a href="https://alestic.com/2015/05/aws-lambda-recurring-schedule/" target="_blank" rel="noopener noreferrer">Schedule Recurring AWS Lambda Invocations With The Unreliable Town Clock (UTC)</a></li>
  <li><a href="https://aws.amazon.com/about-aws/whats-new/2015/08/trigger-aws-lambda-functions-using-amazon-simple-workflow/" target="_blank" rel="noopener noreferrer">Trigger AWS Lambda Functions Using Amazon Simple Workflow</a></li>
  <li><a href="http://docs.aws.amazon.com/amazonswf/latest/awsflowguide/lambda-task.html" target="_blank" rel="noopener noreferrer">Implementing AWS Lambda Tasks</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/10/01/creating-pdfs-from-images-with-csharp-and-wpf/" itemprop="url">Creating PDFs from Images with C# and WPF</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-10-01T00:00:00+01:00" itemprop="datePublished">October  1, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">csharp, wpf</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>I like scanning all my documents and keep a digital version as well as the dead-tree version just in case. But storing the documents as individual image files is too messy. There are various solutions to merge image files into a single PDF but I don’t want to upload my sensitive documents to unknown parties so I rolled my own: <a href="https://github.com/volkanpaksoy/image2pdf" target="_blank" rel="noopener noreferrer">Image2PDF</a></p>

<h2 id="implementation">Implementation</h2>
<p>I decided to go with a WPF application rathen than a web-based solution because it would be unnecessary to upload a bunch of image files to cloud and download the PDF back. It’s a lot of network traffic for something that can be handled locally much faster.</p>

<p>Image2PDF a simple WPF application developed in C#. I’ve used <a href="http://sourceforge.net/projects/itextsharp" target="_blank" rel="noopener noreferrer">iTextSharp</a> library to create the PDFs. It’s a great open-source library with lots of capabilities.</p>

<p>I’ve also started using <a href="https://www.syncfusion.com/products/wpf" target="_blank" rel="noopener noreferrer">SyncFusion WPF control library</a> recently. The entire control suite is free of charge (which is always a great price!). It has a Wizard control which I decided to go with. I think using a wizard and is cleaner UI instead of dumping every control on one window.</p>

<h2 id="usage">Usage</h2>
<p>As you might expect you provide the list of input images, re-order them if needed, choose the path for the output folder and go!</p>

<p>Step 1: Select input</p>

<p><img src="/images/vpblogimg/2015/09/image2pdf-page1.png" alt="Page 1: Specify input image files"></p>

<p>Step 2: Select output</p>

<p><img src="/images/vpblogimg/2015/09/image2pdf-page2.png" alt="Page 2: Specify output PDF path"></p>

<p>Step 3: Go!</p>

<p><img src="/images/vpblogimg/2015/09/image2pdf-page3.png" alt="Page 3: Run!"></p>

<p>Simples!</p>

<h2 id="conclusion">Conclusion</h2>
<p>In the future I’m planning to add various PDF operarions and enhance the functionality but since shipping is a feature I’ll limit the scope for now. After all, this was the main feature I needed anyway.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/image2pdf" target="_blank" rel="noopener noreferrer">Source code</a></li>
  <li><a href="http://sourceforge.net/projects/itextsharp/" target="_blank" rel="noopener noreferrer">iTextSharp project page</a></li>
  <li><a href="https://www.syncfusion.com/products/wpf" target="_blank" rel="noopener noreferrer">SyncFusion Essential Studio for WPF</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/09/18/from-json-to-neo4j/" itemprop="url">From JSON to Neo4J</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-09-18T16:30:00+01:00" itemprop="datePublished">September 18, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">csharp, neo4j, cypher, json</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>I have a simple JSON file that contained a bunch of users with their followers which looked like this:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="p">{</span><span class="w">
    </span><span class="s2">"user-id"</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w">
    </span><span class="s2">"username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"user_2"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"avatar"</span><span class="p">:</span><span class="w"> </span><span class="s2">"URL"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"following"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"user_10"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"user_6"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"user_1"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="s2">"followers"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"user_10"</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>It felt like a good exercise would be to import that data into a graph database as it wasn’t something I had done before.</p>

<p>As my go-to language is C# and I had some experience with Cypher before, my initial instinct was to develop a tool to generate Cypher statements from the JSON.</p>

<p>First I create the nodes:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">GenerateNodesCypher</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">@"..\..\output\nodes.cql"</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">output</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>

    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">user</span> <span class="k">in</span> <span class="n">_userList</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="s">$"CREATE (</span><span class="p">{</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">}</span><span class="s">:User </span><span class="p">{{</span> <span class="n">userid</span><span class="p">:</span> <span class="p">{</span><span class="n">user</span><span class="p">.</span><span class="n">userid</span><span class="p">}</span> <span class="p">,</span> <span class="n">username</span><span class="p">:</span> <span class="err">'</span><span class="p">{</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">}</span><span class="err">'</span><span class="p">,</span> <span class="n">avatar</span><span class="p">:</span> <span class="err">'</span><span class="p">{</span><span class="n">user</span><span class="p">.</span><span class="n">avatar</span><span class="p">}</span><span class="err">'</span>  <span class="p">}}</span><span class="s"> ); "</span><span class="p">;</span>
        <span class="n">output</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">File</span><span class="p">.</span><span class="nf">WriteAllText</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and then the relationships:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">void</span> <span class="nf">GenerateRelationshipsCypher</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">filename</span> <span class="p">=</span> <span class="s">@"..\..\output\relationships.cql"</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">output</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">user</span> <span class="k">in</span> <span class="n">_userList</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">following</span> <span class="k">in</span> <span class="n">user</span><span class="p">.</span><span class="n">following</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">string</span> <span class="n">s</span> <span class="p">=</span> <span class="s">$"MATCH (a), (b) WHERE a.username = '</span><span class="p">{</span><span class="n">user</span><span class="p">.</span><span class="n">username</span><span class="p">}</span><span class="s">' AND b.username = '</span><span class="p">{</span><span class="n">following</span><span class="p">}</span><span class="s">' CREATE (a)-[:FOLLOWING]-&gt;(b); "</span><span class="p">;</span>
            <span class="n">output</span><span class="p">.</span><span class="nf">AppendLine</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
            <span class="n">n</span><span class="p">++;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">File</span><span class="p">.</span><span class="nf">WriteAllText</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">output</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So I ended up with two cql files that looked like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE (user_1:User { userid: 1 , username: 'user_1', avatar: 'URL' }); 
CREATE (user_2:User { userid: 2 , username: 'user_2', avatar: 'URL' }); 
CREATE (user_3:User { userid: 3 , username: 'user_3', avatar: 'URL' }); 
</code></pre></div></div>

<p>and</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (a), (b) WHERE a.username = 'user_1' AND b.username = 'user_26' CREATE (a)-[:FOLLOWING]-&gt;(b); 
MATCH (a), (b) WHERE a.username = 'user_1' AND b.username = 'user_53' CREATE (a)-[:FOLLOWING]-&gt;(b); 
MATCH (a), (b) WHERE a.username = 'user_2' AND b.username = 'user_6' CREATE (a)-[:FOLLOWING]-&gt;(b); 
</code></pre></div></div>

<p>and I used neo4j-shell to execute the files and import the data. But it was no bed of roses. I’ll list the problems I faced along the way and how I got around them so that this experience might be helpful for other people as well:</p>

<h2 id="issues-along-the-way-and-lessons-learned">Issues along the way and lessons learned</h2>

<h3 id="running-multiple-statements-on-neo4j-browser">Running multiple statements on Neo4J browser</h3>
<p>First I tried to run the create statements using the Neo4J browser which turned out to be problematic because it cannot run multiple statements that end with semi-colons. So I removed the semi-colons but then it started giving me this error</p>

<blockquote>
  <p>WITH is required between CREATE and MATCH</p>
</blockquote>

<p>I found a workaround for that on <a href="http://stackoverflow.com/questions/21778435/multiple-unrelated-queries-in-neo4j-cypher" target="_blank" rel="noopener noreferrer">SO</a>. So the following works:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (a), (b) WHERE a.username = 'user_1' AND b.username = 'user_14' CREATE (a)-[:FOLLOWING]-&gt;(b); 
WITH 1 as dummy
MATCH (a), (b) WHERE a.username = 'user_1' AND b.username = 'user_22' CREATE (a)-[:FOLLOWING]-&gt;(b); 
</code></pre></div></div>

<p>Now the problem was, if the data was a bit dirty, for instance if user_14 didn’t exist, it stopped executing the rest and no other relationships were created). I had a few nodes like that so this method didn’t work for me after all.</p>

<h3 id="starting-the-shell-was-not-as-easy-as-id-imagined">Starting the shell was not as easy as I’d imagined</h3>
<p>I installed Neo4J using the default settings and to start the shell just navigated to that directory and ran the batch file. Got an error instead of my shell:</p>

<blockquote>
  <p>C:\Program Files\Neo4j Community\bin&gt;Neo4jShell.bat</p>
</blockquote>

<blockquote>
  <p>The system cannot find the path specified.</p>
</blockquote>

<blockquote>
  <p>Error: Could not find or load main class org.neo4j.shell.StartClient</p>
</blockquote>

<p>Apparently the way to run the shell is using the Neo4J server application and clicking <em>Options</em> -&gt; <em>Command Prompt</em></p>

<p><img src="/images/vpblogimg/2015/09/from-json-to-neo4j-command-prompt.png" alt="Neo4J command prompt"></p>

<p>This launches the Neo4J Command Prompt then the rest is easy:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>neo4jshell -file nodes.cql

neo4jshell -file relationships.cql
</code></pre></div></div>

<h3 id="exiting-with-unterminated-multi-line-input">“Exiting with unterminated multi-line input”</h3>
<p>Final issue was the statements in a sql file must be terminated with a semi-colon in order for the shell to execute them. Otherwise it gives the above warning and quits</p>

<p>So after all this hassle my data is in the Neo4J database ready to be queried to death!:</p>

<p><img src="/images/vpblogimg/2015/09/from-json-to-neo4j-final-database.png" alt=""></p>

<p>Next I’ll investigate converting the data into CSV and achieve the same results by using LOAD CSV command and look into visualization of this data.</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://stackoverflow.com/questions/21778435/multiple-unrelated-queries-in-neo4j-cypher" target="_blank" rel="noopener noreferrer">Workaround for running multiple statements on Neo4J browser</a></li>
  <li><a href="http://neo4j.com/docs/stable/query-load-csv.html" target="_blank" rel="noopener noreferrer">Neo4J documentation for LOAD CSV</a></li>
</ul>

		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/22" class="prev">Prev</a>
    
    
        <a href="/page/24" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2021 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
