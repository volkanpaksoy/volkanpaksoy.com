<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/page/26/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35583486-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
<!-- vp.com - default -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">



    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/08/05/checking-domain-availability-with-aws-route53-part-1/" itemprop="url">Checking domain availability with AWS Route 53 - Part 1</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-08-05T00:00:00+01:00" itemprop="datePublished">August  5, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/devaws">dev</a></span> -->

<!-- dev, aws -->




    <a href="/category/dev">dev</a>
    , 

    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">csharp, javascript, route53</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<h1 id="part-1-getting-supported-tld-list">Part 1: Getting supported TLD List</h1>

<p>Around this time last year Amazon <a href="https://aws.amazon.com/blogs/aws/route-53-domain-reg-geo-route-price-drop/" target="_blank" rel="noopener noreferrer">announced</a> the Route 53 update which allowed domain registrations.</p>

<p><img src="/images/vpblogimg/2015/08/domchk53-route53-search-user-interface.png" alt="Domain search in Route 53"></p>

<p>Unfortunately, the AWS Management Console UI doesn’t allow searching all TLDs at once for a given domain. So I set out to write a console application in C# that retrieved the TLDs from AWS API in order to “enhance” AWS a bit. As all of my projects, the scope got out of hand very quickly so I decided to break this adventure into smaller parts. In this post I’ll talk about how to get the supported TLD list.</p>

<h3 id="aws-everything-is-api-based-right-not-quite">AWS: Everything is API-based, right? Not quite!</h3>
<p>The first step to a domain checker application is to acquire a list of TLDs to check. So I started exploring AWS API to get the supported TLD list. To my surprise there wasn’t any! I asked the question in AWS support forums and the response is it’s not supported. There is a webpage that has the list but that’s it! So until they make it available I decided to do a little scraping to generate the list myself. Obviously this is not the proper way of doing it and it’s prone to breaking very easily but they gave me no choice!</p>

<h3 id="first-method-c-library">First method: C# Library</h3>
<p>It’s just one method and it was easy to implement (apart from fiddling with regular expressions!)</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tld</span><span class="p">&gt;</span> <span class="nf">GetSupportedTldList</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">Uri</span> <span class="n">supportedTldPage</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Uri</span><span class="p">(</span><span class="s">"http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar-tld-list.html"</span><span class="p">);</span>
    <span class="kt">string</span> <span class="n">pageHtml</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">webclient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">pageHtml</span> <span class="p">=</span> <span class="n">webclient</span><span class="p">.</span><span class="nf">DownloadString</span><span class="p">(</span><span class="n">supportedTldPage</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">string</span> <span class="n">pattern</span> <span class="p">=</span> <span class="s">"&lt;a class=\"xref\" href=\"registrar-tld-list.html#.+?\"&gt;[.](.+?)&lt;/a&gt;"</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">matches</span> <span class="p">=</span> <span class="n">Regex</span><span class="p">.</span><span class="nf">Matches</span><span class="p">(</span><span class="n">pageHtml</span><span class="p">,</span> <span class="n">pattern</span><span class="p">);</span>

    <span class="kt">var</span> <span class="n">result</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Tld</span><span class="p">&gt;();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="n">Match</span> <span class="n">m</span> <span class="k">in</span> <span class="n">matches</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">result</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">Tld</span><span class="p">()</span> <span class="p">{</span> <span class="n">Name</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">Groups</span><span class="p">[</span><span class="m">1</span><span class="p">].</span><span class="n">Value</span> <span class="p">});</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It first downloads the raw HTML from the AWS documentation page. The TLDs on the page have a link in this format:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"xref"</span> <span class="na">href=</span><span class="s">"registrar-tld-list.html#cab"</span><span class="nt">&gt;</span>.cab<span class="nt">&lt;/a&gt;</span> 
</code></pre></div></div>

<p>The regular expression pattern retrieves all anchors in this format. Only the ones that contain a dot in the value are retrieved to eliminate irrelevant links. To extract the actual TLD from this matching string I used parenthesis to create a group. By default the whole matched string is the first group. Additional groups can be created by parenthesis so that we can only get the values we are interested in. For example the group values for a match look like this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>m.Groups[0].Value: "&lt;a class=\"xref\" href=\"registrar-tld-list.html#academy\"&gt;.academy&lt;/a&gt;"
m.Groups[1].Value: "academy"
</code></pre></div></div>

<p>Adds these extracted values to a list (for now Tld class only contains Name property, more info like type of TLD or description can be added in the future)</p>

<h3 id="second-method-javascript">Second method: JavaScript</h3>
<p>It’s not very complicated with C# to accomplish this task so I thought it would be even easier with JavaScript as I already tackled the regular expression bit. I couldn’t be wronger!</p>

<p>I created a simple AJAX call with jQuery and got the following error:</p>

<p><img src="/images/vpblogimg/2015/08/domchk53-cors-error.png" alt=""></p>

<p>Apparently you cannot get external resources willy nilly using jQuery! It took some time but I found a neat workaround <a href="http://james.padolsey.com/javascript/cross-domain-requests-with-jquery/" target="_blank" rel="noopener noreferrer">here</a> It’s essentially a jQuery plugin sending the request to query.yahooapis.com instead of the URL we request. Apparently Yahoo API returns the results to a callback method we provide. I hadn’t heard about <a href="https://developer.yahoo.com/yql/" target="_blank" rel="noopener noreferrer">YQL</a> before. The pitch on their site is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"The YQL (Yahoo! Query Language) platform enables you to query, filter, and combine data across the web through a single interface." 
</code></pre></div></div>

<p>so a bit explains why they allow Cross-domain queries.</p>

<p>In the test page I added the plugin script</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;script-- src="jquery.xdomainajax.js"&gt;&lt;/script&gt;
</code></pre></div></div>

<p>Then the main function using jQuery worked just fine:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">supportedTldPage</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar-tld-list.html</span><span class="dl">"</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">getTldList</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
        <span class="na">url</span><span class="p">:</span> <span class="nx">supportedTldPage</span><span class="p">,</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">,</span>
        <span class="na">success</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">pageHtml</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">jsonResult</span> <span class="o">=</span> <span class="nx">parseHtml</span><span class="p">(</span><span class="nx">pageHtml</span><span class="p">);</span>
            <span class="nx">callback</span><span class="p">(</span><span class="nx">jsonResult</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Another thing I tried was using pure JavaScript:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">getTldList</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="dl">"</span><span class="s2">GET</span><span class="dl">"</span><span class="p">,</span> <span class="nx">supportedTldPage</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">||</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">pageHtml</span> <span class="o">=</span> <span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">jsonResult</span> <span class="o">=</span> <span class="nx">parseHtml</span><span class="p">(</span><span class="nx">pageHtml</span><span class="p">);</span>
        <span class="nx">callback</span><span class="p">(</span><span class="nx">jsonResult</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This version doesn’t work by default because of the same CORS restrictions. But apparently there’s an <a href="https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi?hl=en" target="_blank" rel="noopener noreferrer">extension</a> for that. I installed it and it worked like a charm. Wondering what was happening behind the scenes I captured the request with Fiddler and it looked like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Host: docs.aws.amazon.com
Connection: keep-alive
Cache-Control: max-age=0
User-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.89 Safari/537.36
Origin: http://evil.com/
Accept: */*
Accept-Encoding: gzip, deflate, sdch
Accept-Language: en-US,en;q=0.8,tr;q=0.6
If-None-Match: "19ce8-51b1a64cfe880-gzip"
If-Modified-Since: Fri, 17 Jul 2015 23:17:38 GMT
</code></pre></div></div>

<p>Origin was “http://evil.com”! Works great as long as it’s not null! In the sample code I’ll leave both versions. Of course all this hassle is to bypass browser restrictions. Depending on your use case, you can always fire the HTTP request above in Fiddler and get the results. I guess it’s a nice mechanism if you need to implement a closed system and want to ensure that resources are not consumed from the outside. Of course for public web pages like this which are meant to be accessed from anywhere in the world there are no restrictions on the server side.</p>

<p>So that now we can get the raw HTML from AWS documentation, the rest is smooth sailing. The part that handles finding the TLDs in the HTML is very similar:</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">parseHtml</span><span class="p">(</span><span class="nx">pageHtml</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">pattern</span> <span class="o">=</span> <span class="sr">/&lt;a class="xref" href="registrar-tld-list.html#.+</span><span class="se">?</span><span class="sr">"&gt;</span><span class="se">[</span><span class="sr">.</span><span class="se">](</span><span class="sr">.+</span><span class="se">?)</span><span class="sr">&lt;</span><span class="se">\/</span><span class="sr">a&gt;/g</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">regEx</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">pattern</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">supportedTldPage</span><span class="p">;</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">toUTCString</span><span class="p">();</span>
    <span class="nx">result</span><span class="p">.</span><span class="nx">tldList</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span> <span class="p">((</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">regEx</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">pageHtml</span><span class="p">))</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span><span class="p">.</span><span class="nx">tldList</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">myString</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">myString</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The regular expression pattern is the same. The only difference is .exec method doesn’t return mutliple matches so you have to loop through unless there are no matches.</p>

<p>So finally the result in JSON format is:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar-tld-list.html"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"date"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Tue, 29 Jul 2015 20:26:02 GMT"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"tldList"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="s2">"academy"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"agency"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"bargains"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"bike"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"biz"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"blue"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"boutique"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"-- removed for brevity --"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"eu"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"fi"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"fr"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"it"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"me"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"me.uk"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"nl"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"org.uk"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"ruhr"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"se"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"wien"</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="whats-next">What’s next?</h3>
<p>Now I have the supported TLD list. I can easily use it in my application but where’s the fun that? I’d rather convert this code into an API so that we can get the new TLDs whenever they are added to that page. I just they don’t change their HTML markup anytime soon! :-)</p>

<p>So in the next post I’ll work on the API…</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/aws-tld-provider" target="_blank" rel="noopener noreferrer">Project source code on GitHub</a></li>
  <li><a href="https://aws.amazon.com/blogs/aws/route-53-domain-reg-geo-route-price-drop/" target="_blank" rel="noopener noreferrer">AWS Route 53 Domain Registration announcement</a></li>
  <li><a href="http://docs.aws.amazon.com/Route53/latest/DeveloperGuide/registrar-tld-list.html" target="_blank" rel="noopener noreferrer">Route 53 Supported TLD documentation</a></li>
  <li><a href="http://james.padolsey.com/javascript/cross-domain-requests-with-jquery/" target="_blank" rel="noopener noreferrer">Cross Domain Requests with jQuery</a></li>
  <li><a href="https://github.com/padolsey-archive/jquery.fn/tree/master/cross-domain-ajax" target="_blank" rel="noopener noreferrer">Cross-domain-AJAX Plugin</a></li>
  <li><a href="https://developer.yahoo.com/yql/" target="_blank" rel="noopener noreferrer">YQL website</a></li>
  <li><a href="https://chrome.google.com/webstore/detail/allow-control-allow-origi/nlfbmbojpeacfghkpbjhddihlkkiljbi?hl=en" target="_blank" rel="noopener noreferrer">Chrome Extension to allow CORS</a></li>
</ul>

		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/07/24/configuration-file-management-on-GitHub/" itemprop="url">Configuration File Management on GitHub</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-07-24T22:30:00+01:00" itemprop="datePublished">July 24, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">dotnet, configuration, github</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>I hate configuration files! They contain highly sensitive information and there is always a risk of them leaking out. Especially when I read horror stories like <a href="http://wptavern.com/ryan-hellyers-aws-nightmare-leaked-access-keys-result-in-a-6000-bill-overnight" target="_blank" rel="noopener noreferrer">this</a> I remind myself to be more careful about it. It is particularly important when starting off with a private repository and converting it to open-source.</p>

<p>There are a few approaches and I will try to make pros and cons list for each of them which hopefully would make it easier for me to make a decision.</p>

<h3 id="method-1-ignore-config-files-completely">Method 1: Ignore config files completely</h3>
<p>Simply add to gitignore before checking in the config files. This is not really a viable option but to cover all basis I wanted to add this one as well.</p>

<h4 id="pros">Pros</h4>
<ul>
  <li>Very easy to implement</li>
  <li>Easy to be consistent (use the same gitignore everywhere)</li>
</ul>

<h4 id="cons">Cons</h4>
<ul>
  <li>When someone checks out the project initially it wouldn’t compile because of the missing config file.</li>
  <li>For a new user there is no way to figure out what the actual config should look like</li>
  <li>For internal applications, you have to maintain local copies and handle distribution among developers manually.</li>
</ul>

<h3 id="method-2-check-in-configuration-with-placeholders">Method 2: Check in configuration with placeholders</h3>
<p>Check in the initial file then run the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git update-index --assume-unchanged &lt;file&gt;
</code></pre></div></div>

<p>After this you can add the actual values and use the config as usual. But those values will be ignored. This way when someone checks out they can at least compile the project.</p>

<h4 id="pros-1">Pros</h4>
<ul>
  <li>Less disruptive as the project can be compiled</li>
</ul>

<h4 id="cons-1">Cons</h4>
<ul>
  <li>When you make a change to the config file (e.g. add/rename keys) you can’t check in those changes as well</li>
</ul>

<h3 id="method-3-ignore-config-file-check-in-a-sample-file-instead">Method 3: Ignore config file, check in a sample file instead</h3>
<p>This is essentially a merger of Method 1 and 2. Maintain two files (e.g. App.config and App.config.sample). Ignore the app.config from the getgo and only check in .sample file. Structurally it will be exactly the same as app.config without the confidential values.</p>

<h4 id="pros-2">Pros</h4>
<ul>
  <li>Won’t compile by default, extra step for the people who check out (small one but still)</li>
</ul>

<h4 id="cons-2">Cons</h4>
<ul>
  <li>Both files need to be kept in sync manually</li>
  <li>Still no online copy of the actual config file available</li>
</ul>

<h3 id="method-4-reference-to-another-configuration-file">Method 4: Reference to another configuration file</h3>
<p>A slight variation of the previous method. .NET allows cascading and linking with configuration files. For example say this is my app.config file:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;configuration&gt;</span>
	<span class="nt">&lt;appSettings</span> <span class="na">file=</span><span class="s">"Actual.config"</span><span class="nt">&gt;</span>
		<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"Twilio.AccountSID"</span> <span class="na">value=</span><span class="s">"SAMPLE SID"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"Twilio.AuthToken"</span> <span class="na">value=</span><span class="s">"SAMPLE TOKEN"</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"Non-sensitive-info"</span> <span class="na">value=</span><span class="s">"some value"</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/appSettings&gt;</span>
<span class="nt">&lt;/configuration&gt;</span>
</code></pre></div></div>

<p>I can link the appSettings section to another file named actual.config which would look like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;appSettings&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"Twilio.AccountSID"</span> <span class="na">value=</span><span class="s">"REAL 123456"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"Twilio.AuthToken"</span> <span class="na">value=</span><span class="s">"REAL Token"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;add</span> <span class="na">key=</span><span class="s">"Non-sensitive-info"</span> <span class="na">value=</span><span class="s">"some value"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/appSettings&gt;</span>
</code></pre></div></div>

<p>Actual.config never goes into source control. When the application cannot find the actual.config it just uses the values in the app.config. When the actual.config is present, those values override the sample values.</p>

<h4 id="pros-3">Pros</h4>
<ul>
  <li>Only keys with sensitive values can be hidden</li>
</ul>

<h4 id="cons-3">Cons</h4>
<ul>
  <li>Doesn’t work with custom config sections</li>
  <li>Still no online copy of the actual config file available</li>
</ul>

<h3 id="method-5-use-submodules-to-link-to-config-files">Method 5: Use submodules to link to config files</h3>
<p>The idea is to maintain a private repository that contains the config files and add it as a submodule:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git submodule add git@github.com:volkanpaksoy/private-config.git
</code></pre></div></div>

<p>And link to that configuration file in the app.config as in Method 4.</p>

<h4 id="pros-4">Pros</h4>
<ul>
  <li>Actual values are online and accessible</li>
</ul>

<h4 id="cons-4">Cons</h4>
<ul>
  <li>Requires a paid account for private repositories</li>
  <li>More complicated</li>
</ul>

<h3 id="verdict">Verdict</h3>
<p>As I already have a paid GitHub account the con for Method 5 is not quite valid for me so I think I will go with that one. Otherwise the actual values will be stored locally on the disk only and will eventually get lost. Looks like there is no convenient and easy way of doing it after all. If you have any suggestions I’m all ears.</p>

<p>As I said, I hate configuration files!</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://gitready.com/intermediate/2009/02/18/temporarily-ignoring-files.html" target="_blank" rel="noopener noreferrer">Temporarily ignoring files</a></li>
  <li><a href="http://stackoverflow.com/questions/4743770/git-collaboration-how-to-manage-configuration-files" target="_blank" rel="noopener noreferrer">SO Thread: Git sample and default files</a></li>
  <li><a href="http://msdevshow.com/2014/07/github-with-phil-haack/" target="_blank" rel="noopener noreferrer">Phil Haack on MSDevShow</a></li>
  <li><a href="http://stackoverflow.com/questions/5252450/using-someone-elses-repo-as-a-git-submodule-on-github" target="_blank" rel="noopener noreferrer">SO Thread: Using other repositories as submodules</a></li>
</ul>


		
		
	</div>


    </article>




    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
        
	<h1 class="title" itemprop="name"><a href="/archive/2015/07/22/disassembling-and-decompiling-dotnet-assemblies/" itemprop="url">Disassembling And Decompiling .NET Assemblies</a></h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-07-22T22:30:00+01:00" itemprop="datePublished">July 22, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/dev">dev</a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">csharp</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
		<p>Generally we don’t need to understand how every single line of code is compiled but sometimes it helps to have a look at what’s going on under the hood. The code we write doesn’t always translate directly to IL (Intermediate Language) by the compiler (assuming optimizations come into play). It also helps what really happens when we use shorthand notations in the language. So I decided to explore the IL and see how simple constructs are compiled. Some of them are very simple and commonly known but some of them were new to me so compiled all of them in this post.</p>

<h3 id="toolkit">Toolkit</h3>
<p>I used a disassembler and decompilers to analyze the output. When we compile a .NET program, it’s converted into IL code. Using a disassembler we can view the IL. Decompiling is the process of regenerating C# code. It’s hard to read IL so getting the C# code back helps to analyse easier. I used the following tools to view the IL and C# code:</p>

<ul>
  <li>ILDASM: Main tool I used is ILDASM (IL Disassembler). It’s installed with Visual Studio so doesn’t require anything special. It’s hard to make sense of IL but generally helpful to get an idea about what’s going on.</li>
  <li>Telerik JustDecompile: Decompiler takes an assembly and re-generates .NET code from it. It may not fully return the original source code and sometimes it optimizes stuff so it may skew the results a little bit. But it’s generally helpful when you need to see a cleaner representation</li>
  <li>ILSpy: Same functionality as JustDecompile. I used it to compare the decompiled results.</li>
</ul>

<p>So without further ado, here’s how some language basics we use are compiled:</p>

<h3 id="01-constructor">01. Constructor</h3>
<p>When you create a new class the template in Visual Studio creates a simple blank class like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nn">DecompileWorkout</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">TestClass</span>
    <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>and we can create instances of this class as usual:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">newInstance</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TestClass</span><span class="p">();</span>
</code></pre></div></div>

<p>It works even though we don’t have a constructor in our source code. The reason it works is that the compiler adds the default constructor for us. When we decompile the executable we can see it’s in there:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-default-ctor-01.png" alt=""></p>

<p>But when we add a constructor that accepts parameters the default constructor is removed:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-default-ctor-02.png" alt=""></p>

<p>It makes sense otherwise all classes would have parameterless constructor no matter what you do.</p>

<h3 id="02-properties">02. Properties</h3>
<p>Properties have been supported since forever and they are extremely handy. In the olden days we used to create a field and create getter and setter methods that access that field such as:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="kt">string</span> <span class="n">_name</span><span class="p">;</span>
<span class="k">public</span> <span class="k">void</span> <span class="nf">SetName</span><span class="p">(</span><span class="kt">string</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">_name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">public</span> <span class="kt">string</span> <span class="nf">GetName</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">_name</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now we can get the same results by</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>

<p>What happens under the hood is the compiler generates the backing field and getter/setter methods. For example if we disassemble the class with the above we’d get something like this:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-property-01.png" alt=""></p>

<p>Apart from the weird naming (I guess it’s to avoid naming collisions) it’s exactly the same code.</p>

<p>The backing field is only generated when this shorthand form is used. If we implement the getter/setter like this</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">string</span> <span class="n">Name</span> 
<span class="p">{</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">set</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Then the generated IL only contains the methods and not the backing field</p>

<p><img src="/images/vpblogimg/2015/07/decompile-property-02.png" alt=""></p>

<p>One last thing to note is that we cannot have fields on interfaces but we are allowed to have properties. It’s because when used on interfaces the compiler again generates only the getter and setter methods.</p>

<h3 id="03-using-statement">03. Using statement</h3>
<p>A handy shortcut to use when dealing with IDisposable objects is the using statement. To see what happens when we use using I came up with this simple code:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-using-code.png" alt=""></p>

<p>After decompiling:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-using-output.png" alt=""></p>

<p>So basically it just surrounds the code with a try-finally block and calls Dispose method of the object if it’s not null. Instead of writing this block of code it’s very handy to use the using statement. But at the end there is nothing magic about it, it’s just a shortcut to dispose objects securely.</p>

<h3 id="04-var-keyword-and-anonymous-types">04. var keyword and anonymous types</h3>
<p>var keyword is used to implicitly specify a type. The compiler infers the type from the context and generates the code accordingly. Variables defined with var keyword are still strongly typed because of this feature. Initially I resisted using it as a shortcut because it’s main purpose is not to provide the luxury not to create implicitly typed variables. It’s introduced at the same time as anonymous types which makes sense because without having such a keyword you cannot store anonymous objects. But I find myself using it more and more for implicitly specifying the types. Looking around I see that I’m not the only one so if it’s just laziness at least I’m not the only one to blame!</p>

<p>So let’s check out how this simple code with one var and an anonymous type:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UsingVarAndAnonymousTypes</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">UsingVarAndAnonymousTypes</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">someType</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SomeType</span><span class="p">();</span>
        <span class="kt">var</span> <span class="n">someAnonymousType</span> <span class="p">=</span> <span class="k">new</span> <span class="p">{</span> <span class="n">id</span> <span class="p">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">name</span> <span class="p">=</span> <span class="s">"whatevs"</span> <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Decompiling the code doesn’t show the anonymous type side of the story but we can see that var keyword is simply replaced with the class type.</p>

<p><img src="/images/vpblogimg/2015/07/decompile-var-and-anoymous-type-01.png" alt=""></p>

<p>To see what happens with anonymous types let’s have a look at the IL:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-var-and-anoymous-type-02.png" alt=""></p>

<p>For the anonymous type the compiler created a class for us with a very user-friendly name: <em>&lt;&gt;f__AnonymousType0`2</em>. It also generated readonly private fields and only getters that means they are immutable and we cannot set those values once the object is initialized.</p>

<h3 id="06-async-and-await">06. Async and await</h3>
<p>Async/await helps asynchronous programming much easier for us. It’s hiding a ton of complexity and I think it makes sense to invest some time into investigating how it works to use it properly. First of all, marking a method async doesn’t make everything asynchronous automagically. If you don’t use await inside the function it will run synchronously (the compiler will generate a warning about it). When you call an async method the execution continues without blocking the main thread. If it’s not awaited it returns a Task<tresult> instead of the actual expected result. This means it's an ongoing process and it will run in the background without blocking the main flow. This is great so you can fire up a bunch of tasks you need and then wait for the results whenever you need all of them. For example:</tresult></p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">async</span> <span class="k">void</span> <span class="nf">DownloadImageAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">imageUrl</span><span class="p">,</span> <span class="kt">string</span> <span class="n">localPath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">webClient</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">WebClient</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="n">Task</span> <span class="n">task</span> <span class="p">=</span> <span class="n">webClient</span><span class="p">.</span><span class="nf">DownloadFileTaskAsync</span><span class="p">(</span><span class="n">imageUrl</span><span class="p">,</span> <span class="n">localPath</span><span class="p">);</span>

        <span class="kt">var</span> <span class="n">hashCalculator</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SynchronousHashCalculator</span><span class="p">();</span>

        <span class="c1">// Do some more work while download is running</span>

        <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
        <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">fs</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">FileStream</span><span class="p">(</span><span class="n">localPath</span><span class="p">,</span> <span class="n">FileMode</span><span class="p">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="p">.</span><span class="n">Read</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="kt">byte</span><span class="p">[]</span> <span class="n">testData</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="k">new</span> <span class="nf">FileInfo</span><span class="p">(</span><span class="n">localPath</span><span class="p">).</span><span class="n">Length</span><span class="p">];</span>
            <span class="kt">int</span> <span class="n">bytesRead</span> <span class="p">=</span> <span class="k">await</span> <span class="n">fs</span><span class="p">.</span><span class="nf">ReadAsync</span><span class="p">(</span><span class="n">testData</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">testData</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
            
            <span class="c1">// Do something with testData</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this example, a file is downloaded asynchronously. The execution continues after the call has been made so we can do other unrelated work while the download is in progress. Only when we need the actual value, to open the file in this instance, we await the task. If we didn’t await we would try to access the file before it’s completely written and closed resulting in an exception.</p>

<p>One confusing aspect maybe calling await on the same line as in fs.ReadAsync in the above example. It looks like it’s synchronous as we are still waiting on the same line but the difference is the main thread is not blocked. If it’s a GUI-based application for exmaple it would still be responsive.</p>

<p>So let’s decompile the assembly to see how it works behind the scenes. This is one of the times I like having redundancy. Because Just Decompile failed to generate C# code for the class using async/await so I had to switch to ILSpy.</p>

<p><img src="/images/vpblogimg/2015/07/decompile-async-01.png" alt=""></p>

<p>It generates a struct implementing IAsyncStateMachine interface. The “meaty” part is the MoveNext method:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-async-02.png" alt=""></p>

<p>It’s very hard to read compiler-generated code but I think this part is interesting:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">switch</span> <span class="p">(</span><span class="k">this</span><span class="p">.&lt;&gt;</span><span class="m">1</span><span class="n">__state</span><span class="p">)</span>
<span class="p">{</span>
<span class="k">case</span> <span class="m">0</span><span class="p">:</span>
	<span class="n">taskAwaiter</span> <span class="p">=</span> <span class="k">this</span><span class="p">.&lt;&gt;</span><span class="n">u__</span><span class="err">$</span><span class="n">awaiter7</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.&lt;&gt;</span><span class="n">u__</span><span class="err">$</span><span class="n">awaiter7</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">TaskAwaiter</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.&lt;&gt;</span><span class="m">1</span><span class="n">__state</span> <span class="p">=</span> <span class="p">-</span><span class="m">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>
<span class="k">case</span> <span class="m">1</span><span class="p">:</span>
	<span class="k">goto</span> <span class="n">IL_102</span><span class="p">;</span>
<span class="k">default</span><span class="p">:</span>
	<span class="k">this</span><span class="p">.&lt;</span><span class="n">task</span><span class="p">&gt;</span><span class="m">5</span><span class="n">__2</span> <span class="p">=</span> <span class="k">this</span><span class="p">.&lt;</span><span class="n">webClient</span><span class="p">&gt;</span><span class="m">5</span><span class="n">__1</span><span class="p">.</span><span class="nf">DownloadFileTaskAsync</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">imageUrl</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">localPath</span><span class="p">);</span>
	<span class="k">this</span><span class="p">.&lt;</span><span class="n">hashCalculator</span><span class="p">&gt;</span><span class="m">5</span><span class="n">__3</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">SynchronousHashCalculator</span><span class="p">();</span>
	<span class="n">taskAwaiter</span> <span class="p">=</span> <span class="k">this</span><span class="p">.&lt;</span><span class="n">task</span><span class="p">&gt;</span><span class="m">5</span><span class="n">__2</span><span class="p">.</span><span class="nf">GetAwaiter</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(!</span><span class="n">taskAwaiter</span><span class="p">.</span><span class="n">IsCompleted</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">this</span><span class="p">.&lt;&gt;</span><span class="m">1</span><span class="n">__state</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.&lt;&gt;</span><span class="n">u__</span><span class="err">$</span><span class="n">awaiter7</span> <span class="p">=</span> <span class="n">taskAwaiter</span><span class="p">;</span>
		<span class="k">this</span><span class="p">.&lt;&gt;</span><span class="n">t__builder</span><span class="p">.</span><span class="n">AwaitUnsafeOnCompleted</span><span class="p">&lt;</span><span class="n">TaskAwaiter</span><span class="p">,</span> <span class="n">AsyncMethods</span><span class="p">.&lt;</span><span class="n">DownloadImageAsync</span><span class="p">&gt;</span><span class="n">d__0</span><span class="p">&gt;(</span><span class="k">ref</span> <span class="n">taskAwaiter</span><span class="p">,</span> <span class="k">ref</span> <span class="k">this</span><span class="p">);</span>
		<span class="n">flag</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">taskAwaiter</span><span class="p">.</span><span class="nf">GetResult</span><span class="p">();</span>
<span class="n">taskAwaiter</span> <span class="p">=</span> <span class="k">default</span><span class="p">(</span><span class="n">TaskAwaiter</span><span class="p">);</span>
</code></pre></div></div>

<p>If the task has not been completed it sets the state to 0 which then comes back to default so it goes back and forth until taskAwaiter.IsCompleted is true.</p>

<h3 id="07-new-c-60-features">07. New C# 6.0 Features</h3>
<p>C# 6.0 has just been released a few days ago. There aren’t many groundbreaking features as the team at Microsoft stated. Mostly the new features are shothand notations to make the code easier to read and write. I decided to have a look at the decompiled code of some of the new structs</p>

<h4 id="null-conditional-operators">Null-conditional operators</h4>
<p>This is a great remedy to ease the neverending null-checks. For example in the code below</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">people</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Person</span><span class="p">&gt;();</span>
<span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">people</span><span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">()?.</span><span class="n">FullName</span><span class="p">;</span>
</code></pre></div></div>

<p>If the list is empty name will be null. If we didn’t have this operator it would throw an exception therefore we would have to do the null checks on our own. The decompiled code for the above block is like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">fullName</span><span class="p">;</span>
    <span class="n">Program</span><span class="p">.</span><span class="n">Person</span> <span class="n">person</span> <span class="p">=</span> <span class="p">(</span><span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Program</span><span class="p">.</span><span class="n">Person</span><span class="p">&gt;()).</span><span class="n">FirstOrDefault</span><span class="p">&lt;</span><span class="n">Program</span><span class="p">.</span><span class="n">Person</span><span class="p">&gt;();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">person</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fullName</span> <span class="p">=</span> <span class="n">person</span><span class="p">.</span><span class="n">FullName</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">fullName</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As we can see, the generated code is graciously carrying out the null check for us!</p>

<h4 id="string-interpolation">String interpolation</h4>
<p>This is one of my favourites: Now we can simply place put the parameters directly inside a string instead of placeholders. Expanding on the example above, imagine the Person class is like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">LastName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">FullName</span> <span class="p">=&gt;</span> <span class="s">$"</span><span class="p">{</span><span class="n">FirstName</span><span class="p">}</span><span class="s"> </span><span class="p">{</span><span class="n">LastName</span><span class="p">}</span><span class="s">"</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The decompiled code looks familiar though:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">string</span> <span class="n">FullName</span>
<span class="p">{</span>
    <span class="k">get</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0} {1}"</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">FirstName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="n">LastName</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is exactly how I would do it if we didn’t have this new feature.</p>

<h4 id="auto-property-initializers">Auto-property initializers</h4>

<p>We can set the default value for a property on the declaration line now, like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">string</span> <span class="n">FirstName</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span> <span class="p">=</span> <span class="s">"Volkan"</span><span class="p">;</span>
</code></pre></div></div>

<p>And the IL generated for the code is like this:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-csharp6-auto-property-initializer.png" alt=""></p>

<p>Decompiled code varies. Just Decompile doesn’t just displays the exact same statement as above. ILSpy on the other hand is closer to the IL:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="nf">Person</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">this</span><span class="p">.&lt;</span><span class="n">FirstName</span><span class="p">&gt;</span><span class="n">k__BackingField</span> <span class="p">=</span> <span class="s">"Volkan"</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.&lt;</span><span class="n">BirthDate</span><span class="p">&gt;</span><span class="n">k__BackingField</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">1966</span><span class="p">,</span> <span class="m">6</span><span class="p">,</span> <span class="m">6</span><span class="p">);</span>
	<span class="k">base</span><span class="p">..</span><span class="nf">ctor</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So what it does is, in the constructor it sets the private backing field with this default value we assign.</p>

<h4 id="expression-bodied-members">Expression bodied members</h4>
<p>We can now provide the body of the function as an expression following the declaration like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">int</span> <span class="nf">GetAge</span><span class="p">()</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span> <span class="p">-</span> <span class="n">BirthDate</span><span class="p">).</span><span class="n">TotalDays</span> <span class="p">/</span> <span class="m">365</span><span class="p">);</span>
</code></pre></div></div>

<p>The decompiled code is not very fancy:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="kt">int</span> <span class="nf">GetAge</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">TimeSpan</span> <span class="n">now</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span> <span class="p">-</span> <span class="k">this</span><span class="p">.</span><span class="n">BirthDate</span><span class="p">;</span>
    <span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">now</span><span class="p">.</span><span class="n">TotalDays</span> <span class="p">/</span> <span class="m">365</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It simply puts the expression back in the body.</p>

<h4 id="index-initializers">Index initializers</h4>
<p>It’s a shorthand for index initialization such as</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">dict</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span>
<span class="p">{</span>
    <span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">"string1"</span><span class="p">,</span>
    <span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="s">"string2"</span><span class="p">,</span>
    <span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="s">"string3"</span> 
<span class="p">};</span>
</code></pre></div></div>

<p>And the decompiled code is no different than what it is now:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
<span class="n">dictionary</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="p">=</span> <span class="s">"string1"</span><span class="p">;</span>
<span class="n">dictionary</span><span class="p">[</span><span class="m">2</span><span class="p">]</span> <span class="p">=</span> <span class="s">"string2"</span><span class="p">;</span>
<span class="n">dictionary</span><span class="p">[</span><span class="m">3</span><span class="p">]</span> <span class="p">=</span> <span class="s">"string3"</span><span class="p">;</span>
</code></pre></div></div>

<p>As I mentioned there is nothing fancy about the new features in terms of the generated IL but some of them will help save a lot of time for sure.</p>

<h3 id="08-compiler-code-optimization">08. Compiler code optimization</h3>
<p>It is interesting to see how decompilers use optimization on their own. Before I went into this I thought they would just reverse engineer whatever is in the assembly but turns out that’s not the case.</p>

<p>First, let’s have a look at the C# compiler’s behaviour. In Visual Studio, Optimize code flag can be found under Project Properties -&gt; Debug menu</p>

<p><img src="/images/vpblogimg/2015/07/decompile-vs-optimize-code.png" alt=""></p>

<p>In order to test code optimization I created a dummy method like this:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">UnusedVariables</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">VeryImportantMethod</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">testClass</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">TestClass</span><span class="p">(</span><span class="s">"some value"</span><span class="p">);</span>
		<span class="n">TestClass</span> <span class="n">testClass2</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">x</span> <span class="p">=</span> <span class="s">"xyz"</span><span class="p">;</span>
        <span class="kt">var</span> <span class="n">n</span> <span class="p">=</span> <span class="m">123</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>First I compiled it by default values:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-not-optimized-compilation-output.png" alt=""></p>

<p>Then disassembled the output:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-ildasm-output-not-optimized.png" alt=""></p>

<p>I’m no expert in reading IL code but it’s obvious in the locals section there are 2 TestClass instances, a string and a integer.</p>

<p>When I compiled it with the optimization option (/o):</p>

<p><img src="/images/vpblogimg/2015/07/decompile-optimized-compilation-output.png" alt=""></p>

<p>I got the following when disassembled:</p>

<p><img src="/images/vpblogimg/2015/07/decompile-ildasm-output-optimized.png" alt=""></p>

<p>There’s no trace of the value types (string and the int). Also the TestClass instance with null value is gone. But the TestClass instance, which is created in the heap rather than the stack, is still there even though there is nothing referencing it. It’s interesting to see that difference.</p>

<p>When I decompiled both versions with ILSpy and JustDecompile unused local variables were removed all the time. Apparently they do their own optimization.</p>

<p><img src="/images/vpblogimg/2015/07/decompile-justdecompile-optimization.png" alt=""></p>

<h3 id="conclusion">Conclusion</h3>
<p>It was a fun exercise to investigate and see the actual generated code. It was helpful to understand better complex constructs like async/await and also helpful to see there’s nothing to fear about the new features of C# 6.0!</p>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="http://www.amazon.com/CLR-via-4th-Developer-Reference/dp/0735667454/" target="_blank" rel="noopener noreferrer">CLR via C#, 4th Edition</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/bb383973.aspx" target="_blank" rel="noopener noreferrer">MSDN: var keyword</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/yh598w02.aspx" target="_blank" rel="noopener noreferrer">MSDN: using statement</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/f7dy01k1(v=vs.110).aspx" target="_blank" rel="noopener noreferrer">ILDASM</a></li>
  <li><a href="http://www.codeproject.com/Articles/535635/Async-Await-and-the-Generated-StateMachine" target="_blank" rel="noopener noreferrer">CodeProject Article: Async Await and the Generated StateMachine</a></li>
  <li><a href="https://msdn.microsoft.com/en-us/library/hh191443.aspx" target="_blank" rel="noopener noreferrer">MSDN: Asynchronous Programming with Async and Await </a></li>
  <li><a href="http://tomasp.net/blog/async-compilation-internals.aspx/" target="_blank" rel="noopener noreferrer">Blog post: Async compilation internals</a></li>
  <li><a href="http://programmers.stackexchange.com/questions/183576/asyncawait-sync" target="_blank" rel="noopener noreferrer">Stackexchange question: async+await == sync?</a></li>
  <li><a href="http://www.mikesdotnetting.com/article/271/7-c-6-0-features-that-every-asp-net-developer-should-know-about" target="_blank" rel="noopener noreferrer">Blog post: 7 C# 6.0 Features That Every ASP.NET Developer Should Know About</a></li>
</ul>

		
		
	</div>


    </article>


</div>
<nav id="pagenavi">
    
        <a href="/page/25" class="prev">Prev</a>
    
    
        <a href="/page/27" class="next">Next</a>
    
    <div class="center"><a href="/archive">Blog Archives</a></div>
</nav>
</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2021 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
