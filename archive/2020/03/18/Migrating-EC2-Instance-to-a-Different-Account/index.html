<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Migrating an EC2 Instance to a Different AWS Account - Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/archive/2020/03/18/Migrating-EC2-Instance-to-a-Different-Account/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script data-ad-client="ca-pub-0414743900624675" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-35583486-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="Migrating an EC2 Instance to a Different AWS Account">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-0414743900624675" crossorigin="anonymous"></script>
<!-- AdUnit01 -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-0414743900624675" data-ad-slot="9604018233" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Migrating an EC2 Instance to a Different AWS Account</h1>
	<div class="meta">
	<span class="date">




<time datetime="2020-03-18T06:00:00+00:00" itemprop="datePublished">March 18, 2020</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/"></a></span> -->

<!-- aws -->




    <a href="/category/aws">aws</a>
    
</span>
	<span class="tags">ec2, migration</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
<p>Recently I needed to migrate an EC2 instance to a different AWS account. There’s no built-in functionality to handle this. The solution is creating an AMI from the instance and sharing it with the target account. I scripted my solution with Powershell and AWS Tools for Powershell as below.</p>

<h2 id="prerequisites">Prerequisites</h2>
<p>Since the operation involves a source account and a target account, first create 2 profiles with EC2 access. credentials files should look like this</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[source_profile]
aws_access_key_id = xxxxxxxxx
aws_secret_access_key = xxxxxxxxx

[target_profile]
aws_access_key_id = xxxxxxxxx
aws_secret_access_key = xxxxxxxxx
</code></pre></div></div>

<h2 id="step-00-configuration">Step 00: Configuration</h2>
<p>I put all the variables in a Powershell script file which I include in the following steps. To use the scripts you need to provide the values first. Hopefully the variable names are self-explanatory:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$sourceAccountAwsProfileName</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$sourceRegion</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$sourceAccountId</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$instanceId</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$amiName</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$amiDescription</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$targetAccountAwsProfileName</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$targetAccountId</span> <span class="o">=</span> <span class="s2">""</span>
<span class="nv">$targetRegion</span> <span class="o">=</span> <span class="s2">""</span>
</code></pre></div></div>

<h2 id="step-01-create-ami">Step 01: Create AMI</h2>
<p>First step to migrate EC2 instance is to create an AMi from the instance.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> .\<span class="s2">"00. configuration.ps1"</span>

<span class="c1"># Create AMI</span>
<span class="nv">$imageId</span> <span class="o">=</span> New-EC2Image -InstanceId <span class="nv">$instanceId</span> -Name <span class="nv">$amiName</span> -Description <span class="nv">$amiDescription</span> -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>

<span class="nb">Set-Variable</span> -Scope global -Name AMI_ID -Value <span class="nv">$imageId</span>
<span class="nb">Write-Host</span> <span class="s2">"AMI_ID: ["</span> <span class="nv">$AMI_ID</span> <span class="s2">"]"</span>
</code></pre></div></div>

<p>This operation takes a few minutes. The image has to become available before we can proceed to the next step.</p>

<h2 id="step-02-share-ami">Step 02: Share AMI</h2>
<p>Now the image is ready we have to share it with the target account. The script below shares the AMI and allows new volumes created from this AMI.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> .\<span class="s2">"00. configuration.ps1"</span>

<span class="nv">$imageId</span> <span class="o">=</span> <span class="nb">Get-Variable </span>AMI_ID -valueOnly
Edit-EC2ImageAttribute -ImageId <span class="nv">$imageId</span> -Attribute launchPermission -OperationType add -UserId <span class="nv">$targetAccountId</span> -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>

<span class="nv">$imageSnapshots</span> <span class="o">=</span> Get-EC2Snapshot -OwnerId <span class="nv">$sourceAccountId</span> -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>
                | <span class="nb">Where</span>-Object <span class="o">{</span><span class="nv">$_</span>.Description -like <span class="s2">"*</span><span class="nv">$imageId</span><span class="s2">*"</span> <span class="o">}</span>

<span class="k">foreach</span> <span class="o">(</span><span class="nv">$snapshot</span> <span class="k">in</span> <span class="nv">$imageSnapshots</span><span class="o">)</span> <span class="o">{</span>
    Edit-EC2SnapshotAttribute -SnapshotId <span class="nv">$snapshot</span>.SnapshotId -Attribute createVolumePermission -OperationType add -UserId <span class="nv">$targetAccountId</span> -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="step-03-copy-ami">Step 03: Copy AMI</h2>
<p>At this point, if you go to the target account you should be able to see the image when you choose “Private images” category. Make sure to choose the same region as the source account to be able to see the image.</p>

<p>We have access to this image but we want to have our own copy which we accomplish with the script below:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> .\<span class="s2">"00. configuration.ps1"</span>

<span class="nv">$imageId</span> <span class="o">=</span> <span class="nb">Get-Variable </span>AMI_ID -valueOnly
<span class="nb">Copy</span>-EC2Image -SourceImageId <span class="nv">$imageId</span> -SourceRegion <span class="nv">$sourceRegion</span> -Name <span class="nv">$amiName</span> -ProfileName <span class="nv">$targetAccountAwsProfileName</span> -Region <span class="nv">$targetRegion</span>
</code></pre></div></div>

<p>In my experience the whole copying process took about 5 minutes.</p>

<p>Now that we have our own copy of the AMI we can launch instances as we please. Job (almost) done!</p>

<h2 id="step-04-clean-up">Step 04: Clean Up</h2>

<p>Final step is to clean up after ourselves. Since this AMI was created to migrate to the new account only I assume we won’t need it anymore in the source account. The following script deregisters the AMI and deletes all the associated snapshots.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span> .\<span class="s2">"00. configuration.ps1"</span>

<span class="c1"># Create image script writes the AMI ID to a variable. If it doesn't exist get the image id from AWS Management Console</span>
<span class="nv">$imageId</span> <span class="o">=</span> <span class="nb">Get-Variable </span>AMI_ID -valueOnly

<span class="nb">Write-Host</span> <span class="s2">"Unregistering image: ["</span> <span class="nv">$imageId</span> <span class="s2">"]"</span>
Unregister-EC2Image -ImageId <span class="nv">$imageId</span> -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>

<span class="nv">$imageSnapshots</span> <span class="o">=</span> Get-EC2Snapshot -OwnerId <span class="nv">$sourceAccountId</span> -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>
                | <span class="nb">Where</span>-Object <span class="o">{</span><span class="nv">$_</span>.Description -like <span class="s2">"*</span><span class="nv">$imageId</span><span class="s2">*"</span> <span class="o">}</span>

<span class="k">foreach</span> <span class="o">(</span><span class="nv">$snapshot</span> <span class="k">in</span> <span class="nv">$imageSnapshots</span><span class="o">)</span> <span class="o">{</span>
    <span class="nb">Write-Host</span> <span class="s2">"Removing snapshot: ["</span> <span class="nv">$snapshot</span>.SnapshotId <span class="s2">"]"</span>
    Remove-EC2Snapshot -SnapshotId <span class="nv">$snapshot</span>.SnapshotId -Force -ProfileName <span class="nv">$sourceAccountAwsProfileName</span> -Region <span class="nv">$sourceRegion</span>
<span class="o">}</span>

<span class="c1"># Delete variable</span>
<span class="nb">Remove-Variable </span>AMI_ID -Scope global
</code></pre></div></div>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://github.com/volkanpaksoy/lab/tree/master/blog/migrate-ec2-instance-to-another-account" target="_blank" rel="noopener noreferrer">Source Code</a></li>
  <li><a href="https://aws.amazon.com/premiumsupport/knowledge-center/account-transfer-ec2-instance/" target="_blank" rel="noopener noreferrer">How do I transfer an Amazon EC2 instance to a different AWS account?</a></li>
  <li><a href="https://alestic.com/2014/02/ec2-create-image-reboot/" target="_blank" rel="noopener noreferrer">EC2 create-image Does Not Fully “Stop” The Instance</a></li>
</ul>
</div>

</article>

<div id="page-navigation"> 
        <div class="previous"> 
         
                <a href="/archive/2019/12/05/Using-Audio-in-Docker-Container/" title="Previous Post: 
Using Audio in Docker Container">« Using Audio in Docker Container</a>
         
        </div>

        <div class="next"> 
         
               <a href="/archive/2021/08/31/Using-Dymo-LabelWriter-450-with-a-Raspberry-Pi/" title="next Post: 
Using Dymo LabelWriter 450 with a Raspberry Pi">Using Dymo LabelWriter 450 with a Raspberry Pi » </a> 
         
        </div>
</div> 


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2021 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
