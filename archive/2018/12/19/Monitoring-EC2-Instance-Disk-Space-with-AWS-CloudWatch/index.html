<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Monitoring EC2 Instance Disk Space with AWS CloudWatch - Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/archive/2018/12/19/Monitoring-EC2-Instance-Disk-Space-with-AWS-CloudWatch/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3V7V2XX9Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y3V7V2XX9Q');
</script>

<!-- <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'G-Y3V7V2XX9Q']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script> -->



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="Monitoring EC2 Instance Disk Space with AWS CloudWatch">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
<!-- vp.com - default -->
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Monitoring EC2 Instance Disk Space with AWS CloudWatch</h1>
	<div class="meta">
	<span class="date">




<time datetime="2018-12-19T04:00:00+00:00" itemprop="datePublished">December 19, 2018</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/"></a></span> -->

<!-- aws, devops -->




    <a href="/category/aws">aws</a>
    , 

    <a href="/category/devops">devops</a>
    
</span>
	<span class="tags">cloudwatch, custom_metric</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
<p>I had an issue recently with an EC2 instance running out of disk space. Unfortunately free disk space is not a metric that comes out of the box with AWS CloudWatch. This post is about implementing a custom metric and getting notifications via AWs CloudWatch based on that metric.</p>

<h2 id="steps-to-monitor-disk-space-with-cloudwatch">Steps to monitor disk space with CloudWatch</h2>

<p><strong>Step 1: Download sample config file</strong></p>

<p>AWS provides a sample JSON file at this location: <a href="https://s3.amazonaws.com/ec2-downloads-windows/CloudWatchConfig/AWS.EC2.Windows.CloudWatch.json" target="_blank" rel="noopener noreferrer">https://s3.amazonaws.com/ec2-downloads-windows/CloudWatchConfig/AWS.EC2.Windows.CloudWatch.json</a></p>

<p>Download a copy of this file.</p>

<p><strong>Step 2: Set IsEnabled to true</strong></p>

<p>By default it comes disabled so set the value as shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"IsEnabled": true
</code></pre></div></div>

<p><strong>Step 3: Add the custom metric for disk usage</strong></p>

<p>Add the custom metric to monitor disk space:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "Id": "PerformanceCounterDisk",
    "FullName": "AWS.EC2.Windows.CloudWatch.PerformanceCounterComponent.PerformanceCounterInputComponent,AWS.EC2.Windows.CloudWatch",
    "Parameters": {
        "CategoryName": "LogicalDisk",
        "CounterName": "% Free Space",
        "InstanceName": "C:",
        "MetricName": "FreeDiskPercentage",
        "Unit": "Percent",
        "DimensionName": "InstanceId",
        "DimensionValue": "{instance_id}"
    }
}
</code></pre></div></div>

<p><strong>Step 4: Add the new metric to flows</strong></p>

<p>After defining the metric we need to add it to the flows so that it can be sent to CloudWatch. To achieve this update the flows section as shown below:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"Flows": {
    "Flows": 
    [
        "(ApplicationEventLog,SystemEventLog),CloudWatchLogs",
        "(PerformanceCounter,PerformanceCounterDisk),CloudWatch"
    ]
}
</code></pre></div></div>

<script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>

<p><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></p>

<p><strong>Step 5: Add IAM role to server</strong></p>

<p>It’s a good practice to manage permissions of EC2 instances via IAM roles assigned to the machine. To enable sending logs to CloudWatch add AmazonEC2RoleForSSM policy to the machine’s role</p>

<p><img src="/images/vpblogimg/2018/12/aws-cloudwatch-custom-metrics-01.png" alt=""></p>

<p>Without this role SSM agent service gets an access denied error.</p>

<p><strong>Step 6: Restart Amazon SSM Agent service</strong></p>

<p>Either by using Windows Services Manager or running the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Restart-Service AmazonSSMAgent
</code></pre></div></div>

<p>Once this is all done wait a few minutes and check CloudWatch metrics. Under All -&gt; Windows/Default you should be able to see new metric under InstanceId group (as that’s what we are using to group the logs). And when you click the metric you should be able to see a nice time-based graph of free disk space on the server:</p>

<p><img src="/images/vpblogimg/2018/12/aws-cloudwatch-custom-metrics-02.png" alt=""></p>

<h2 id="notes">Notes</h2>

<ul>
  <li>
    <p>It’s useful to know where SSM Agent’s logs are stored. They can be found in this path:</p>

    <p>%PROGRAMDATA%\Amazon\SSM\Logs\</p>
  </li>
  <li>
    <p>The service reports every 5 minutes. The PollInterval in the JSON file is in seconds and is different than service report interval.</p>
  </li>
</ul>

<h2 id="resources">Resources</h2>
<ul>
  <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/publishingMetrics.html" target="_blank" rel="noopener noreferrer">AWS Documentation: Publish Custom Metrics</a></li>
  <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/cwl-ug.pdf" target="_blank" rel="noopener noreferrer">Amazon CloudWatch Logs User Guide (PDF)</a></li>
  <li><a href="https://s3.amazonaws.com/ec2-downloads-windows/CloudWatchConfig/AWS.EC2.Windows.CloudWatch.json" target="_blank" rel="noopener noreferrer">CoudWatch Sample Config File</a></li>
  <li><a href="https://stackoverflow.com/questions/37441225/how-to-monitor-free-disk-space-at-aws-ec2-with-cloud-watch-in-windows" target="_blank" rel="noopener noreferrer">StackOverflow question: How to monitor free disk space at AWS EC2 with Cloud Watch in windows
</a></li>
  <li><a href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/QuickStartWindows2016.html" target="_blank" rel="noopener noreferrer">Quick Start: Enable Your Amazon EC2 Instances Running Windows Server 2016 to Send Logs to CloudWatch Logs Using the CloudWatch Logs Agent</a></li>
</ul>
</div>

</article>

<div id="page-navigation"> 
        <div class="previous"> 
         
                <a href="/archive/2018/09/04/AWS-Organisations/" title="Previous Post: 
Managing Accounts with AWS Organizations">« Managing Accounts with AWS Organizations</a>
         
        </div>

        <div class="next"> 
         
               <a href="/archive/2018/12/19/Aurora-Serverless/" title="next Post: 
AWS Aurora Serverless">AWS Aurora Serverless » </a> 
         
        </div>
</div> 


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2022 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
