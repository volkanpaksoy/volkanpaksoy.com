<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>Inside the Graph: Cypher - Playground for the mind</title>
	<meta name="author" content="Volkan Paksoy">

	
	<meta name="description" content="
		
	">
	

	<!-- http://t.co/dKP3o1e -->
	<meta name="HandheldFriendly" content="True">
	<meta name="MobileOptimized" content="320">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="https://feeds.feedburner.com/PlaygroundForTheMind" rel="alternate" title="Playground for the mind" type="application/atom+xml">
	
	<link rel="canonical" href="https://volkanpaksoy.com/archive/2015/03/03/inside-the-graph-cypher/">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,400italic,600,700,800' rel='stylesheet' type='text/css'>
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="/css/code.css" type="text/css">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script src="/js/slash.js" async></script>
	<script src="/js/GithubRepoWidget.min.js" async></script>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996"
  crossorigin="anonymous"></script>

  

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y3V7V2XX9Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y3V7V2XX9Q');
</script>

<!-- <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'G-Y3V7V2XX9Q']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script> -->



  <!-- Twitter cards -->
  <meta name="twitter:site"    content="@volkan_paksoy">
  <meta name="twitter:creator" content="@Volkan Paksoy">
  <meta name="twitter:title"   content="Inside the Graph: Cypher">

  
  <meta name="twitter:description" content="">
  

  
  <meta name="twitter:card"  content="summary">
  <meta name="twitter:image" content=""> -->
  
  <!-- end of Twitter cards -->


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
				<header id="header" class="inner"><div class="profilepic">
	
	<a href="/">
		<img src="https://s.gravatar.com/avatar/760bf518408c38ebb0f0e5adb8089e30?s=80?s=160" alt="Profile Picture" style="width: 160px;">
	</a>	
	
</div>
<hgroup>
  <h1 class="site-title" style="font-size: 2.4em;">
		<a style="color: rgba(255, 165, 0, 0.8);" href="/">Playground for the mind</a>
	</h1>
  
    <h2>It's all about the journey, not the destination</h2>
  
</hgroup>

<nav id="sub-nav">
	<div class="social">
		
			<a class="rss" href="https://feeds.feedburner.com/PlaygroundForTheMind" title="RSS" target="_blank" rel="noopener noreferrer">RSS</a>
		
		
			<a class="github" href="https://github.com/volkanpaksoy" title="GitHub" target="_blank" rel="noopener noreferrer">GitHub</a>
		
		
			<a class="stackoverflow" href="https://stackoverflow.com/users/3093396/volkan-paksoy" title="StackOverflow" target="_blank" rel="noopener noreferrer">StackOverflow</a>
		
	</div>
</nav>

<nav id="main-nav">
<ul class="main-navigation">
  <li><a href="/archive">posts</a></li>
  <li><a href="/category">categories</a></li>
</ul>
<br>
<br>

<!-- <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="volkanpaksoy" data-color="#005050" data-emoji=""  data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#ffffff" data-font-color="#ffffff" data-coffee-color="#FFDD00" ></script> -->

<a href="https://www.buymeacoffee.com/volkanpaksoy" target="_blank" rel="noopener noreferrer"><img src="https://cdn.buymeacoffee.com/buttons/v2/default-green.png" alt="Buy Me A Coffee" style="height: 60px !important;width: 217px !important;"></a>

<div id="ezoic-pub-ad-placeholder-102">
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <!-- vp.com - default -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5266062674794996" data-ad-slot="6750480330" data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

</nav></header>				
			</div>
		</div>
		<div class="mid-col">
			<div class="mid-col-container">
				<div id="content" class="inner">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
	<h1 class="title" itemprop="name">Inside the Graph: Cypher</h1>
	<div class="meta">
	<span class="date">




<time datetime="2015-03-03T16:00:00+00:00" itemprop="datePublished">March  3, 2015</time></span>
	<span class="categories"><!-- <span class="category-link"><a href="/category/"></a></span> -->

<!-- dev -->




    <a href="/category/dev">dev</a>
    
</span>
	<span class="tags">neo4j, graph_databases, cypher</span>
	
</div>
	<div class="entry-content" itemprop="articleBody">
<p>Visual tools are nice and all but they are not as fun as playing with a query language. When you write your own queries the possibilities are endless! In this post I’ll cover the basics of Cypher query language. Cypher is a declarative, SQL-like, pattern-matching query language for Neo4J graph databases.</p>

<h3 id="basic-crud-operations">Basic CRUD Operations</h3>

<h4 id="match">MATCH</h4>

<p>Match clause allows to define patterns to search the database. It is similar to <em>SELECT</em> in the RDBMS-world.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (n) RETURN n
</code></pre></div></div>

<p>The query above returns all nodes in the database. In this example n is a temporary variable to store the result. The results can be filtered based on labels such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (n:Person) RETURN n
</code></pre></div></div>

<p>Property-based filters can be used in both MATCH and WHERE clauses. For example the two queries below return the same results:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (n:Movie {title: "Ninja Assassin"})
RETURN n
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (n:Movie)
WHERE n.title = "Ninja Assassin"
RETURN n
</code></pre></div></div>

<p>Instead of returning the entire node we can just select some specific properties. If a node doesn’t have the property it simply returns null.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (a:Person)
RETURN a.name, a.born
</code></pre></div></div>

<p><img src="/images/vpblogimg/2015/03/cypher-query-01.png" alt="Query returning all actors' names and years they were born in"></p>

<p>Results can be filtered by relationships as well. For example the query below returns the movies Tom Hanks acted in</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (p {name:"Tom Hanks"})-[:ACTED_IN]-&gt;(m)
RETURN p, m
</code></pre></div></div>

<div id="ezoic-pub-ad-placeholder-101">
  <script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5266062674794996" crossorigin="anonymous"></script>
  <ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-5266062674794996" data-ad-slot="9650311114"></ins>
  <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
  </script>
</div>

<p><img src="/images/vpblogimg/2015/03/cypher-query-00.png" alt="Query results for movies Tom Hanks acted in"></p>

<p>Sometimes we might need to learn the relationship from the query. In that case we can use <em>TYPE</em> function to get the name of the relationship:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (a)-[r1]-&gt;(m)&lt;-[r2]-(a)
RETURN a.name, m.title, type(r1), type(r2)
</code></pre></div></div>

<p><img src="/images/vpblogimg/2015/03/cypher-query-02.png" alt="Actors having multiple relationships with the same movie"></p>

<p>Relationship type and direction can be omitted in the queries. The following query returns the names of the movies that have “some sort of relationship” with Tom Hanks:</p>

<p><img src="/images/vpblogimg/2015/03/cypher-query-03.png" alt="Movie with Tom Hanks"></p>

<p><em>OPTIONAL MATCH</em>: OPTIONAL keyword fills in the missing parts in the results with nulls. For example the query below returns 1 row as null because there is no outgoing relationship from the movie <em>The Matrix</em>. If we didn’t use OPTIONAL we would have an empty resultset.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (a:Movie {title: 'The Matrix'})
OPTIONAL MATCH (a)-[]-&gt;(d)
RETURN d  
</code></pre></div></div>

<h4 id="create">CREATE</h4>

<p>To add new data <em>CREATE</em> query is used. In the simplest form the following query creates (a rather useless) node:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE ()
</code></pre></div></div>

<p>Labels and properties can be set while creating new nodes such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE (a:Actor {name: "Leonard Nimoy", born: 1931, died: 2015})
</code></pre></div></div>

<p>Relationships are created with <em>CREATE</em> as well. For example the following query creates 2 nodes with Person label and creates a <em>MARRIED_TO</em> relationship between them:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE (NedStark:Person {firstname: "Eddard", lastname: "Stark", alias: "Ned", gender: "male"}),
	   (CatelynStark:Person {firstname: "Catelyn", lastname: "Stark", maidenName: "Tully", gender: "female"})
CREATE (NedStark)-[:MARRIED_TO]-&gt;(CatelynStark)
</code></pre></div></div>

<p>Relationships can have properties too:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE
	(WaymarRoyce)-[:MEMBER_OF {order:"Ranger"}]-&gt;(NightsWatch)
</code></pre></div></div>

<p>Properties can be added or updated by using SET keyword such as:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (p:Person {firstname: "Eddard"})
SET p.title = "Lord of Winterfell"
RETURN p
</code></pre></div></div>

<p>The above query adds a “title” property to the nodes with label Person and with firstname “Eddard”.</p>

<p>An existing property can be deleted by REMOVE keyword</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (p:Person {firstname: "Eddard"})
REMOVE p.aliasList
</code></pre></div></div>

<h4 id="merge">MERGE</h4>

<p>Merge can be used to create new nodes/relationships or update them if they already exist. In the case of update, all the existing properties must match. For example the following query adds a new property to the node named <em>House Stark of Winterfell</em></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE (houseStark:House {name: "House Stark of Winterfell", words: "Winter is coming"})

MERGE (houseStark {name: "House Stark of Winterfell", words: "Winter is coming"})
SET houseStark.founded = "Age of Heroes"
</code></pre></div></div>

<p>The following one, on the other hand creates a new node with the same name (because the <em>words</em> properties don’t match):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MERGE (houseStark:House {name: "House Stark of Winterfell", words: "Winter is coming!!!"})
SET houseStark.founded = "Age of Heroes"
RETURN houseStark
</code></pre></div></div>

<p>I find helpful when you have a long Cyper query and you might run it multiple times. If you just use CREATE every time you run the query you will end up with new nodes. If you use MERGE it will not give any errors and will not create new nodes.</p>

<p>Another way to prevent this is unique constraints. For example the following query will enforce uniqueness on <em>_id</em> property for nodes labelled as <em>Book</em>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE CONSTRAINT ON (book:Book) ASSERT book._id IS UNIQUE
</code></pre></div></div>

<p>Now we can run this query and create the books:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CREATE 
	(AGameOfThrones:Book {_id: "7abe0a1c-b9bd-4f00-b094-a82dfb32b053", title: "A Game of Thrones", orderInSeries: 1, released:"August 1996"}),
 	(AClashOfKings:Book {_id: "051dae64-dfdb-4134-bc43-f6d2b4b57d37", title: "A Clash of Kings", orderInSeries: 2, released:"November 1998"}),
 	(AStormOfSwords:Book {_id: "e9baa042-2fc8-49a6-adcc-6dd455f0ba12", title: "A Storm of Swords", orderInSeries: 3, released:"August 2000"}),
 	(AFeastOfCrows:Book {_id: "edffaa47-0110-455a-9390-ad8becf5c549", title: "A Feast for Crows", orderInSeries: 4, released:"October 2005"}),
 	(ADanceWithDragons:Book {_id: "5a21b80e-f4c4-4c15-bfa9-1a3d7a7992e3", title: "A Dance with Dragons", orderInSeries: 5, released:"July 2011"}),
 	(TheWindsOfWinter:Book {_id: "77144f63-46fa-49ef-8acf-350cdc20bf07", title: "The Winds of Winter", orderInSeries: 6 })
</code></pre></div></div>

<p>If we try to run it again we get the following error:</p>

<p><img src="/images/vpblogimg/2015/03/cypher-query-04.png" alt="Cypher constraint error"></p>

<p>Unique constraint enforces the existing data to be unique as well. So if we run the book creation query twice, before the constraint, then try to create the constraint we get an error:</p>

<p><img src="/images/vpblogimg/2015/03/cypher-query-05.png" alt=""></p>

<p>To delete the constraint we use DROP keyword such as</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DROP CONSTRAINT ON (book:Book) ASSERT book._id IS UNIQUE
</code></pre></div></div>

<h4 id="delete">DELETE</h4>

<p>To delete nodes first we find them by MATCH. Instead of RETURN in the above examples we use DELETE to remove them.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (b:Book {_id: "7abe0a1c-b9bd-4f00-b094-a82dfb32b053"})
DELETE b
</code></pre></div></div>

<p>The above query would only work if the node doesn’t have any relationships. To delete a node as well as its relationships we can use the following:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (b {_id: "7abe0a1c-b9bd-4f00-b094-a82dfb32b053"})-[r]-()
DELETE b, r
</code></pre></div></div>

<p>We can generalize the above query to clean the entire database:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (n)
OPTIONAL MATCH (n)-[r]-() 
DELETE n, r
</code></pre></div></div>

<p>I find this quite useful during test and development phase as I need to start over quite often.</p>

<h3 id="useful-keywords">Useful keywords</h3>

<ul>
  <li><strong>ORDER BY</strong></li>
</ul>

<p>It is almost mandatory in all SQL-variants. Eventually you have to sort the data. For example the following returns all actors order by their names in alphabetical order:</p>

<p><img src="/images/vpblogimg/2015/03/cypher-query-07.png" alt=""></p>

<ul>
  <li><strong>LIMIT</strong></li>
</ul>

<p>Sometimes your query may return a lot of values that you’re not interested in. For example you may want to get top n results. In this case you can restrict the number of rows returned by <em>LIMIT</em> keyword such as:</p>

<p><img src="/images/vpblogimg/2015/03/cypher-query-09.png" alt=""></p>

<p>The above query returns the top 3 actors who have the most <em>ACTED_IN</em> relationships with movies in descending order.</p>

<ul>
  <li><strong>UNION</strong></li>
</ul>

<p>Another similar keyword from RDBMS is <em>UNION</em>. Similar to standard SQL, the returned columns must have the same number and names. For example the following will fail:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (p:Person)
RETURN p.name
UNION
MATCH (m:Movie)
RETURN m.title
</code></pre></div></div>

<p><img src="/images/vpblogimg/2015/03/cypher-query-08.png" alt=""></p>

<p>But with using an alias it can be fixed like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>MATCH (p:Person)
RETURN p.name AS name
UNION
MATCH (m:Movie)
RETURN m.title AS name
</code></pre></div></div>

<h3 id="measuring-query-performance">Measuring Query Performance</h3>

<p>PROFILE keyword is very helpful as it lets you see the query plan and optimize it. It is very simple to use: You just put it before the MATCH clause such as</p>

<p><img src="/images/vpblogimg/2015/03/cypher-query-06.png" alt=""></p>

<p>This is obviously a very simplistic example but I strongly recommend the <a href="http://graphaware.com/neo4j/2015/01/16/neo4j-graph-model-design-labels-versus-indexed-properties.html" target="_blank" rel="noopener noreferrer">GrapAware article on Labels vs Indexed Properties</a>. PROFILE is heavily used to identify which option performs better in a given scenario. Also a great read to learn more about modelling Neo4J database.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Cypher is quite powerful and it can be very expressive in the right hands. It is quite comprehensive to cover in a blog post. I just wanted this post to contain various samples for the basic queries. I hope it can be of some help for someone new to Cypher in conjunction with the references I listed below.</p>

<h2 id="resources">Resources</h2>

<ul>
  <li><a href="http://www.amazon.co.uk/Learning-Cypher-Onofrio-Panzarino/dp/1783287756/" target="_blank" rel="noopener noreferrer">Book: Learning Cypher</a></li>
  <li><a href="http://neo4j.com/developer/cypher-query-language/" target="_blank" rel="noopener noreferrer">Neo4J Cypher Tutorial</a></li>
  <li><a href="http://neo4j.com/docs/stable/cypher-query-lang.html" target="_blank" rel="noopener noreferrer">Neo4J: Cypher Reference</a></li>
  <li><a href="http://assets.neo4j.org/download/Neo4j_CheatSheet_v3.pdf" target="_blank" rel="noopener noreferrer">Neo4J Cyper Cheat Sheet</a></li>
  <li><a href="http://graphaware.com/neo4j/2015/01/16/neo4j-graph-model-design-labels-versus-indexed-properties.html" target="_blank" rel="noopener noreferrer">Article: Modelling Data in Neo4j: Labels vs. Indexed Properties</a></li>
</ul>
</div>

</article>

<div id="page-navigation"> 
        <div class="previous"> 
         
                <a href="/archive/2015/02/27/new-aws-features-and-improvements/" title="Previous Post: 
New AWS features and improvements">« New AWS features and improvements</a>
         
        </div>

        <div class="next"> 
         
               <a href="/archive/2015/03/07/portable-online-library-with-calibre-and-raspberry-pi/" title="next Post: 
Portable Online Library with Calibre and Raspberry Pi">Portable Online Library with Calibre and Raspberry Pi » </a> 
         
        </div>
</div> 


</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright © 2022 - Volkan Paksoy Blog content licensed under the Creative Commons <a href="http://creativecommons.org/licenses/by/2.5/" target="_blank" rel="noopener noreferrer">CC BY 2.5</a> | Site design based on the <a href="https://github.com/shashankmehta/greyshade" target="_blank" rel="noopener noreferrer">Greyshade theme</a> under the <a href="http://sm.mit-license.org/" target="_blank" rel="noopener noreferrer">MIT license</a>
</p>
</footer>
		</div>
	</div>
</body>
</html>
